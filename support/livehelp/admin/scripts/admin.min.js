function Storage(){this.store=$.initNamespaceStorage("LiveHelp").localStorage,this.get=function(a){return this.store.get(a)},this.set=function(a,b){return this.store.set(a,b)},this.isSet=function(a){return this.store.isSet(a)},window.setTimeout(function(){$(document).trigger("LiveHelp.LocalSettingsLoaded")},500)}function initVisitorsGrid(){if(void 0===visitorsGrid&&$(".visitors-grid").length){var a=new Slick.Data.GroupItemMetadataProvider;if(visitorsDataView=new Slick.Data.DataView({groupItemMetadataProvider:a}),void 0!==visitorsGrid)visitorsColumns=visitorsGrid.getColumns();else{visitorsColumns=opts.visitorColumns;var b=storage.get("visitorsColumns");$.each(b,function(a,b){$.each(visitorsColumns,function(a,c){return b.id===c.id?(c.width=b.width,!1):void 0})})}visitorsGrid=new Slick.Grid(".visitors-grid",visitorsDataView,visitorsColumns,visitorsGridOptions),visitorsGrid.registerPlugin(a),visitorsGrid.setSelectionModel(new Slick.RowSelectionModel),visitorsGrid.onColumnsResized.subscribe(function(){var a=[];$.each(visitorsGrid.getColumns(),function(b,c){a.push({id:c.id,width:c.width})}),storage.set("visitorsColumns",a)}),visitorsGrid.onClick.subscribe(function(a,b){var c=visitorsDataView.getItem(b.row);void 0!==c&&openVisitor(c)}),visitorsGrid.onSort.subscribe(function(a,b){var c=b.sortCols;visitorsDataView.sort(function(a,b){for(var d=0,e=c.length;e>d;d++){var f=c[d].sortCol.field,g=c[d].sortAsc?1:-1,h=a[f],i=b[f],j=(h==i?0:h>i?1:-1)*g;if(0!==j)return j}return 0}),visitorsGrid.invalidate(),visitorsGrid.render()}),visitorsDataView.onRowCountChanged.subscribe(function(a,b){if(visitorsGrid.updateRowCount(),visitorsGrid.render(),selectedVisitor)for(var c=parseInt(selectedVisitor.ID,10),d=0;d<b.current;d++)id=parseInt(visitorsDataView.mapRowsToIds([d])[0],10),c===id&&visitorsGrid.setSelectedRows([d])}),visitorsDataView.onRowsChanged.subscribe(function(a,b){visitorsGrid.invalidateRows(b.rows),visitorsGrid.render()}),visitorsDataView.groupBy(function(a){var b="Browsing";return a.Active<0?b="Chat Ended":a.Session>0&&(b="Chatting"),b},function(a){var b=" visitor";return a.count>1&&(b=" visitors"),a.value+" - "+a.count+b},function(a,b){return a.value-b.value})}}function apiRequest(a){var b=void 0!==a.data?a.data:{},c={Accept:"application/json"},d=storage.get("session");d.length>0&&$.extend(b,{Session:d}),session!==!1&&session.length>0&&apiAuthVersion>4&&$.extend(c,{Authorization:'Token signature="'+session+'", version="5"'}),5>apiAuthVersion&&($.extend(b,{Version:"4.0",Format:"json"}),a.url!==apiEndpoint.login&&session!==!1&&session.length>0&&$.extend(b,{Session:session})),$.ajax({url:address.length>0?address+apiPath+a.url:directoryPath+apiPath+a.url,data:b,type:"POST",headers:c,dataType:"json",success:a.success,error:a.error})}function updateVisitorsGrid(a,b,c,d){if(visitorsTimeout!==!1&&(window.clearTimeout(visitorsTimeout),visitorsTimeout=!1),session.length>0){void 0===a&&(a=""),void 0===b&&(b=""),(void 0===c||0===c.length)&&(c=25);var e={Action:a,Request:b,Record:0,Total:c};initVisitorsGrid(),apiRequest({url:apiEndpoint.visitors,data:e,success:function(a){null!==a.Visitors&&void 0!==a.Visitors&&void 0!==a.Visitors.Visitor?($(document).trigger("LiveHelp.VisitorsCompleted",{newVisitors:a.Visitors.Visitor,previousVisitors:visitors}),visitors=a.Visitors.Visitor,visitorRefreshDataView(visitors,a.Visitors.TotalVisitors),d&&d(visitors)):visitorRefreshDataView(null,0),visitorsTimer===!0&&websockets===!1&&(visitorsTimeout=window.setTimeout(updateVisitorsGrid,15e3))},error:function(a,b,c){visitorsTimer===!0&&websockets===!1&&(visitorsTimeout=window.setTimeout(updateVisitorsGrid,15e3))}})}else visitorsTimer===!0&&websockets===!1&&(visitorsTimeout=window.setTimeout(updateVisitorsGrid,15e3))}function visitorRefreshDataView(a,b,c){var d=$("#visitor-details .details"),e=d.data("visitor"),f=0;if(visitorsTotal=b,visitorsTimestamp===!1&&(visitorsTimestamp=Math.round((new Date).getTime()/1e3)),null!==a&&void 0!==a&&$(".visitors-grid").length){if(void 0!==e&&d.is(":visible")&&(f=parseInt(e.ID,10),$.each(a,function(a,b){if(parseInt(b.ID,10)===f){d.find("#chatstatus").text(b.ChatStatus),d.find("#currentpage a").text(b.CurrentPage).attr("href",b.CurrentPage),d.find("#pagehistory").text(b.PagePath);var c=d.find(".btn.initiate");return b.Active.length>0?c.addClass("disabled"):c.removeClass("disabled"),!1}})),void 0!==visitorsTotal&&updateTotal($("#visitortotal"),visitorsTotal),$.each(a,function(a,b){var c=Math.round((new Date).getTime()/1e3)-visitorsTimestamp;b.TimeOnPage=parseInt(b.TimeOnPage,10)+c,b.TimeOnSite=parseInt(b.TimeOnSite,10)+c}),visitorsTimestamp=Math.round((new Date).getTime()/1e3),visitorOpen>0){var g=_.find(a,function(a){return parseInt(a.ID,10)===visitorOpen});void 0===g&&closeVisitor()}visitorsDataView.beginUpdate(),visitorsDataView.setItems(a,"ID");for(var h=0;h<visitorsDataView.getGroups().length;h++)visitorsDataView.expandGroup(visitorsDataView.getGroups()[h].value);for(var h=0;h<visitorsDataView.getItems().length;h++){var i=visitorsDataView.getItems()[h];visitorsDataView.updateItem(i.ID,i)}visitorsDataView.endUpdate(),visitorsDataView.syncGridSelection(visitorsGrid,!0),"none"==$(".worldmap").css("display")&&(a.length>0?($(".visitors-empty").hide(),$(".visitors-grid, .visitors-menu").show()):($(".visitors-grid").hide(),$(".visitors-empty, .visitors-menu").show(),updateTotal($("#visitortotal"),0))),updateLocations()}else"none"==$(".worldmap").css("display")&&($(".visitors-grid").hide(),$(".visitors-empty, .visitors-menu").show(),updateTotal($("#visitortotal"),0));void 0!==c&&c()}function updateLocations(){var a,b=[];if(void 0!==visitors){a=visitors.filter(function(a){return null!==a.Longitude&&null!==a.Latitude&&void 0!==a.Longitude&&void 0!==a.Latitude&&a.Longitude.length>0&&a.Latitude.length>0?(b.push(projection([a.Longitude,a.Latitude])),!0):!1});var c=15,d=locations.selectAll("g.node").data(a).attr("id",function(a,b){return parseInt(a.ID,10)}).on("click",function(a){void 0!==a&&openVisitor(a)});locations.selectAll("circle.dot").data(a).attr("class","dot").attr("cx",function(a,c){return b[c][0]}).attr("cy",function(a,c){return b[c][1]}).attr("r",function(a,b){return Math.sqrt(c)}).attr("fill","rgba(0,187,204,0.5)"),locations.selectAll("circle.animate").data(a).attr("class","animate").attr("cx",function(a,c){return b[c][0]}).attr("cy",function(a,c){return b[c][1]}).attr("r",function(a,b){return Math.sqrt(c)}).attr("fill","rgba(0,187,204,1.0)").attr("opacity",1);var e=d.enter().append("svg:g");e.data(a).attr("id",function(a,b){return parseInt(a.ID,10)}).attr("class","node").on("click",function(a){void 0!==a&&openVisitor(a)}),e.append("svg:circle").attr("class","dot").attr("cx",function(a,c){return b[c][0]}).attr("cy",function(a,c){return b[c][1]}).attr("r",function(a,b){return Math.sqrt(c)}).attr("fill","rgba(0,187,204,0.5)"),e.append("svg:circle").attr("class","animate").attr("cx",function(a,c){return b[c][0]}).attr("cy",function(a,c){return b[c][1]}).attr("r",function(a,b){return Math.sqrt(c)}).attr("fill","rgba(0,187,204,1.0)").attr("opacity",1),d.exit().remove()}}function drawWorldMap(){var a=$(".worldmap");a.empty(),projection=d3.geo.equirectangular().scale(a.width()).translate([a.width()/2,a.height()/2]);var b=d3.geo.path().projection(projection),c=d3.select(".worldmap").append("svg:svg"),d=c.append("svg:g").attr("id","countries");locations=c.append("svg:g").attr("id","locations"),d3.json("scripts/world.json",function(a){if(null!==a){d.selectAll("path").data(a.features).enter().append("svg:path").attr("d",b).attr("fill","rgba(227,227,227,1)").attr("stroke","rgba(177,175,181,1)").attr("stroke-width",1)}})}function initWorldMap(){drawWorldMap();var a=125;setInterval(function(){"block"==$(".worldmap").css("display")&&locations.selectAll("circle.animate").attr("r",function(a,b){return Math.sqrt(15)}).attr("opacity",1).transition().duration(1e3).delay(function(a,b){return 10*b}).attr("opacity",0).attr("r",function(b,c){return Math.sqrt(a)}).each("end",function(){d3.select(this).attr("opacity",1).attr("r",0)})},2e3)}function openVisitor(a){var b=parseInt(a.ID,10);if(visitorOpen!==b){var c=$("#visitor-details"),d=c.find(".details").data("visitor"),e=void 0!==d&&d!==!1?parseInt(d.ID,10):-1;if(void 0===a.title&&e!==parseInt(a.ID,10)){visitorOpen=b,c.find(".details").data("visitor",a),c.find("#hostname").text(convertHostname(a)),c.find("#useragent").text(a.UserAgent);var f=convertBrowserIcon(a.UserAgent,!1).image;0===c.find("#useragent-image").length?$('<img id="useragent-image" src="'+f+'"/>').prependTo(c.find(".useragent.value")):c.find("#useragent-image").attr("src",f),c.find("#resolution").text(a.Resolution),c.find("#country-image").removeAttr("class").addClass(convertCountryIcon(a.Country)),c.find("#country").text(convertCountry(a)),"Direct Visit / Bookmark"!=a.Referrer?(c.find("#referrer .direct").hide(),c.find("#referrer a").text(convertReferrer(a.Referrer)).attr("href",a.Referrer).show()):(c.find("#referrer a").hide(),c.find("#referrer .direct").show()),c.find("#currentpage a").text(a.CurrentPage).attr("href",a.CurrentPage),c.find("#chatstatus").text(a.ChatStatus),c.find("#pagehistory").text(a.PagePath);var g=c.find(".btn.initiate");a.Active.length>0?g.addClass("disabled"):g.removeClass("disabled"),(0===c.width()||"none"===c.css("display"))&&(c.show(),c.animate({width:"40%",opacity:1},250))}}}function closeVisitor(){{var a=$("#visitor-details");a.width()}a.find(".details").data("visitor",!1),visitorOpen=-1,a.animate({width:0,opacity:0},250,function(){a.hide(),selectedVisitor=!1,visitorsGrid.getSelectedRows()>0&&visitorsGrid.setSelectedRows([])})}function sendInitiateChat(){var a=$(".initiate.dialog");a.find(".progressring").show(),a.find(".title").text("Sending Initiate Chat"),a.find(".description").text("One moment while your initiate chat request is sent."),a.show().animate({bottom:0},250,"easeInOutBack");var b=$("#visitor-details .details"),c=b.data("visitor"),d=parseInt(c.ID,10);updateVisitorsGrid("Initiate",d,25,function(b){a.animate({bottom:-90},250,"easeInOutBack")})}function checkBlocked(a){var b=!1,c=$(".chat-stack .closing-chat.dialog");$.each(blockedchats,function(c,d){return d.id===a?void(b=!0):void 0}),b?(c.find(".progressring img").attr("src","images/Block.png"),c.find(".title").text("Chat Session Blocked"),c.find(".description").text("The chat session is blocked and inactive."),c.find(".unblock").show(),c.show().animate({bottom:"1px"},250)):c.animate({bottom:"-145px"},250,function(){c.find(".unblock").hide(),c.find(".progressring img").attr("src","images/ProgressRing.gif"),c.hide()})}function processTagsMenu(a,b){var c=b.split(" "),d="",e=!1;return $.each(c,function(a,b){b=b.replace(/[;?.\-,!]/gi,""),$.inArray(b.toLowerCase(),tags)>-1&&(e=!0)}),e&&(d='<div class="responses-menu" data-message="'+a+'"><div class="close"></div><div class="responses text heading">Text</div><div class="responses-text"></div><div class="responses hyperlink heading">Hyperlink</div><div class="responses-hyperlink"></div><div class="responses image heading">Image</div><div class="responses-image"></div><div class="responses push heading">PUSH</div><div class="responses-push"></div><div class="responses javascript heading">JavaScript</div><div class="responses-javascript"></div></div>'),d}function processTags(a,b){var c=b.split(" "),d="",e=[];return d=b,$.each(c,function(b,c){c=c.replace(/[;?.\-,!]/gi,""),$.inArray(c.toLowerCase(),tags)>-1&&-1===$.inArray(c.toLowerCase(),e)&&(d=d.replace(c,'<span class="tag" data-message="'+a+'"><span class="icon"></span><span class="text">'+c+"</span></span>"),e.push(c.toLowerCase()))}),d}function scrollToBottom(a,b,c,d){var e=!1;if(e=$(void 0!==d&&d!==!1?".chat-stack .channel."+d:".chat-stack .chat[data-id="+a+"][data-operator="+b+"]"),0!=e&&e.length>0){var f=e.find(".scroll"),g=f.find("div.end"),h=e.data("initalised"),i=f.length>0?f[0].scrollTop+f.height():0,j=e.find(".messages .message.last:parent"),k=0,l=e.find(".messages .flex.typing:parent:visible");l.length>0&&(j=l),f.length>0&&(k=void 0!==h&&j.length>0?f[0].scrollTop+j.position().top:f[0].scrollTop),j.length>0&&(c=i>=k?!0:c),(autoScroll||void 0===h||void 0!==c)&&(f.scrollTo(g),e.data("initalised",!0))}}function addChat(a,b,c){var d=!1,e=!1;$.each(activechats,function(b,c){return c.id===a?void(d=!0):void 0}),$.each(blockedchats,function(b,c){return c.id===a?void(e=!0):void 0}),d||e||c||(b=b?1:0,activechats.push({id:a,typing:0,type:b,message:0,date:new Date}))}function updateTypingStatus(a){var b,c=$(".chat-stack .chat.focussed"),d=c.data("id"),e=c.data("operator"),f=_.find(activechats,function(a){return a.id===d&&a.type==e});if($(document).trigger("LiveHelp.UpdateTyping",{id:d,operator:e,typing:a}),void 0!==f){if(a)switch(f.typing){case 0:b=2;break;case 1:b=3;break;case 2:b=2;break;case 3:b=3}else switch(f.typing){case 0:b=0;break;case 1:b=1;break;case 2:b=0;break;case 3:b=1}return f.typing=b,!1}}function escapeHtml(a){var b="",c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return"string"==typeof a&&(b=a.replace(/[&<>"']/g,function(a){return c[a]})),b}function updateTyping(a,b){var c=-1;$.each($(".chat-stack .chat"),function(a,b){return 0===$(this).position().left?(c=parseInt($(this).data("id"),10),!1):void 0})}function messageHTML(a,b,c,d,e,f,g,h,i,j,k,l){var m=m=$(".chat-stack .chat[data-id="+i+'][data-operator="'+j+'"]'),n="",o=[],p=window.devicePixelRatio>1?192:96,q={id:a,timestamp:d.unix(),time:d!==!1?d.local().format("h:mm A"):!1},r=server.length>0?protocol+server+defaultUserImage:encodeURIComponent(window.location.protocol+"//"+window.location.host+path.replace(path.substring(path.indexOf(directoryPath+"admin/")),directoryPath+"images/UserSmall.png"));b>0?q.content=$("<div>").text(c).html():q.content=escapeHtml(c),q.username=escapeHtml(f),h=escapeHtml(h);var s=/^(http|https):\/\/twitter.com\/([^\/"\s]*)\/status\/([^\/"\s]*)\/*$/g,t=s.exec(q.content);if(3===b){var u=/(https?|ftp|file):\/\/[\-A-Z0-9+&@#\/%?=~_|!:,.;]*[A-Z0-9+&@#\/%=~_|](\.jpg|.jpeg|\.gif|\.png)/im,v=u.exec(q.content);null!==v&&(q.content='<img src="'+v[0]+'" />')}else t&&t.length>2?(q.tweet=t[3],o.push(q.tweet),q.content=""):(q.content=q.content.replace(/(?!.*(?:\.jpe?g|\.gif|\.png)$)((?:(?:http(?:s?))|(?:ftp)):\/\/[^\s|<|>|'|"]*)/gim,'<a href="$1" target="_blank">$1</a>'),q.content=q.content.replace(/^(https?|ftp|file):\/\/[\-A-Z0-9+&@#\/%?=~_|!:,.;]*[A-Z0-9+&@#\/%=~_|](\.jpg|.jpeg|\.gif|\.png)$/gim,'<img src="$&"/>'));if(q.content=q.content.replace(/(\r\n|\r|\n)/g,"<br/>"),0!==settings.Smilies&&(q.content=htmlSmilies(q.content)),j!==!1&&e>0&&(b=operator.id!==e?0:1),q.alignment=b>0?"right":"left",b>=0){0===b&&(q.tags=processTagsMenu(a,q.content),k++,alert={id:i,username:f,message:q.content},q.content=processTags(a,q.content));var w=!1;if((void 0===h||void 0===e)&&$.each(accounts,function(a,b){var c=parseInt(b.ID,10);return void 0!==e&&c===e||void 0===e&&b.Username===f?(w=b,h=void 0!==b.Image&&b.Image.indexOf("http")>-1?!1:b.Email,void 0===e&&(e=c),!1):void 0}),opts.messages.photo){var x="operator";if(void 0!==e&&(q.image=operatorImage(e,h,p)),w!==!1&&void 0!==w.Image&&(w.Image.indexOf("https://")>-1||w.Image.indexOf("data:image/")>-1))q.image=w.Image;else if(0===b&&0==j){var y=$(".chatting .visitor[data-id="+i+"], .other-chatting .visitor[data-id="+i+"]").data("user");void 0!==y&&(h=y.Email),q.image="https://secure.gravatar.com/avatar/"+CryptoJS.MD5(h)+"?s="+p+"&r=g&d="+r,x="guest"}}void 0!==g&&g.length>0&&(q.username=capitaliseFirstLetter(g)),opts.messages.from&&(b>0?q.username="":q.username+=" ");var z=/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/;z.test(a)&&(q.sending=!0),n+=App.templates.message(q)}else if(-2===b)n+='<div class="visitor alert" data-id="'+q.id+'" data-datetime="'+q.timestamp+'"><img src="'+operatorImage(!1,h,20,!1,!0)+'"/>'+capitaliseFirstLetter(q.content)+"</div>";else if(-3===b){for(var A=parseInt(q.content.substring(q.content.length-1),10),B="",C=1;5>=C;C++)B+=A>=C?'<div class="sprite RatingHighlight"></div>':'<div class="sprite Rating"></div>';switch(q.content=q.content.substring(0,q.content.length-2),A){case 5:A="Excellent";break;case 4:A="Very Good";break;case 3:A="Good";break;case 2:A="Poor";break;case 1:A="Very Poor"}n+='<div style="margin-left:20px" data-id="'+q.id+'" data-datetime="'+q.timestamp+'">'+q.content+"<span>"+B+'<span style="margin-left:10px">'+A+"</span></span></div>"}var D='.messages blockquote[data-id="'+q.id+'"], .messages div[data-id="'+q.id+'"]';return void 0!==l&&(D+=', .messages blockquote[data-id="'+l+'"], .messages div[data-id="'+l+'"]'),0===m.find(D).length?{html:n,total:k,alert:alert,tweets:o}:!1}function displayMessages(a,b,c,d,e,f,g,h,i,j,k){var l=c.data("closed"),m=void 0,n=$(".chat-list .visitor[data-id="+a+"][data-operator="+b+"]");if(void 0!==i&&i!==!1&&(n=$(".chat-list .channel."+i)),d.length>0&&!l){var o=c.find(".messages .flex.typing");if(o.length>0)$(d).insertBefore(o);else{0===c.length&&n.length>0&&(chattingVisitorClickCallback.call(n,{},!0,!0),c=$(".chat-stack .chat[data-id="+a+"][data-operator="+b+"]"));var p=c.find(".message").filter(function(){var a=$(this).data("id");return!("string"==typeof a&&36==a.length)&&a>g});p.length>0?$(d).insertBefore(p.first()):$(d).appendTo(c.find(".messages"))}if(k!==!1){if(void 0===k){var q=n.data("user");void 0!==q&&(k=q.Email)}var r=c.find(".avatar.guest"),s=window.devicePixelRatio>1?192:96,t=server.length>0?protocol+server+defaultUserImage:encodeURIComponent(window.location.protocol+"//"+window.location.host+path.replace(path.substring(path.indexOf(directoryPath+"admin/")),directoryPath+"images/UserSmall.png")),u="https://secure.gravatar.com/avatar/"+CryptoJS.MD5(k)+"?s="+s+"&r=g&d="+t;$("<img/>").attr("src",u).load(function(){$(this).remove()}).error(function(){$(this).remove(),r.css("background-image","url("+t+")")})}j!==!1&&j.length>0&&$.each(j,function(a,b){var c=$(".message .content[data-twitter="+b+"]"),d=c.find(".twitter-tweet").length;c.length>0&&!d&&twttr.widgets.createTweet(b,c.get(0),{theme:"light"})}),$.each(activechats,function(b,c){return c.id===a?void(c.message=g):void 0}),setTimeout(function(){scrollToBottom(a,b,h,i)},150),f>0&&0!=a&&(m=!0,updateMessageAlert(a,b,f,g)),g>0&&n.length>0&&n.data("messages",g)}return m}function playMessageSound(a,b){a&&void 0!==messageSound&&(messageSound.play(),$(document).trigger("LiveHelp.PlayMessageSound",b),a=!1)}function updateMessages(a){if(session.length>0&&messagesAjax){var b=$(".chat-stack"),c=b.find(".chat[data-id]");if($.each(c,function(a,b){var c=$(b),d=c.data("id"),e=c.data("closed"),f=c.data("operator"),g=f!==!1?1:0;addChat(d,g,e)}),activechats.length>0){var d="";$.each(activechats,function(a,b){d.length>0&&(d+="|"),d+=b.id+","+b.typing+","+b.type+","+b.message}),post={Data:d},apiRequest({url:apiEndpoint.chats,data:post,success:function(b){var c=!1,d="",e={},f=[];void 0!==b.MultipleMessages&&void 0!==b.MultipleMessages.Messages&&$.each(b.MultipleMessages.Messages,function(a,b){if(void 0!==b){var g=parseInt(b.ChatType,10)?!0:!1,h="string"==typeof b.ID&&36==b.ID.length?b.ID:parseInt(b.ID,10),i=parseInt(b.Status,10),j=b.Typing,k=$(".chat-stack .chat[data-id="+h+'][data-operator="'+g+'"]'),l=0,m=!1;k.find(".message.last").removeClass("last"),k.find(".message:not(.typing):last").addClass("last"),$.each(activechats,function(a,b){return void 0!==b.id&&b.id==h?(b.typing=j,updateTyping(b.id,b.typing),!1):void 0}),d="",email=!1,void 0!==b.Message&&b.Message.length>0&&$.each(b.Message,function(a,b){var c=parseInt(b.ID,10),i=parseInt(b.Status,10),j=b.Content,k=new moment(b.Datetime,"YYYY-MM-DD HH-mm:ssZZ"),n=void 0!==b.From?parseInt(b.From,10):void 0;email=b.Email;var o=void 0!==b.Username?b.Username:"";g!==!1&&void 0!==b.Name&&(o=b.Name);var p=messageHTML(c,i,j,k,n,o,void 0,email,h,g,l);p!==!1&&(d+=p.html,l=p.total,e=p.alert,p.tweets.length>0&&(f=f.concat(p.tweets))),m=c});var n=displayMessages(h,g,k,d,i,l,m,!1,!1,f,email);void 0!==n&&(c=n)}}),a&&a(),playMessageSound(c,e),$.isEmptyObject(e)||$(document).trigger("LiveHelp.MessagesUpdated"),refreshMessages()},error:function(b,c,d){refreshMessages(),a&&a()}})}else refreshMessages()}else refreshMessages()}function refreshMessages(){websockets===!1&&window.setTimeout(updateMessages,2e3)}function saveScroll(){var a=$(this),b=a.closest(".chat"),c=b.data("id"),d=b.data("operator"),e=_.find(viewed,function(a){return a.id===c&&a.operator==d});void 0!==e?(e.scroll=a.scrollTop(),storage.set("viewed",viewed)):(viewed.push({id:c,operator:d,message:0,viewed:0,scroll:a.scrollTop()}),storage.set("viewed",viewed))}function changeStatus(a,b,c){updateUsers(a,c,function(){refreshAccounts(a)});var d=!1;if(void 0===b)switch(a){case"Hidden":case"Offline":b="Offline",d=0;break;case"Online":b="Online",d=1;break;case"BRB":b="Be Right Back",d=2;break;case"Away":b="Away",d=3}void 0===c&&d!==!1&&(operator.status=d),$(document).trigger("LiveHelp.StatusChanged",a),$(".operator .dropdown-toggle .status").text(b),$(".operator .mode").removeClass("online offline hidden brb away").addClass(a.toLowerCase())}function initAdmin(){function a(a){if(a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),void 0!==a.dataTransfer){var b=$("#account-details.add, #account-details.edit").length;b?a.dataTransfer.dropEffect="copy":a.dataTransfer.dropEffect="none"}return!1}function b(){f.find(".title").text("Select a department"),f.find(".description").text("Select a department to assign the department to the current operator."),f.find(".edit.department.form").is(":visible")?(f.find(".department.edit, .save.button, .delete.button").hide(),f.find(".scroll").show(),f.find(".button-toolbar.departments").removeClass("save edit").addClass("add"),f.find(".add.button").css("display","inline-block"),f.animate({height:f.height()+100},250,"easeInOutBack")):f.show().animate({bottom:-f.height()},250,"easeInOutBack")}function c(){$(".operator .dropdown-toggle").dropdown("toggle")}$(".loading").hide();var d=storage.get("session");void 0!==d&&d.length>0?(session=d,autoSignIn?(signIn(),$(document).trigger("LiveHelp.AutoSignIn",!0)):$(document).trigger("LiveHelp.AutoSignIn",!1)):(showLogin(),$(document).trigger("LiveHelp.AutoSignIn",!1)),$("div.metro-pivot").metroPivot({selectedItemChanged:function(a){showVisitorChart(),showChatChart()},controlInitialized:function(){}}),$.preloadImages("images/bubbletip/bubbletip.png"),$(".twofactor .factor").hover(function(){$(this).find("span, img").animate({opacity:1},250)},function(){$(this).data("selected")||($(this).find("span").animate({opacity:0},250),$(this).find("img").animate({opacity:.5},250))}).click(function(){{var a=$(".twofactorcode");$(".login")}factor=$(this).data("factor"),$(this).parent().find(".factor").each(function(a,b){var c=$(b);c.data("factor")!==factor&&(c.data("selected",!1).find("img").animate({opacity:.5},250),c.find("span").animate({opacity:0},250))}),$(this).data("selected",!0).find("span, img").animate({opacity:1},250),a.fadeIn(),"push"===factor?a.find(".code").fadeOut(function(){a.find(".status span").text("Authenticate to send Duo PUSH request"),a.find(".status, .status img").fadeIn()}):("sms"===factor||"token"===factor)&&("sms"===factor?(a.find(".code label").text("SMS Code"),a.find(".hint-token").hide(),a.find(".hint-sms").show()):(a.find(".code label").text("Token Code"),a.find(".hint-sms").hide(),a.find(".hint-token").text("Enter your hardware token code or Duo Mobile code").show()),a.find(".status").fadeOut(function(){a.find(".code").fadeIn(function(){$("#twofactor").focus()})})),$("#twofactor").focus()}),$(".login input").keypress(function(a){13===a.which&&(signIn(),a.preventDefault())}),$(".login .signin.btn").click(function(){signIn()}),$(".login .clear").click(function(){var a=$(".login .inputs");a.find(".server input, .username input, .password input").val(""),a.find(".server input").focus()});var e=$("#account-details");$(document).bind("dragover",function(a){var b=$("#account-dropzone, #account-upload"),c=$("#account-upload"),d=window.dropZoneTimeout;d?clearTimeout(d):c.addClass("in"),$.inArray(a.target,b)>-1?c.addClass("hover"):c.removeClass("hover"),window.dropZoneTimeout=setTimeout(function(){window.dropZoneTimeout=null,c.removeClass("in hover")},100)}),$(document).bind("drop",function(b){a(b.originalEvent);var c=$("#account-details.add, #account-details.edit").length;if(c){{var d=b.originalEvent.dataTransfer;d.files}if(d.files.length>0){var e=d.files[0],f=new FileReader;f.onload=function(a){var b=$("#account-details .details #AccountID").val();b=b.length>0?parseInt(b,10):-1,updateAccountImage(b,a.target.result,!0)},accountFiles=e,f.readAsDataURL(e)}}}),$(document).bind("drop dragover",function(b){a(b.originalEvent)}),$("#account-upload").fileupload({url:server.length>0?protocol+server+directoryPath+apiPath+apiEndpoint.operators:directoryPath+apiPath+apiEndpoint.operators,headers:{Authorization:'Token signature="'+session+'", version="5"',Accept:"application/json"},dataType:"json",singleFileUploads:!0,dropZone:$("#account-dropzone"),submit:function(a,b){return!1}}),$(".slider.accounts #account-upload input[type=file]").hover(function(){$(this).parent().find(".edit").addClass("hover")},function(){$(this).parent().find(".edit").removeClass("hover")}),$("#account-upload input[type=file]").on("change",function(a){accountFiles=a.target.files;var b=this;if(b.files&&b.files[0]){var c=new FileReader;c.onload=function(a){var b=$("#account-details .details #AccountID").val();b=b.length>0?parseInt(b,10):-1,updateAccountImage(b,a.target.result,!0)},c.readAsDataURL(b.files[0])}}),e.find(".edit-button").click(function(){var a=$("#account-details"),b=a.find(".account.button-toolbar.edit"),c=a.find(".account.button-toolbar.edit").height();b.hide().css("bottom",-c+"px"),a.addClass("edit"),a.find(".value, .label.devices, .label.twofactor, .value.department .none").hide(),a.find(".LiveHelpInput, .password").fadeIn(),a.find(".tagsinput .tag").removeClass("disabled"),a.find("#AccountDepartment").parent().hide(),a.find(".tagsinput .tagsinput-add-container").css("display","inline-block"),a.find(".value.department, .tagsinput").show(),a.find(".account.button-toolbar.save").fadeIn().animate({bottom:"15px"},250,"easeInOutBack"),a.find(".InputError").removeClass("TickSmall CrossSmall")});var f=e.find(".departments.dialog");e.on("click",".tagsinput-add",function(){updateDepartment(!1,function(){f.animate({bottom:0},250,"easeInOutBack")})}),e.on("click",".tagsinput-remove-link",function(){var a=$(this).parent();if(a.is(".tag:not(.disabled)")){a.remove();var b=$("#account-details .department.value .tagsinput .tag").map(function(){return $(this).data("department")}).get();b.length>0&&$("#account-details #AccountDepartment").val(b.join("; "))}}),f.on("click",".save-button",function(){var a=f.find("#DepartmentPublic").is(":checked")?0:1,c=parseInt(f.find("#DepartmentID").val(),10),d=f.find("#DepartmentName"),e=f.find("#DepartmentEmail"),g={name:d.val(),email:e.val(),status:a};0!=validateField(d,"#DepartmentNameError")&&0!=validateEmail(e,"#DepartmentEmailError",!0)&&(isNaN(c)||$.extend(g,{id:c}),updateDepartment(g,function(){b()}))}),f.on("click",".delete-button",function(){var a=f.find("#DepartmentID").val(),c={id:parseInt(a,10)},d=$(".departments.dialog .department.item[data-id="+a+"] .name").text();updateDepartment(c,function(){$.each(accounts,function(a,b){var c=b.Department.split("; ");c=_.reject(c,function(a){return $.trim(a)===d}),b.Department=c.join("; "),accountsGrid.invalidate()}),b()})}),f.on("click",".department .edit.button",function(a){var b=$(this).parent();b.is(".department.item")&&(f.find(".title").text("Edit Department"),f.find(".description").text("Complete the details below to modify the department."),f.find("#DepartmentID").val(b.data("id")),f.find("#DepartmentName").val(b.find(".name").text()),f.find("#DepartmentEmail").val(b.find(".email").text()),0==b.data("status")?f.find("#DepartmentPublic").attr("checked","checked"):f.find("#DepartmentHidden").attr("checked","checked"),f.find(".scroll, .add.button").hide(),f.find(".department.edit, .LiveHelpInput").show(),f.find(".button-toolbar.departments").removeClass("add save").addClass("edit"),f.find(".save.button, .delete.button, .cancel.button").css({display:"inline-block",position:"relative"}),f.show().animate({height:f.height()-100},250,"easeInOutBack")),a.stopPropagation()}),f.on("click",".add-button",function(){f.find(".title").text("Add Department"),f.find(".description").text("Complete the details below to add a new department."),f.find("#DepartmentID").val(""),f.find("#DepartmentName").val(""),f.find("#DepartmentEmail").val(""),f.find("#DepartmentPublic").attr("checked","checked"),f.find(".scroll, .add.button, .delete.button").hide(),f.find(".department.edit, .LiveHelpInput").show(),f.find(".button-toolbar.departments").removeClass("save edit").addClass("add"),f.find(".save.button").css("display","inline-block"),f.show().animate({height:f.height()-100},250,"easeInOutBack")}),f.on("click",".department.item",function(){var a=$(this).find(".name").text(),b=$("#account-details .department.value .tagsinput"),c=b.find(".tagsinput-add-container");0===b.find('.tag[data-department="'+a+'"]').length&&$('<span class="tag" data-department="'+a+'"><span>'+a+'</span><a class="tagsinput-remove-link"></a></span>').insertBefore(c);var c=b.find(".tag").map(function(){return $(this).data("department")}).get();c.length>0&&$("#account-details #AccountDepartment").val(c.join("; ")),f.show().animate({bottom:-f.height()},250,"easeInOutBack")}),f.on("click",".cancel-button",function(){b()}),e.find(".edit.account.button-toolbar .cancel-button.account, .save.account.button-toolbar .cancel-button.account").click(closeAccountDetails),e.find(".add-button.account").click(function(){showAddAccount()}),e.find(".save-button.account").click(function(){var a=$("#account-details .header").text();"Add Account"===a?addAccount():saveAccount()}),e.find("input, select, .password").filter(":not(#AccountUsername, #AccountEmail, #ConfirmPassword)").on("keydown keyup change blur",function(){var a=$(this).attr("id");validateField($(this),"#"+a+"Error")}),e.find("#AccountUsername").on("keydown keyup change blur",function(){var a=$(this).attr("id");validateUsername($(this),"#"+a+"Error")}),e.find("#AccountEmail").on("keydown keyup change blur",function(){var a=$(this).attr("id");validateEmail($(this),"#"+a+"Error",!1)}),e.find("#AccountPasswordConfirm").on("keydown keyup change blur",function(){var a=$(this).attr("id");validatePassword($(this),$("#AccountPassword").val(),"#"+a+"Error")});var g=e.find(".confirm-delete.dialog");e.find(".button-toolbar.account .delete-button").click(function(){deleteAccountClickedCallback()}),g.find(".delete").click(function(){deleteAccountConfirmClickedCallback()}),g.find(".cancel").click(function(){g.animate({bottom:"-90px"},250,"easeInOutBack")}),$(".operator").on("click",".dropdown-menu.statusmode li a",function(){var a=$(this).attr("class");if("Accounts"===a)switchMenu("accounts");else if("History"===a)switchMenu("history");else if("Responses"===a)switchMenu("responses");else{if("Settings"===a)return switchMenu("settings"),!1;if("Integrations"===a)return c(),switchMenu("integrations"),!1;if("Billing"===a)return $(document).trigger("LiveHelp.OpenBilling"),c(),!1;"Signout"===a?signOut():changeStatus(a,$(this).text())}}),$("#pending").on("click",".visitor",$(this),function(a){var b=$(a.target).is(".visitor")?$(a.target):$(a.target).parent(),c=b.data("id");acceptChat(c),closeNotification()}),$(document).on("click",".chatting .visitor, .other-chatting .visitor, .operators .visitor",chattingVisitorClickCallback),$(".chat-stack").on("click",".chat .inputs > .close",function(){closeChats(),chatResponsesOpen&&(closeResponses(),chatResponsesOpen=!1)}),$(window).resize(function(){historyGrid&&historyGrid.resizeCanvas(),void 0!==accountsGrid&&accountsGrid.resizeCanvas(),void 0!==visitorsGrid&&visitorsGrid.resizeCanvas(),void 0===visitorChart&&void 0===chatChart&&(showVisitorChart(),
showChatChart())}),$("#responses").on("click",".response",function(a){if(activechats.length>0){var b,c,d=$(a.target).closest(".response").data("id"),e=["Text","Hyperlink","Image","PUSH","JavaScript"];if($.each(responses,function(a,f){$.inArray(a,e)>-1&&$.each(f,function(e,f){return d===parseInt(f.ID,10)?(b=f,void(c=a)):void 0})}),void 0!==b){var f=$(".chat-stack #message"),g=b.Content;("Hyperlink"===c||"PUSH"===c)&&(g=b.Name+" - "+b.Content),f.val(g).keyup()}}}),$("#responses").on("click",".response .send .menu-item",function(){var a,b,c=$(this).data("id"),d=$(this).closest(".response"),e=d.data("id"),f=["Text","Hyperlink","Image","PUSH","JavaScript"];return $.each(responses,function(c,d){$.inArray(c,f)>-1&&$.each(d,function(d,f){return e===parseInt(f.ID,10)?(a=f,void(b=c)):void 0})}),d.find(".dropdown-toggle").dropdown("toggle"),sendResponse(c,b,a)})}function sendResponse(a,b,c){return a>0?"Text"===b?(sendMessage(c.Content,a),!1):(sendCommand(a,b.toUpperCase(),c.Name,c.Content),!1):!1}function clearNotification(a){var b=-1;$.each(notifications,function(c,d){return a===d.id?(b=c,d.notification.cancel&&d.notification.cancel(),d.notification.close&&d.notification.close(),!1):void 0}),"undefined"!=typeof notifications[b]&&notifications.splice(b,1)}function acceptChat(a,b,c){var d=$(".pending .visitor[data-id="+a+"]"),e={visitor:a};if(d&&d.length>0){var f=d.find(".details.name"),a="number"==typeof d.data("id")?parseInt(d.data("id"),10):d.data("id"),g=f.text();e={id:a,name:f},clearNotification(a),d.css(acceptChatStyles),d.find(".image").addClass("hover"),f.text("Accepting Chat"),d.find(".details.department").text("with "+g),d.find(".image").css({background:"url(images/ProgressRing.gif) no-repeat",opacity:.5,border:"none","box-shadow":"none"}),d.find(".details.accesslevel").html("&nbsp;"),d.delay(3e3).fadeOut(function(){$(this).remove()}),("number"==typeof a&&a>0||"string"==typeof a&&36==a.length)&&updateUsers("Accept",a,function(){"function"==typeof c&&c(),$(".chatting, .other-chatting, .operators").find(".visitor[data-id!="+a+"]").removeClass("selected previous"),$(".chatting, .other-chatting").find(".visitor[data-id="+a+"]").addClass("selected")})}void 0===b&&$(document).trigger("LiveHelp.AcceptChat",e)}function showVisitorChart(){if($(".metro-pivot").is(":visible")){var a=1,b=opts.visitorChartColor,c=opts.visitorChartBulletBorderColor,d=opts.visitorChartFillColors,e=opts.visitorChartLineColor;if(0===visitorChartData.length){for(var f=30;f>0;f--){var g=new Date,h=Math.floor(51*Math.random())+30,i=Math.floor(131*Math.random())+120;g.setDate(g.getDate()-f),visitorChartData.push({date:g,chats:h,visits:i})}visitorChartEmpty=!0}visitorChartEmpty&&(b="#cccccc",c=b,d=b,e=b,a=.5),$("#visitor-chart").parent().css("opacity",a),visitorChart=new AmCharts.AmSerialChart,visitorChart.dataProvider=visitorChartData,visitorChart.categoryField="date",visitorChart.balloon.bulletSize=5,visitorChart.addListener("dataUpdated",visitorChartDataUpdated);var j=visitorChart.categoryAxis;j.parseDates=!0,j.minPeriod="DD",j.axisAlpha=0,j.dashLength=1,j.boldPeriodBeginning=!1,j.position="bottom",j.axisColor="#dadada";var k=visitorChart.balloon;k.adjustBorderColor=!0,k.color=b,k.cornerRadius=5,k.borderAlpha=1,k.borderColor=b,k.borderThickness=1,k.fillColor=b,k.fillAlpha=.8,k.color="#f3f3f3",k.showBullet=!0,k.fontSize=opts.visitorChartBalloonFontSize,k.textShadowColor="#666";var l=new AmCharts.ValueAxis;l.axisAlpha=0,l.dashLength=1,l.minimum=0,visitorChart.addValueAxis(l);var m=new AmCharts.AmGraph;m.type="line",m.valueField="visits",m.bullet="round",m.bulletColor="#ffffff",m.bulletBorderColor=c,m.bulletBorderThickness=2,m.bulletSize=6,m.fillColors=d,m.fillAlphas=.2,m.lineThickness=2,m.lineColor=e,m.balloonText="[[category]]: [[value]] visitors",visitorChart.addGraph(m);var n=new AmCharts.AmGraph;n.type="column",n.valueField="chats",n.fillColors=b,n.fillAlphas=opts.visitorChartFillAlphas,n.lineColor=b,n.lineThickness=1,n.balloonText="[[value]] chats",n.startDuration=1,visitorChart.addGraph(n),visitorChartCursor=new AmCharts.ChartCursor,visitorChartCursor.cursorPosition="mouse",visitorChartCursor.pan=!1,visitorChartCursor.zoomable=!1,visitorChartCursor.categoryBalloonEnabled=!1,visitorChartCursor.cursorAlpha=0,visitorChartCursor.categoryBalloonDateFormat="EEE DD MMM YYYY",visitorChart.addChartCursor(visitorChartCursor),visitorChart.fontFamily="Segoe UI",visitorChart.fontSize=14,visitorChart.color="#666",visitorChart.write("visitor-chart"),visitorChartEmpty===!0&&$("#visitor-empty").fadeIn()}}function showWeekdayChart(){if($("#weekday-chart").length){var a=opts.weekdayBalloonColor,b=opts.weekdayBalloonBorderColor,c=opts.weekdayBalloonFillColor,d=opts.weekdayBalloonFontSize,e=opts.weekdayGraphFillColor,f=opts.weekdayGraphColorField,g=opts.weekdayGraphFillAlphas,h=opts.weekdayGraphLineColor,i=opts.weekdayGraphLineColorField,j=1;if(0===weekdayChartData.length)weekdayChartData=[{Day:"Sun",Total:3,Average:1.5},{Day:"Mon",Total:4,Average:2},{Day:"Tue",Total:1,Average:1},{Day:"Wed",Total:5,Average:2.5},{Day:"Thu",Total:3,Average:3},{Day:"Fri",Total:5,Average:1.7},{Day:"Sat",Total:0,Average:1.5}],weekdayChartEmpty=!0;else{var k=[],l=["#655499","#6093BF","#68D4D4","#56BF95","#17996B","#655499","#6093BF"];$.each(weekdayChartData,function(a,b){b=$.extend(b,{Color:l[a]}),k.push(b)}),weekdayChartData=k}weekdayChartEmpty&&(color="#cccccc",j=.4),$("#weekday-chart").css("opacity",j),weekdayChart=new AmCharts.AmSerialChart,weekdayChart.dataProvider=weekdayChartData,weekdayChart.categoryField="Day",weekdayChart.balloon.bulletSize=5,weekdayChart.startDuration=1;var m=weekdayChart.categoryAxis;m.parseDates=!1,m.minPeriod="DD",m.axisAlpha=0,m.dashLength=1,m.boldPeriodBeginning=!1,m.position="bottom",m.axisColor="#dadada";var n=weekdayChart.balloon;n.adjustBorderColor=!0,n.color=a,n.cornerRadius=5,n.borderAlpha=1,n.borderColor=b,n.borderThickness=1,n.fillColor=c,n.fillAlpha=.8,n.color="#f3f3f3",n.showBullet=!0,n.bulletSize=4,n.fontSize=d,n.textShadowColor="#666";var o=new AmCharts.ValueAxis;o.axisAlpha=0,o.dashLength=1,o.minimum=0,weekdayChart.addValueAxis(o);var p=new AmCharts.AmGraph;p.type="column",p.valueField="Average",p.bulletSize=0,e&&(p.fillColors=e),f&&(p.colorField=f),p.fillAlphas=g,p.lineThickness=1,h&&(p.lineColor=h),i&&(p.lineColorField=i),p.balloonText="[[category]]: [[value]] chats (average)",weekdayChart.addGraph(p),weekdayChartCursor=new AmCharts.ChartCursor,weekdayChartCursor.cursorPosition="mouse",weekdayChartCursor.pan=!1,weekdayChartCursor.zoomable=!1,weekdayChartCursor.categoryBalloonEnabled=!1,weekdayChartCursor.cursorAlpha=0,weekdayChartCursor.categoryBalloonDateFormat="EEE DD MMM YYYY",weekdayChart.addChartCursor(weekdayChartCursor),weekdayChart.fontFamily="Segoe UI",weekdayChart.fontSize=14,weekdayChart.color="#666",weekdayChart.write("weekday-chart"),weekdayChartEmpty===!0&&$("#weekday-empty").fadeIn()}}function showChatChart(){if($(".metro-pivot").is(":visible")){var a=opts.chatChartColor,b=opts.chatBalloonFontSize,c=opts.chatGraphFillAlphas,d=$("#chat-empty"),e=1;if(0===chatChartData.length){for(var f=30;f>0;f--){var g=new Date,h=Math.floor(51*Math.random())+30;g.setDate(g.getDate()-f),chatChartData.push({date:g,chats:h})}chatChartEmpty=!0}else d.hide();chatChartEmpty&&(a="#cccccc",e=.4),$("#chat-chart").css("opacity",e),chatChart=new AmCharts.AmSerialChart,chatChart.dataProvider=chatChartData,chatChart.categoryField="date",chatChart.balloon.bulletSize=5,chatChart.startDuration=1,chatChart.addListener("dataUpdated",chatChartDataUpdated);var i=chatChart.categoryAxis;i.parseDates=!0,i.minPeriod="DD",i.axisAlpha=0,i.dashLength=1,i.boldPeriodBeginning=!1,i.position="bottom",i.axisColor="#dadada";var j=chatChart.balloon;j.adjustBorderColor=!0,j.color=a,j.cornerRadius=5,j.borderAlpha=1,j.borderColor=a,j.borderThickness=1,j.fillColor=a,j.fillAlpha=.8,j.color="#f3f3f3",j.showBullet=!0,j.bulletSize=4,j.fontSize=b,j.textShadowColor="#666";var k=new AmCharts.ValueAxis;k.axisAlpha=0,k.dashLength=1,k.minimum=0,chatChart.addValueAxis(k);var l=new AmCharts.AmGraph;l.type="column",l.valueField="chats",l.bulletSize=0,l.fillColors=a,l.fillAlphas=c,l.lineThickness=1,l.lineColor=a,l.balloonText="[[category]]: [[value]] chats",chatChart.addGraph(l),chatChartCursor=new AmCharts.ChartCursor,chatChartCursor.cursorPosition="mouse",chatChartCursor.pan=!1,chatChartCursor.zoomable=!1,chatChartCursor.categoryBalloonEnabled=!1,chatChartCursor.cursorAlpha=0,chatChartCursor.categoryBalloonDateFormat="EEE DD MMM YYYY",chatChart.addChartCursor(chatChartCursor),chatChart.fontFamily="Segoe UI",chatChart.fontSize=14,chatChart.color="#666",chatChart.write("chat-chart"),chatChartEmpty===!0&&d.fadeIn()}}function pad(a){return 10>a?"0"+a:a}function getUTCOffset(){var a=new Date,b=a.getTimezoneOffset()>0?"-":"+",c=Math.abs(a.getTimezoneOffset()),d=pad(Math.floor(c/60)),e=pad(c%60);return b+d+e}function loadStatisticsChartData(){if(session.length>0){var a={Timezone:getUTCOffset()};apiRequest({url:apiEndpoint.statistics,data:a,success:function(a){if(null!==a.Statistics&&void 0!==a.Statistics){var b,c=0,d=a.Statistics.Chats,e=a.Statistics.Visitors,f=a.Statistics.Duration,g=a.Statistics.Rating;if(null!==e&&void 0!==e&&(b=new moment(e.Date).add("d",1).toDate(),null!==e&&null!==d))for(void 0===d.Data&&(d.Data=new Array(31).join("0").split("").map(parseFloat)),e.Data=e.Data.reverse(),visitorChartData=[],c=0;30>c;c++)visitorChartData.push({date:new moment(b).add("day",c).toDate(),chats:d.Data[c],visits:e.Data[c]}),visitorChartEmpty=!1;if(showVisitorChart(),null!==d&&void 0!==d&&void 0!==d.Data){var h=.5;for(b=new moment(d.Date).add("day",1).toDate(),historyChartData=[],chatChartData=[],c=0;30>c;c++)c>23&&historyChartData.push({date:new moment(b).add("day",c).toDate(),chats:d.Data[c]}),c>28?(color="#00637d",h=.8):(color=opts.statisticsChartColor,h=.5),chatChartData.push({date:new moment(b).add("day",c).toDate(),color:color,alpha:h,chats:d.Data[c]}),chatChartEmpty=!1;weekdayChartData=d.Weekday}showChatChart(),showHistoryChart(),showWeekdayChart();var i=0,j=$(".statistics.container");if(null!==f&&void 0!==f&&void 0!==f.Data){$.each(f.Data,function(a,b){i+=b});var k=parseInt(i/f.Data.length,10),l=Math.floor(k/3600),m=Math.floor((k-3600*l)/60),n=k-3600*l-60*m+" seconds";l=l>0?l+" hours ":"",m+=" minutes ",k=l+m+n,j.find(".averagechattime").text(k)}else j.find(".averagechattime").text(locale.unavailable);if(i=0,null!==g&&void 0!==g){ratingChartData=[{rating:"Excellent",total:parseInt(g.Excellent,10)},{rating:"Very Good",total:parseInt(g.VeryGood,10)},{rating:"Good",total:parseInt(g.Good,10)},{rating:"Poor",total:parseInt(g.Poor,10)},{rating:"Very Poor",total:parseInt(g.VeryPoor,10)},{rating:"Unrated",total:parseInt(g.Unrated,10)}],ratingChartEmpty=!1;var o=0;g=5,$.each(ratingChartData,function(a,b){b.total>0&&5>a&&(i+=b.total,o+=(g-a)*b.total,g--)}),i>0?(o=(o/i).toFixed(2),g=ratingChartData[5-parseInt(o,10)].rating,j.find(".averagechatrating").text(o+" "+g)):j.find(".averagechatrating").text(locale.unavailable)}else j.find(".averagechatrating").text(locale.unavailable);showRatingChart()}}})}}function visitorChartDataUpdated(){visitorChartEmpty||$("#visitor-chart").fadeTo(1e3,1)}function chatChartDataUpdated(){chatChartEmpty||$("#chat-chart").fadeTo(1e3,1)}function showRatingChart(){if($("#rating-chart").length){var a=opts.ratingChartColors,b=.8,c=opts.ratingChartBackground;0===ratingChartData.length&&(ratingChartData=[{rating:"Excellent",total:20},{rating:"Very Good",total:18},{rating:"Good",total:10},{rating:"Poor",total:4},{rating:"Very Poor",total:2},{rating:"Unrated",total:8}],ratingChartEmpty=!0),ratingChartEmpty&&(a=["#2F3540","#666A73","#F2EDE4","#D9D1C7","#8C8681","#333333"],b=.1,c="#CCC");var d=$(".rating.histogram"),e=0,f=0,g=[".excellent",".verygood",".good",".poor",".verypoor",".unrated"];$.each(ratingChartData,function(a,b){e+=parseInt(b.total,10)}),f=250/e,$.each(g,function(a,b){d.find(b).css({background:c}).animate({width:ratingChartData[a].total*f},1e3,"easeInOutBack")}),ratingChart=new AmCharts.AmPieChart,ratingChart.dataProvider=ratingChartData,ratingChart.titleField="rating",ratingChart.valueField="total",ratingChart.outlineColor="#eeedee",ratingChart.outlineAlpha=1,ratingChart.outlineThickness=2,ratingChart.radius="30%",ratingChart.colors=a,ratingChart.pieAlpha=b,ratingChart.pullOutOnlyOne=!0;var h=ratingChart.balloon;h.adjustBorderColor=!0,h.cornerRadius=5,h.borderAlpha=1,h.borderColor=opts.ratingBalloonBorderColor,h.borderThickness=1,h.fillColor="[[color]]",h.fillAlpha=b,h.color="#f3f3f3",h.showBullet=!0,h.fontSize=opts.ratingBalloonFontSize,h.textShadowColor="#666",ratingChart.write("rating-chart"),ratingChartEmpty&&$("#rating-empty").fadeIn()}}function showHistoryChart(){if($("#history-chart").length){var a=!1;if(0===historyChartData.length){for(var b=7;b>0;b--){var c=new Date,d=Math.floor(16*Math.random())+5;c.setDate(c.getDate()-b),historyChartData.push({date:c,chats:d})}a=!0}historyChart=new AmCharts.AmSerialChart,historyChart.dataProvider=historyChartData,historyChart.categoryField="date",historyChart.balloon.bulletSize=5,historyChart.addListener("dataUpdated",historyChartDataUpdated);var e=historyChart.categoryAxis;e.parseDates=!0,e.minPeriod="DD",e.axisAlpha=0,e.dashLength=0,e.boldPeriodBeginning=!1,e.position="top",e.axisColor="#dadada",e.labelsEnabled=!1,e.gridAlpha=0;var f=historyChart.balloon;f.adjustBorderColor=!0,f.color="#999999",f.cornerRadius=5,f.borderAlpha=1,f.borderColor="#999999",f.borderThickness=1,f.fillColor="#999999",f.fillAlpha=.8,f.color="#f3f3f3",f.showBullet=!0,f.fontSize=opts.historyBalloonFontSize,f.textShadowColor="#666";var g=new AmCharts.ValueAxis;g.axisAlpha=0,g.dashLength=0,g.labelsEnabled=!1,g.minimum=0,g.gridAlpha=.1,historyChart.addValueAxis(g);var h=new AmCharts.AmGraph;h.type="line",h.valueField="chats",h.bullet="round",h.bulletColor="#ffffff",h.bulletBorderColor="#999999",h.bulletBorderThickness=2,h.bulletSize=6,h.fillColors="#999999",h.fillAlphas=.2,h.lineThickness=2,h.lineColor="#999999",h.balloonText="[[category]]: [[value]] chats",historyChart.addGraph(h),historyChartCursor=new AmCharts.ChartCursor,historyChartCursor.cursorPosition="mouse",historyChartCursor.pan=!1,historyChartCursor.zoomable=!1,historyChartCursor.categoryBalloonEnabled=!1,historyChartCursor.cursorAlpha=0,historyChartCursor.categoryBalloonDateFormat="EEE DD MMM YYYY",historyChart.addChartCursor(historyChartCursor),historyChart.fontFamily="Segoe UI",historyChart.fontSize=14,historyChart.color="#666",historyChart.write("history-chart"),a&&$("#history-empty").fadeIn()}}function historyChartDataUpdated(){$("#history-chart").fadeTo(1e3,1)}function ucwords(a){return(a+"").replace(/^([a-z])|\s+([a-z])/g,function(a){return a.toUpperCase()})}function strtolower(a){return(a+"").toLowerCase()}function htmlSmilies(a){for(var b=[{regex:/^:D$|^:D | :D | :D$/g,css:"Laugh Small"},{regex:/^:\)$|^:\) | :\) | :\)$/g,css:"Smile Small"},{regex:/^:\($|^:\( | :\( | :\($/g,css:"Sad Small"},{regex:/^\$\)$|^\$\) | \$\) | \$\)$/g,css:"Money Small"},{regex:/^&gt;:O$|^&gt;:O |^>:O | &gt;:O | >:O | &gt;:O$| >:O$/g,css:"Angry Small"},{regex:/^:P$|^:P | :P | :P$/g,css:"Impish Small"},{regex:/^:\\$|^:\\ | :\\ | :\\$/g,css:"Sweat Small"},{regex:/^8\)$|^8\) | 8\) | 8\)$/g,css:"Cool Small"},{regex:/^&gt;:L$|^&gt;:L |^>:L | &gt;:L | >:L | &gt;:L$| >:L$/g,css:"Frown Small"},{regex:/^;\)$|^;\) | ;\) | ;\)$/g,css:"Wink Small"},{regex:/^:O$|^:O | :O | :O$/g,css:"Surprise Small"},{regex:/^8-\)$|^8-\) | 8-\) | 8-\)$/g,css:"Woo Small"},{regex:/^8-O$|^8-O | 8-O | 8-O$/g,css:"Shock Small"},{regex:/^xD$|^xD | xD | xD$/g,css:"Hysterical Small"},{regex:/^:-\*$|^:-\* | :-\* | :-\*$/g,css:"Kissed Small"},{regex:/^:S$|^:S | :S | :S$/g,css:"Dizzy Small"},{regex:/^\+O\)$|^\+O\) | \+O\) | \+O\)$/g,css:"Celebrate Small"},{regex:/^&lt;3$|^<3$|^&lt;3|^<3 | &lt;3|<3 | &lt;3$| <3$/g,css:"Adore Small"},{regex:/^zzZ$|^zzZ | zzZ | zzZ$/g,css:"Sleep Small"},{regex:/^:X$|^:X | :X | :X$/g,css:"Stop Small"},{regex:/^X-\($|^X-\( | X-\( | X-\($/g,css:"Tired Small"}],c=0;c<b.length;c++){var d=b[c];a=a.replace(d.regex,' <span title="'+d.css+'" class="sprite '+d.css+' Smilie"></span> ')}return $.trim(a)}function openHome(){$(".chat-stack, .history.container, .statistics.container, .accounts.slider, .responses.slider, .settings.container").hide(),closeHistory(),void 0!==visitors&&visitors.length>0&&"none"==$(".worldmap").css("display")?($(".visitors-empty").hide(),$(".visitors.container, .visitors-grid, .visitors-menu").show(),$(".visitors-list.button").addClass("selected"),$(".visitors-map.button").removeClass("selected")):$(".visitors.container, .visitors-empty").show()}function processLanguage(a){locale=a,$(document).trigger("LiveHelp.LocaleUpdated");var b=$("[data-lang-key]");$.each(b,function(b,c){var c=$(c),b=c.attr("data-lang-key");c.text(a[b])}),storage.set("locale",locale)}function loadSettings(a){settings=a,storage.set("settings",settings),$("#domainname").val(a.Domain),$("#siteaddress").val(a.SiteAddress),$("#livehelpname").val(a.Name),0!==a.VisitorTracking?$("#visitortracking-enable").attr("checked","checked"):$("#visitortracking-disable").attr("checked","checked"),0!==a.Departments?$("#departments-enable").attr("checked","checked"):$("#departments-disable").attr("checked","checked"),$("#welcomenote").val(a.WelcomeMessage),$("#language").empty();var b=a.Language.Available.split(", "),c=[{code:"af",name:"Afrikaans"},{code:"ar",name:"Arabic"},{code:"be",name:"Byelorussian"},{code:"bg",name:"Bulgarian"},{code:"ca",name:"Catalan"},{code:"zh",name:"Chinese Simplified"},{code:"cs",name:"Czech"},{code:"da",name:"Danish"},{code:"de",name:"German"},{code:"el",name:"Greek"},{code:"en",name:"English"},{code:"es",name:"Spanish"},{code:"et",name:"Estonian"},{code:"eu",name:"Basque"},{code:"fi",name:"Finnish"},{code:"fo",name:"Faroese"},{code:"fr",name:"French"},{code:"ga",name:"Irish"},{code:"gl",name:"Galician"},{code:"hr",name:"Croatian"},{code:"hu",name:"Hungarian"},{code:"is",name:"Icelandic"},{code:"it",name:"Italian"},{code:"he",name:"Hebrew"},{code:"ja",name:"Japanese"},{code:"ko",name:"Korean"},{code:"lt",name:"Lithuanian"},{code:"lv",name:"Latvian"},{code:"mk",name:"Macedonian"},{code:"mt",name:"Maltese"},{code:"nl",name:"Dutch"},{code:"no",name:"Norwegian"},{code:"pl",name:"Polish"},{code:"pt",name:"Portuguese"},{code:"ro",name:"Romanian"},{code:"ru",name:"Russian"},{code:"sk",name:"Slovak"},{code:"sl",name:"Slovenian"},{code:"sq",name:"Albanian"},{code:"sv",name:"Swedish"},{code:"tr",name:"Turkish"},{code:"uk",name:"Ukrainian"}];$.each(b,function(a,b){var d="";$.each(c,function(a,c){return b==c.code?(d=c.name,!1):void 0}),$('<option value="'+b+'">'+d+"</option>").appendTo("#language")}),$("#language").val(a.Language.Locale),updateLanguage(a.Language.Locale);var d=$("#template");d.find("option").remove(),$.each(a.Templates,function(a,b){d.append('<option value="'+b.value+'">'+b.name+"</option>")}),d.val(a.Template),0!==a.Smilies?($("#smilies-enable").attr("checked","checked"),enableSmilies()):($("#smilies-disable").attr("checked","checked"),disableSmilies()),$("#backgroundcolor").val(a.BackgroundColor),$("#generalfont").val(a.Font.Type),$("#generalfontsize").val(a.Font.Size),$("#generalfontcolor").val(a.Font.Color),$("#generalfontlinkcolor").val(a.Font.LinkColor),$("#guestchatfont").val(a.ChatFont.Type),$("#guestchatfontsize").val(a.ChatFont.Size),$("#sentcolor").val(a.ChatFont.SentColor),$("#receivedcolor").val(a.ChatFont.ReceivedColor),$("#chatwindowsize").val(a.ChatWindowSize.Width+" x "+a.ChatWindowSize.Height),$("#backgroundcolor, #sentcolor, #receivedcolor, #generalfontcolor, #generalfontlinkcolor").minicolors(),window.webkitNotifications||"Notification"in window?($("#html5-notifications-enable").attr("checked","checked"),storage.get("html5-notifications")?checkHTML5NotificationsPermission():$("#html5-notifications-disable").attr("checked","checked")):($("#html5-notifications-disable").attr("checked","checked"),$(".html5-notifications input").attr("disabled","disabled"),storage.set("html5-notifications",!1)),$("#logo").val(a.Logo),$("#campaignimage").val(a.Campaign.Image),$("#campaignlink").val(a.Campaign.Link),$("#onlineimage").val(a.OnlineLogo),$("#offlineimage").val(a.OfflineLogo),a.BeRightBackLogo!==!1?$("#berightbackimage").val(a.BeRightBackLogo):$("#berightbackimage, .berightbackimage").hide(),a.AwayLogo!==!1?$("#awayimage").val(a.AwayLogo):$("#awayimage, .awayimage").hide(),$("#htmlcodestep1").val(a.Code.Head),$("#htmlcodestep2").val(a.Code.Image),$("#emailaddress").val(a.Email),$("#offlineurlredirection").val(a.OfflineEmail.Redirect),0!==a.OfflineEmail.Enabled?$("#email-enable").attr("checked","checked"):$("#email-disable").attr("checked","checked"),$("#autoinitiatechat-enable").change(function(){$(this).is(":checked")&&$(".autoinitiate-pageviews").fadeIn()}),$("#autoinitiatechat-disable").change(function(){$(this).is(":checked")&&$(".autoinitiate-pageviews").fadeOut()}),a.InitiateChat.Auto>0?($("#autoinitiatechat-enable").attr("checked","checked"),$("#autoinitiatechat-pages").val(a.InitiateChat.Auto),$(".autoinitiate-pageviews").fadeIn()):($("#autoinitiatechat-disable").attr("checked","checked"),$("#autoinitiatechat-pages").val(a.InitiateChat.Auto),$(".autoinitiate-pageviews").hide()),$("#verticalalignment").val(a.InitiateChat.Vertical),$("#horizontalalignment").val(a.InitiateChat.Horizontal);var e=$(".guestemailaddress, .guestquestion, .guestlogindetailsrequired");if(0!==a.LoginDetails.Enabled?($("#guestlogindetails-enable").attr("checked","checked"),e.show()):($("#guestlogindetails-disable").attr("checked","checked"),e.hide()),0!==a.LoginDetails.Required&&($("#guestlogindetailsrequired-enable").attr("checked","checked"),e.show()),$("#guestlogindetails-enable, #guestlogindetails-disable").change(function(){var a=$(".guestemailaddress, .guestquestion, .guestlogindetailsrequired");$("#guestlogindetails-enable").is(":checked")?a.show():a.hide()}),0!==a.LoginDetails.Email?$("#guestemailaddress-enable").attr("checked","checked"):$("#guestemailaddress-disable").attr("checked","checked"),0!==a.LoginDetails.Question?$("#guestquestion-enable").attr("checked","checked"):$("#guestquestion-disable").attr("checked","checked"),0!==a.SecurityCode?$("#securitycode-enable").attr("checked","checked"):$("#securitycode-disable").attr("checked","checked"),$("#telephone").val(a.Telephone),$("#address").val(a.Address),void 0!==a.Version){var f=a.Version.Server;f>=4.1&&$(".visitors-list.button, .visitors-map.button").css("display","inline-block")}$(document).trigger("LiveHelp.SettingsLoaded",settings)}function enableSmilies(){$(".smilies.button").show()}function disableSmilies(){$(".smilies.button").hide()}function requestHTML5NotificationsPermission(){window.webkitNotifications||"Notification"in window?window.webkitNotifications?window.webkitNotifications.requestPermission(checkHTML5NotificationsPermission):"Notification"in window?Notification.requestPermission(function(a){"permission"in Notification||(Notification.permission=a),checkHTML5NotificationsPermission()}):storage.set("html5-notifications",!1):($(".html5-notifications input").attr("disabled","disabled"),storage.set("html5-notifications",!1))}function checkHTML5NotificationsPermission(){var a=!1;return void 0!==window.webkitNotifications?0===window.webkitNotifications.checkPermission()&&(a=!0):"Notification"in window&&"granted"===Notification.permission&&(a=!0),a?$(".html5-notifications input").removeAttr("disabled"):$(".html5-notifications input").attr("disabled","disabled"),storage.set("html5-notifications",a),a}function openSettings(a){var b=$(".settings.dropdown"),c=b.find(".settingsmenu"),d=b.find(".button-toolbar");if($(".accounts.slider, .responses.slider, .chat-stack, .section.settings-integrations").hide(),c.show(),closeHistory(),void 0!==a&&a.length>0?(c.find("div").removeClass("selectedLava"),c.find("#"+a).addClass("selectedLava"),openSettingsMenu(a)):(b.find(".section").hide(),c.find("#general").click(),b.find(".section.settings-general").show()),d.animate({bottom:"15px"},250,"easeInOutBack"),b.is(":hidden")){var e=$(".settingsmenu > div:not(#htmlcode, #alerts, .backLava)");operator.access>=2&&(e.remove(),void 0===a&&c.find("#alerts").click()),$(document).trigger("LiveHelp.OpenSettings"),$(".settings.container").show(),b.show(),b.find("#general").mouseover(),0===c.find(".backLava").length&&c.lavaLamp({target:"div",container:"div",speed:250,includeMargins:!0,easing:"easeOutBack",fx:"easeOutBack"}),apiRequest({url:apiEndpoint.settings,success:function(a){void 0!==a.Settings&&loadSettings(a.Settings)}}),$("#html5-notifications-enable, #html5-notifications-disable").change(function(){$("#html5-notifications-enable").is(":checked")?requestHTML5NotificationsPermission():($(this).attr("disabled","disabled"),storage.set("html5-notifications",!1))})}}function openSettingsMenu(a){switch(a){case"htmlcode":$(document).trigger("LiveHelp.SettingsHTMLCodeClick"),zclip&&($(".copy.step1, .copy.step2").off("copy afterCopy"),$(".copy.step1").on("copy",function(a){a.clipboardData.clearData(),a.clipboardData.setData("text/plain",$("textarea#htmlcodestep1").val()),a.preventDefault()}).on("afterCopy",function(a){$("textarea#htmlcodestep1").pulse({backgroundColor:["#dbf3f8","#ffffff"]},500,2)}),$(".copy.step2").on("copy",function(a){a.clipboardData.clearData(),a.clipboardData.setData("text/plain",$("textarea#htmlcodestep2").val()),a.preventDefault()}).on("afterCopy",function(a){$("textarea#htmlcodestep2").pulse({backgroundColor:["#dbf3f8","#ffffff"]},500,2)}));break;case"integrations":$(".settingsmenu").hide()}var b=$(".settings-"+a),c=b.parent().find(".section");settingsMenuClickedCallback(a),b.show(),$.each(c,function(b,c){var d=$(c);-1==d.attr("class").indexOf("settings-"+a)&&d.hide()})}function saveSettings(){if(!(operator.access>=2)){var a=$("#settings #smilies-enable").is(":checked")?-1:0,b=$("#settings #visitortracking-enable").is(":checked")?-1:0,c=$("#settings #departments-enable").is(":checked")?-1:0,d=$("#settings #email-enable").is(":checked")?-1:0,e=$("#settings #guestemailaddress-enable").is(":checked")?-1:0,f=$("#settings #guestquestion-enable").is(":checked")?-1:0,g=$("#settings #autoinitiatechat-disable:checked").length>0?-1:$("#settings #autoinitiatechat-pages").val(),h=$("#settings #securitycode-enable").is(":checked")?-1:0,i=$("#settings #guestlogindetails-enable").is(":checked")?-1:0,j=$("#settings #guestlogindetailsrequired-enable").is(":checked")?-1:0,k=$("#settings select#chatwindowsize").val(),l={width:parseInt(k.substring(0,k.indexOf(" x ")),10),height:parseInt(k.substring(k.indexOf(" x ")+3),10)},m={Domain:$("#settings #domainname").val(),URL:$("#settings #siteaddress").val(),Email:$("#settings #emailaddress").val(),Name:$("#settings #livehelpname").val(),Logo:$("#settings #logo").val(),Introduction:$("#settings #welcomenote").val(),Smilies:a,Font:$("#settings #generalfont").val(),FontSize:$("#settings #generalfontsize").val(),FontColor:$("#settings #generalfontcolor").val(),ChatFont:$("#settings #guestchatfont").val(),SentFontColor:$("#settings #sentcolor").val(),ReceivedFontColor:$("#settings #receivedcolor").val(),LinkColor:$("#settings #generalfontlinkcolor").val(),BackgroundColor:$("#settings #backgroundcolor").val(),ChatFontSize:$("#settings #guestchatfontsize").val(),OfflineLogo:$("#settings #offlineimage").val(),OnlineLogo:$("#settings #onlineimage").val(),OfflineEmailLogo:$("#settings #offlineimage").val(),BeRightBackLogo:$("#settings #berightbackimage").val(),AwayLogo:$("#settings #awayimage").val(),LoginDetails:i,LoginEmail:e,LoginQuestion:f,OfflineEmail:d,OfflineEmailRedirect:$("#settings #offlineurlredirection").val(),SecurityCode:h,Departments:c,VisitorTracking:b,Locale:$("#settings #language").val(),InitiateChatVertical:$("#settings #verticalalignment").val(),InitiateChatHorizontal:$("#settings #horizontalalignment").val(),InitiateChatAuto:g,ChatUsername:-1,CampaignImage:$("#settings #campaignimage").val(),CampaignLink:$("#settings #campaignlink").val(),IP2Country:-1,ChatWindowWidth:l.width,ChatWindowHeight:l.height,RequireGuestDetails:j,Template:$("#settings #template").val(),Telephone:$("#settings #telephone").val(),Address:$("#settings #address").val()};saveSettingsCallback(),m=overrideSettingsCallback(m),apiRequest({url:apiEndpoint.settings,data:m,success:function(a){void 0!==a.Settings?(loadSettings(a.Settings),saveSettingsCompletedCallback()):saveSettingsErrorCallback()},error:function(a,b,c){saveSettingsErrorCallback()}})}}function closeSettings(){$(".miniColors-selector").hide(),$(".settings.dropdown").animate({height:0,opacity:0},250,"easeInOutBack",function(){$(this).hide(),$(".settings.container").hide(),$(this).find(".button-toolbar").animate({bottom:"-90px"},250,"easeInOutBack")}),switchPreviousMenu()}function zeroFill(a,b){return b-=a.toString().length,b>0?new Array(b+(/\./.test(a)?2:1)).join("0")+a:a}function capitaliseFirstLetter(a){return a.charAt(0).toUpperCase()+a.slice(1)}function openHistoryChat(a){var b=$("#history-chat"),c=parseInt(a.Session,10),d=parseInt(a.Active,10),e={Data:c+",0,0,0"};if(c>0){var f=a.Email;(f.indexOf("<")>-1||f.indexOf(">")>-1)&&(f=$(a.Email).text()),b.data("id",c),b.find(".name").text(a.Username+" - "+f),b.find(".messages").html("");var g=b.find(".dialog");-3===d?g.show().animate({bottom:"1px"},250):g.animate({bottom:"-145px"},250,function(){$(this).hide()}),apiRequest({url:apiEndpoint.chats,data:e,success:function(a){if(void 0!==a.MultipleMessages&&void 0!==a.MultipleMessages.Messages){var b=a.MultipleMessages.Messages[0],d="",e="left",g=server.length>0?protocol+server+defaultUserImage:encodeURIComponent(window.location.protocol+"//"+window.location.host+path.replace(path.substring(path.indexOf(directoryPath+"admin/")),directoryPath+"images/UserSmall.png")),h=window.devicePixelRatio>1?192:96;parseInt(b.ID,10)===c&&b.Message.length>0&&($.each(b.Message,function(a,b){var c=parseInt(b.Status,10),i=b.Content,j=new moment(b.Datetime,"YYYY-MM-DD HH:mm:ss").toDate(),k=j.getHours()+":"+zeroFill(j.getMinutes(),2);if(c>0&&(i=$("<div>").text(i).html()),3===c){var l=/(https?|ftp|file):\/\/[\-A-Z0-9+&@#\/%?=~_|!:,.;]*[A-Z0-9+&@#\/%=~_|](\.jpg|.jpeg|\.gif|\.png)/im,m=l.exec(i);null!==m&&(i='<img src="'+m[0]+'" />')}else i=i.replace(/(?!.*(?:\.jpe?g|\.gif|\.png)$)((?:(?:http(?:s?))|(?:ftp)):\/\/[^\s|<|>|'|"]*)/gim,'<a href="$1" target="_blank">$1</a>'),i=i.replace(/^(https?|ftp|file):\/\/[\-A-Z0-9+&@#\/%?=~_|!:,.;]*[A-Z0-9+&@#\/%=~_|](\.jpg|.jpeg|\.gif|\.png)$/gim,'<img src="$&"/>');0!==settings.Smilies&&(i=htmlSmilies(i));var n=b.Username,o=b.Email,p=0,q="",r="";if(1===c&&$.each(accounts,function(a,b){return b.Username===n?(n=b.Firstname,void(p=b.ID)):void 0}),n=n.length>0?"from "+capitaliseFirstLetter(n):"",e=c>0?"right":"left",c>=0){var s=!1;if(c>0&&$.each(accounts,function(a,c){var d=parseInt(c.ID,10);return b.Username===c.Username?(o=void 0!==b.Image&&b.Image.indexOf("http")>-1?!1:c.Email,r=d,!1):void 0}),opts.messages.photo){var t="";if(c>0&&(image=operatorImage(r,o,h)),s!==!1&&void 0!==s.Image&&(s.Image.indexOf("https://")>-1||s.Image.indexOf("data:image/")>-1))image=s.Image;else if(0===c){var o=f;image="https://secure.gravatar.com/avatar/"+CryptoJS.MD5(o)+"?s="+h+"&r=g&d="+g,t=" guest"}q='<div class="avatar'+t+'" style="background-image:url(\''+image+"'); background-size: 32px auto\"></div>"}opts.messages.from&&(r='<div class="from">'+n+" at "+k+"</div>"),image=q.length>0?" image":"",d+='<div class="flex '+e+image+'">'+q+'<blockquote class="message '+e+'"><div class="content">'+i+"</div>"+r+"</blockquote></div>"}else if(-2===c)d+='<div class="visitor alert"><img src="'+g+'" style="width: 20px; height: 20px"/>'+capitaliseFirstLetter(i)+"</div>";else if(-3===c){for(var u=parseInt(i.substring(i.length-1),10),v="",w=1;5>=w;w++)v+=u>=w?'<div class="sprite RatingHighlight"></div>':'<div class="sprite Rating"></div>';switch(i=i.substring(0,i.length-2),u){case 5:u="Excellent";break;
case 4:u="Very Good";break;case 3:u="Good";break;case 2:u="Poor";break;case 1:u="Very Poor"}d+='<div style="margin-left:20px">'+i+"<span>"+v+'<span style="margin-left:10px">'+u+"</span></span></div>"}}),$(d).appendTo("#history-chat .messages"))}}}),b.show()}}function closeHistory(){historyGrid&&($("#history-chat").hide(),historyGrid.setSelectedRows([]),historyGrid.resetActiveCell())}function updateHistoryFilter(){historyDataView.setFilterArgs({searchString:historySearch}),historyDataView.refresh()}function initHistoryGridEvents(){if(!historyGrid){var a=new Slick.Data.GroupItemMetadataProvider;historyDataView=new Slick.Data.DataView({groupItemMetadataProvider:a}),historyGrid?historyColumns=historyGrid.getColumns():(historyColumns=storage.get("historyColumns"),historyColumns[0].formatter=renderHistoryCell,historyColumns[1].formatter=Slick.Formatters.Date),historyGrid=new Slick.Grid(".history-grid",historyDataView,historyColumns,historyOptions),historyGrid.registerPlugin(a),historyGrid.setSelectionModel(new Slick.RowSelectionModel),historyGrid.onColumnsResized.subscribe(function(){storage.set("historyColumns",historyGrid.getColumns())}),historyGrid.onSelectedRowsChanged.subscribe(function(){rows=historyGrid.getSelectedRows(),chat=historyDataView.getItem(rows),void 0!==chat&&openHistoryChat(chat)}),historyGrid.onSort.subscribe(function(a,b){var c=b.sortCols;historyDataView.sort(function(a,b){for(var d=0,e=c.length;e>d;d++){var f=c[d].sortCol.field,g=c[d].sortAsc?1:-1,h=a[f],i=b[f],j=(h==i?0:h>i?1:-1)*g;if(0!==j)return j}return 0}),historyGrid.invalidate(),historyGrid.render()}),historyDataView.onRowCountChanged.subscribe(function(a,b){historyGrid.updateRowCount(),historyGrid.render()}),historyDataView.onRowsChanged.subscribe(function(a,b){historyGrid.invalidateRows(b.rows),historyGrid.render()})}}function renderHistoryCell(a,b,c,d,e){var f="Chrome",g="",h=e.Country;c=e.UserAgent,-1!==c.indexOf("MSIE")||-1!==c.indexOf("Trident/")?f="InternetExplorer":-1!==c.indexOf("Chrome")?f="Chrome":-1!==c.indexOf("Opera")?f="Opera":-1!==c.indexOf("Safari")?f="Safari":-1!==c.indexOf("Firefox")&&(f="Firefox"),e.Username=ucwords(e.Username.toLowerCase()),e.UserAgent="./images/"+f+".png",null!==e.State&&e.State.length>0?h=null!==e.City&&e.City.length>0?e.City+", "+e.State+", "+e.Country:e.State+", "+e.Country:null!==e.City&&e.City.length>0&&(h=e.City+", "+e.Country),g='<span class="'+convertCountryIcon(e.Country)+'" style="float:left; margin: 3px 5px 3px 0; display:inline-block"></span>',e.Location=g+h;var i=parseInt(e.Rating,10),j="No Rating",k="";switch(i){case 1:j="Very Poor";break;case 2:j="Poor";break;case 3:j="Good";break;case 4:j="Very Good";break;case 5:j="Excellent"}for(var l=1;5>=l;l++){var m="",n="";i>=l&&(m="Highlight"),0===i&&(n=" disabled"),k+='<div class="sprite Rating'+m+n+'"></div>'}if(k+='<span class="rating text">'+j+"</span>",0===e.Department.length&&(e.Department="Unavailable"),e.Email.length>0){if(-1===e.Email.indexOf("mailto:")&&e.Email.length>0){var o=escapeHtml(e.Email);e.Email='<a href="mailto:'+o+'">'+o+"</a>"}}else e.Email="Unavailable";if(-1===e.CurrentPage.indexOf("href")&&e.CurrentPage.length>0){var p=escapeHtml(e.CurrentPage);e.CurrentPage='<a href="'+p+'" target="_blank">'+p+"</a>"}var q=e.Referrer,r=/^http[s]{0,1}:\/\/(?:[^.]+[\\.])*google(?:(?:.[a-z]{2,3}){1,2})[\/](?:search|url|imgres|aclk)(?:\?|.*&)q=([^&]*)/i,s=r.exec(q);null!==s&&(q=s[1].length>0?"Google Search (Keywords: "+s[1]+")":"Google Search"),e.Referrer=q;var b='<div class="cell-inner"> 	<div class="cell-left"> 		<img src="'+e.UserAgent+'"/> 	</div> 	<div class="cell-main"> 	  <h2 style="text-transform: none">'+e.Username+"</h2> 	  <span>"+e.Operator+"</span><br/> 	  <span>"+e.Department+"</span><br/> 	  <span>"+e.Hostname+"</span><br/> 	  <span>"+e.Email+"</span><br/> 	  <span>"+e.Referrer+"</span><br/> 	  <span>"+e.CurrentPage+"</span><br/> 	  <span>"+e.Location+"</span><br/> 	  <span>"+k+"</span><br/> 	</div> </div>";return b}function initHistoryGrid(a){function b(a,b){var c=b.searchString.toLowerCase();return""!==c&&-1==a.Username.toLowerCase().indexOf(c)&&-1==a.Email.toLowerCase().indexOf(c)&&-1==a.Department.toLowerCase().indexOf(c)&&-1==a.Operator.toLowerCase().indexOf(c)&&-1==a.Hostname.toLowerCase().indexOf(c)?!1:!0}var c,d="",e=$(".history.container .menu .title .text");if(void 0===a){a=storage.get("history-date");var f=$(".history.container #calendar");f.find("td").removeClass("selected-date"),f.find('td[id="'+a+'"]').addClass("selected-date")}if(a=a.length>0?new moment(a,"YYYY-MM-DD HH:mm:ss"):new moment,e.text(a.format("dddd, MMMM D YYYY")),a=a.year()+"-"+zeroFill(a.month()+1,2)+"-"+zeroFill(a.date(),2),session.length>0){var g={StartDate:a,EndDate:a,Timezone:getUTCOffset(),Transcripts:1,ID:0};initHistoryGridEvents(),apiRequest({url:apiEndpoint.history,data:g,success:function(a){if(void 0!==a.ChatHistory){c=[],$.each(a.ChatHistory,function(a,b){c.push(b.Visitor)}),c=c.reverse(),historyDataView.beginUpdate(),historyDataView.setItems(c,"Session"),historyDataView.setFilterArgs({searchString:d}),historyDataView.setFilter(b),historyDataView.endUpdate();var e="",f=c.length;f>1?e=" - "+c.length+" chats":f>0&&(e=" - "+c.length+" chat"),f>0?($(".history-empty").hide(),$(".history-grid").show()):$(".history-empty, .history-grid").show(),$(".username-column-header .slick-column-name").text("Chat History"+e)}}})}}function sliderIndex(){var a=$(".slider.right"),b=0;return a.length>0&&$.each(a,function(a,c){var d=$(c),e=parseInt(d.css("z-index"),10);d.width()>0&&e>b&&(b=e)}),b}function openResponses(a){var b=$("#responses");$(".chat-stack, .history.container, .statistics.container, .accounts.slider, .settings.container").hide(),b.show(),openResponsesCallback(b,a)}function closeResponses(){{var a=$("#responses");a.width()}a.find(".search input").val(""),filterResponses(),a.animate({width:0,opacity:0},250,function(){a.hide()}),switchPreviousMenu()}function lastUpdatedAccount(a){var b=null;return $.each(a,function(a,c){var d=new moment(c.Updated,"YYYY-MM-DD HH:mm:ss").toDate();(!b||d>b)&&(b=d)}),b}function storeAccounts(a){var b=[];$.each(a,function(a,c){void 0!==c.Image&&c.Image.indexOf("https://")<0&&(c.Image=""),b.push(c)}),storage.set("accounts",b)}function showAccountsGrid(a,b){var c=storage.get("accounts"),d=lastUpdatedAccount(c);b=void 0!==b?b:!1,storeAccounts(a),$(document).trigger("LiveHelp.AccountsUpdated",[a]);var e=!1;$.each(c,function(b,c){var d=parseInt(c.ID,10),f=!1;$.each(a,function(a,b){var c=parseInt(b.ID,10);d===c&&(f=!0)}),f||(e=!0)});var f=lastUpdatedAccount(a);f>d||e||c.length!=a.length?updateAccountsGrid(a,b):(updateAccountsGrid(a,!0),$(document).trigger("LiveHelp.AccountsCompleted"))}function renderAccountCell(a,b,c,d,e){var f=e,g=parseInt(f.Status,10);if(!isNaN(g)){switch(g){case 0:g="Offline";break;case 1:g="Online";break;case 2:g="Be Right Back";break;case 3:g="Away"}f.Status=g}f.Mobile="none",f.Devices.length>0&&(f.Mobile="inline-block");var h="none"!==f.Disabled&&"0"!==f.Disabled?!0:!1;h&&0===f.Devices.length?f.Disabled="inline-block; background:url('images/Lock.png') no-repeat; ":f.Disabled="none";var i=window.devicePixelRatio>1?600:300,j=operatorImage(f.ID,f.Email,i);void 0!==f.Image&&f.Image.indexOf("https://")>-1&&(j=f.Image.replace(".png","-100px.png"));var b='<div class="cell-inner" data-id="'+f.ID+'"> 	<div class="cell-left"> 		<div class="image" style="background: url('+j+') no-repeat; background-size: 60px auto; width: 60px; height: 60px"></div> 	</div> 	<div class="cell-main"> 		<div class="cell-heading name">'+f.Firstname+" "+f.Lastname+'</div> 		<span class="cell-details department">'+f.Department+'</span> 		<span class="cell-details status">'+f.Status+'</span> 		<span class="disabled" title="Account Disabled" style="width:22px; height:22px; display:inline-block; position:absolute; bottom:10px; right:30px; opacity:0.3; display:'+f.Disabled+'"></span> 		<span class="sprite Smartphone" title="Logged in with Mobile App" style="position:absolute; bottom:10px; right:25px; opacity:0.5; display:'+f.Mobile+'"></span> 	</div> </div>';return b}function initAccountsGridEvents(){if(void 0===accountsGrid){var a=new Slick.Data.GroupItemMetadataProvider;accountsDataView=new Slick.Data.DataView({groupItemMetadataProvider:a}),accountsGrid=new Slick.Grid(".accounts-grid",accountsDataView,accountsColumns,accountsOptions),accountsGrid.registerPlugin(a),accountsGrid.setSelectionModel(new Slick.RowSelectionModel),accountsGrid.onSelectedRowsChanged.subscribe(function(){if(rows=accountsGrid.getSelectedRows(),account=accountsDataView.getItem(rows),void 0!==account){var a=storage.get("accounts");$.each(a,function(a,b){parseInt(account.ID,10)===parseInt(b.ID,10)&&(account=b)}),showAccount(account),accountsGrid.setSelectedRows([]),accountsGrid.resetActiveCell()}}),accountsGrid.onSort.subscribe(function(a,b){var c=b.sortCols;accountsDataView.sort(function(a,b){for(var d=0,e=c.length;e>d;d++){var f=c[d].sortCol.field,g=c[d].sortAsc?1:-1,h=a[f],i=b[f],j=(h==i?0:h>i?1:-1)*g;if(0!==j)return j}return 0}),accountsGrid.invalidate(),accountsGrid.render()}),accountsDataView.onRowCountChanged.subscribe(function(a,b){accountsGrid.updateRowCount(),accountsGrid.render()}),accountsDataView.onRowsChanged.subscribe(function(a,b){accountsGrid.invalidateRows(b.rows),accountsGrid.render()})}}function updateAccountsGrid(a,b){function c(){$("#account-details .details").css("background","none"),accountsDataView.beginUpdate(),accountsDataView.setItems(a,"ID"),accountsDataView.endUpdate()}b=void 0!==b?b:!1,initAccountsGridEvents();var d=[];if(b)c(),$(document).trigger("LiveHelp.AccountsCompleted");else if(d.length!=a.length){var e=window.devicePixelRatio>1?600:300;$.each(a,function(f,g){void 0===g.Image?(g.Image=operatorImage(g.ID,g.Email,e),$("<img />").load(function(){d.push(g.ID),d.length==a.length&&(c(),$(document).trigger("LiveHelp.AccountsOpenLoaded"))}).attr("src",g.Image)):b=!0}),b&&(c(),$(document).trigger("LiveHelp.AccountsOpenLoaded"))}else $(document).trigger("LiveHelp.AccountsCompleted")}function initAccountsGrid(a){if(session.length>0){{var b=(new Date).toString("yyyy-MM-dd HH:mm:ss"),c={Cached:b},d=storage.get("accounts");lastUpdatedAccount(d)}if(d.length>0&&"none"!=$("#account-details").css("display")&&!accountsLoaded)void 0!==a&&a===!0&&(updateAccountsGrid(d,!0),accountsLoaded=!0);else{var e=$(".accounts-grid .cell-inner");$.each(e,function(a,b){var c=$(b).data("id");b=$(b),$.each(accounts,function(a,d){var e="Offline";if(c===parseInt(d.ID,10)){switch(parseInt(d.Status,10)){case 1:e="Online";break;case 2:e="Be Right Back";break;case 3:e="Away"}return b.find(".cell-details.name").text(d.Firstname+" "+d.Lastname),b.find(".cell-details.department").text(d.Department),void b.find(".cell-details.status").text(e)}})})}$(document).trigger("LiveHelp.AccountsOpened"),apiRequest({url:apiEndpoint.operators,data:c,success:function(b){void 0!==b.Operators&&void 0!==b.Operators.Operator&&(accounts=b.Operators.Operator,storeAccounts(accounts),$(document).trigger("LiveHelp.AccountsUpdated",[accounts]),void 0!==a&&a===!0?showAccountsGrid(accounts):$(document).trigger("LiveHelp.AccountsCompleted"))}})}}function closeAccountDetails(){var a=$("#account-details"),b=a.find(".account.button-toolbar.save"),c=a.find(".account.button-toolbar.edit"),d=a.find(".header:not(.account)").text();if(height=b.height(),e=a.find(".details #AccountID").val(),e.length>0){var e=parseInt(e,10),f=_.find(unsavedImages,function(a){return a.id===e});void 0!==f&&resetAccountImage(f)}return a.removeClass("edit add"),"Add Account"===d||c.filter(":visible").length>0?void showAccounts():(a.find(".tagsinput .tag").addClass("disabled"),a.find(".tagsinput-add-container").hide(),a.find(".LiveHelpInput, .password").hide(),a.find(".value, .account.button-toolbar.edit, .label.twofactor").fadeIn(),b.hide().css("bottom",-height+"px"),void c.fadeIn().animate({bottom:"15px"},250,"easeInOutBack"))}function validateField(a,b){var c=a instanceof $?a.val():$(a).val();return""===$.trim(c)?($(b).removeClass("TickSmall").addClass("CrossSmall").fadeIn(250),!1):($(b).removeClass("CrossSmall").addClass("TickSmall").fadeIn(250),!0)}function validateUsername(a,b){var c=a instanceof $?a.val():$(a).val(),d=storage.get("accounts"),e=!1,f=$("#AccountID").val();if(f=f.length>0?parseInt(f,10):0,$.each(d,function(a,b){b.ID=parseInt(b.ID,10),(b.Username===c&&0===f||b.Username===c&&f>0&&f!==b.ID)&&(e=!0)}),""===$.trim(c)||e){var g=$(b);return e?g.attr("title","Username Already In Use"):g.attr("title","Username Required"),g.removeClass("TickSmall").addClass("CrossSmall").fadeIn(250),!1}return $(b).removeClass("CrossSmall").addClass("TickSmall").fadeIn(250),!0}function validateEmail(a,b,c){var d=a instanceof $?a.val():$(a).val(),e=storage.get("accounts"),f=!1,g=!1,h=$("#AccountID").val();if(g=/^[\-!#$%&'*+\\.\/0-9=?A-Z\^_`a-z{|}~]+@[\-!#$%&'*+\\\/0-9=?A-Z\^_`a-z{|}~]+\.[\-!#$%&'*+\\.\/0-9=?A-Z\^_`a-z{|}~]+$/i.test(d)?!0:!1,c||(h=h.length>0?parseInt(h,10):0,$.each(e,function(a,b){b.ID=parseInt(b.ID,10),(b.Email===d&&0===h||b.Email===d&&h>0&&h!==b.ID)&&(f=!0)})),g===!1||!c&&(c||f))return $(b).removeClass("TickSmall").addClass("CrossSmall").fadeIn(250),!1;var i=$(b);return c||f?i.attr("title","Email Required"):i.attr("title","Email Already In Use"),i.removeClass("CrossSmall").addClass("TickSmall").fadeIn(250),!0}function validatePassword(a,b,c){var d=a instanceof $?a.val():$(a).val();return""===$.trim(d)||d!==b?($(c).removeClass("TickSmall").addClass("CrossSmall").fadeIn(250),!1):($(c).removeClass("CrossSmall").addClass("TickSmall").fadeIn(250),!0)}function saveAccount(){function a(a,d){if(null!==a.Operators&&void 0!==a.Operators&&void 0!==a.Operators.Operator){var e=!1;if(d){var f=_.find(a.Operators.Operator,function(a){return operator.id===parseInt(a.ID,10)});e=_.find(accounts,function(a){return operator.id===parseInt(a.ID,10)}),void 0!==e&&void 0!==f&&(f.Image=e.Image),accounts=a.Operators.Operator,storage.set("accounts",accounts)}else accounts=a.Operators.Operator,storeAccounts(accounts);$(document).trigger("LiveHelp.AccountsUpdated",[accounts]);var g=!1;if($.each(b,function(a,b){var c=parseInt(b.ID,10),d=!1;$.each(accounts,function(a,b){var e=parseInt(b.ID,10);c===e&&(d=!0)}),d||(g=!0)}),!d){var h=lastUpdatedAccount(accounts);h>c||g?updateAccountsGrid(accounts,!0):void 0!==accountsGrid&&(accountsGrid.invalidate(),$(document).trigger("LiveHelp.AccountsCompleted"))}e!==!1&&$.each(accounts,function(a,b){return b.ID===e.ID?(showAccount(b),!1):void 0}),closeAccountDetails(),$(document).trigger("LiveHelp.AccountSaveCompleted");var i=$(".account.dialog");i.animate({bottom:-i.height()},250,"easeInOutBack",function(){$(this).hide()})}else{var j=void 0!==a.error?a.error:!1;accountSaveErrorCallback(j)}}var b=storage.get("accounts"),c=lastUpdatedAccount(b),d=$("#AccountStatusEnable").is(":checked")?0:-1,e={ID:$("#AccountID").val(),User:$("#AccountUsername").val(),Firstname:$("#AccountFirstname").val(),Lastname:$("#AccountLastname").val(),Email:$("#AccountEmail").val(),Department:$("#AccountDepartment").val(),Privilege:$("#AccountAccessLevel").val(),NewPassword:$("#AccountPassword").val(),Disabled:d,Cached:new moment(c.toString(),"YYYY-MM-DD HH:mm:ss").toDate()};validateAccount(!1),$("#account-details").find(".InputError.CrossSmall").length>0||(accountSavingCallback(),void 0!==accountFiles?(unsavedImages=_.reject(unsavedImages,function(a){return a.id===parseInt(e.ID,10)}),$("#account-upload").fileupload("send",{headers:{Authorization:'Token signature="'+session+'", version="5"',Accept:"application/json"},formData:e,files:accountFiles}).success(function(b,c,d){a(b,!0)}).error(function(a,b,c){var d=void 0!==data.error?data.error:!1;accountSaveErrorCallback(d)}),accountFiles=void 0):apiRequest({url:apiEndpoint.operators,data:e,success:function(b){a(b,!1)}}))}function showAddAccount(){$(".accounts-grid").fadeOut();var a=$("#account-details"),b=a.find(".account.button-toolbar.save"),c=b.height(),d=a.find(".account.button-toolbar.edit, .account.button-toolbar.add");$("#account-details").addClass("add"),a.find(".header").text("Add Account"),a.find(".back, .back-background").fadeIn(),a.find(".details").css("bottom","25px"),a.find(".value, .label.devices").hide(),a.find("input, select, .password").val("").fadeIn(),a.find(".scroll, .account.button-toolbar.save, .LiveHelpInput, #account-upload, .upload, #account-dropzone").fadeIn(),a.find("#AccountStatusEnable").attr("checked","checked"),a.find(".InputError").removeClass("TickSmall CrossSmall"),d.css("bottom",-c+"px").hide(),b.fadeIn().animate({bottom:"15px"},250,"easeInOutBack"),$(document).trigger("LiveHelp.ShowAccountLoaded")}function validateAccount(a){var b=$("#account-details .scroll"),c=b.find("input, select, .password").filter(":not(#AccountUsername, #AccountEmail, #AccountPasswordConfirm)");a||(c=b.find("input, select").filter(":not(#AccountUsername, #AccountEmail, #AccountPasswordConfirm, #AccountPassword)")),$.each(c,function(a,b){var c=$(b).attr("id");validateField($(b),"#"+c+"Error")});var d=$("#AccountUsername"),e=d.attr("id");validateUsername(d,"#"+e+"Error"),d=$("#AccountEmail"),e=d.attr("id"),validateEmail(d,"#"+e+"Error",!1);var f=$("#AccountPassword"),g=$("#AccountPasswordConfirm");(a||0!==f.val().length||0!==g.val().length)&&(e=g.attr("id"),validatePassword(g,f.val(),"#"+e+"Error"))}function updateAccountImage(a,b,c){var d=_.find(unsavedImages,function(b){return b.id===a}),e=$("#account-upload"),f=e.find(".image");if(c&&void 0===d){var g=f.css("background-image"),h=g.match(/\b(https?|ftp|file):\/\/[\-A-Z0-9+&@#\/%?=~_|$!:,.;]*[A-Z0-9+&@#\/%=~_|$]/gi);null!==h&&h.length>0&&(h=h[0],unsavedImages.push({id:a,image:h}))}var i=_.find(accounts,function(b){return a===parseInt(b.ID,10)});if(void 0!==i&&(i.Image=b,storage.set("accounts",accounts)),f.css({background:"url("+b+") no-repeat",opacity:1,width:"100px",height:"100px",padding:0,"background-size":"100px 100px"}),e.css({border:"none","border-radius":0,background:"transparent"}).fadeIn(),$(".upload").hide(),c){var j=$(".operators.list .visitor[data-id="+a+"] .image");j.length>0&&j.css({background:"url("+b+") no-repeat","background-size":"40px 40px"});var k=$(".accounts-grid .slick-row .cell-inner[data-id="+a+"] .image");k.length>0&&k.css({background:"url("+b+") no-repeat","background-size":"60px 60px"}),operator.id===a&&$(".operator .photo").css({background:"url("+b+") no-repeat","background-size":"50px 50px"})}}function resetAccountImage(a){var b=$(".operators.list .visitor[data-id="+a.id+"] .image"),c=a.image,d=_.find(accounts,function(a){return id===parseInt(a.ID,10)});void 0!==d&&(d.Image=c,storage.set("accounts",accounts)),$("#account-upload .image").css({background:"url("+c+") no-repeat","background-size":"100px 100px"}),b.length>0&&b.css({background:"url("+c+") no-repeat","background-size":"40px 40px"});var e=$(".accounts-grid .slick-row .cell-inner[data-id="+a.id+"] .image");e.length>0&&e.css({background:"url("+c+") no-repeat","background-size":"60px 60px"}),operator.id===a.id&&$(".operator .photo").css({background:"url("+c+") no-repeat","background-size":"50px 50px"})}function addAccount(){function a(a){if(void 0!==a.Operators&&void 0!==a.Operators.Operator){var b=a.Operators.Operator;showAccountsGrid(b),showAccounts();var c=0,e="";$.each(b,function(a,b){return b.Username===d.User?(c=parseInt(b.ID,10),e=b.Email,!1):void 0}),c>0&&$('#account-details .cell-inner[data-id="'+c+'"] img').attr("src",operatorImage(c,e,60))}else accountAddErrorCallback();$(document).trigger("LiveHelp.AccountAddCompleted");var f=$(".account.dialog");f.animate({bottom:-f.height()},250,"easeInOutBack",function(){$(this).hide()})}var b=$("#account-details"),c=b.find("#AccountStatusEnable").is(":checked")?0:-1,d={User:b.find("#AccountUsername").val(),Firstname:b.find("#AccountFirstname").val(),Lastname:b.find("#AccountLastname").val(),Email:b.find("#AccountEmail").val(),Department:b.find("#AccountDepartment").val(),NewPassword:b.find("#AccountPassword").val(),Privilege:b.find("#AccountAccessLevel").val(),Disabled:c};validateAccount(!0),b.find(".InputError.CrossSmall").length>0||(accountAddingCallback(),void 0!==accountFiles?($("#account-upload").fileupload("send",{headers:{Authorization:'Token signature="'+session+'", version="5"',Accept:"application/json"},formData:d,files:accountFiles}).success(function(b,c,d){a(b)}).error(function(a,b,c){accountAddErrorCallback()}),accountFiles=void 0):apiRequest({url:apiEndpoint.operators,data:d,success:function(b){a(b)},error:function(a,b,c){accountAddErrorCallback()}}))}function accountDeleted(a){if(null!==a.Operators&&void 0!==a.Operators&&void 0!==a.Operators.Operator){var b=a.Operators.Operator;showAccountsGrid(b,!0),showAccounts();var c=$("#account-details .confirm-delete.dialog");c.delay(2e3).hide().animate({bottom:-90},250,"easeInOutBack")}else accountDeletedErrorCallback()}function deleteAccount(){var a={ID:$("#AccountID").val()};apiRequest({url:apiEndpoint.operators,data:a,success:accountDeletedCallback,error:accountDeletedErrorCallback})}function refreshAccounts(a){switch(a){case"Online":a=1;break;case"BRB":a=2;break;case"Away":a=3;break;default:a=0}$.each(accounts,function(b,c){operator.id===parseInt(c.ID,10)&&(c.Status=a)})}function showAccount(a){var b=$(".accounts-grid .slick-viewport");b.is(":visible")&&(accountsScrollTop=b.scrollTop()),$(".accounts-grid").fadeOut(),updateDepartment(!1,!1,!1),$(document).trigger("LiveHelp.AccountLoaded",a);var c=$("#account-details .details .btn-group"),d="Offline";switch(operator.access>=2?c.hide():c.css("display","inline-block"),a.status=parseInt(a.Status,10),a.status){case 1:d="Online";break;case 2:d="Be Right Back";break;case 3:d="Away"}c.find(".status").text(d),1!==a.status?c.find(".btn").addClass("disabled"):c.find(".btn").removeClass("disabled"),c.find(".dropdown-menu.statusmode li a").on("click",function(){var a=$(".account.dialog");a.css("height","90px"),a.find(".progressring").show(),a.find(".title").text("Updating Operator Status Mode"),a.find(".description").text("One moment while the operator status mode is updated."),a.show().animate({bottom:0},250,"easeInOutBack");var b=$("#account-details .details #AccountID").val(),c=$(this).attr("class");updateUsers(c,b,function(){refreshAccounts(c),c="BRB"===c?"Be Right Back":c,$("#account-details .dropdown-toggle .status").text(c),a.delay(1e3).animate({bottom:-90},250,"easeInOutBack")})}),storage.set("account",a);var e=$("#account-details");e.find(".details").css("background","none"),e.find(".header").hide(),e.find(".header.account").text(a.Firstname+" "+a.Lastname).show(),e.find(".back, .back-background").fadeIn();var f=window.devicePixelRatio>1?600:300,g=operatorImage(a.ID,a.Email,f);void 0!==a.Image&&(a.Image.indexOf("https://")>-1||a.Image.indexOf("data:image/")>-1)&&(g=a.Image),updateAccountImage(a.ID,g,!1),e.find("#AccountID").val(a.ID),e.find(".username.value").text(a.Username),e.find("#AccountUsername").val(a.Username),e.find(".firstname.value").text(a.Firstname),e.find("#AccountFirstname").val(a.Firstname),e.find(".lastname.value").text(a.Lastname),e.find("#AccountLastname").val(a.Lastname),e.find(".email.value").text(a.Email),e.find("#AccountEmail").val(a.Email);var h=e.find(".department.value .tagsinput"),i=a.Department.split(";");h.find(".tag").remove(),$.each(i,function(a,b){b.length>0&&(b=$.trim(b),$('<span class="tag disabled" data-department="'+b+'"><span>'+b+'</span><a class="tagsinput-remove-link"></a></span>').prependTo(h))}),h.find(".tag").length>0?(e.find(".department.value .none").hide(),h.show()):(h.hide(),e.find(".department.value .none").show()),e.find("#AccountDepartment").val(a.Department),e.find(".tagsinput .tagsinput-add-container").hide();var j=parseInt(a.Privilege,10);e.find("#AccountAccessLevel").val(0>j?0:j),j=convertAccessLevel(a.Privilege),e.find(".accesslevel.value").text(j);var k=parseInt(a.Disabled,10),l="Disabled";0===k?(e.find("#AccountStatusEnable").attr("checked","checked"),l="Enabled"):(e.find("#AccountStatusDisable").attr("checked","checked"),l="Disabled"),e.find(".accountstatus.value").text(l);var m="";void 0!==a.Devices&&$.each(a.Devices,function(a,b){m+='<div class="device value">'+b.Device+" - "+b.OS+"</div>"}),m.length>0?(e.find(".devices.value").html(m),e.find(".devices.label").show()):(e.find(".devices.value").html(""),e.find(".devices.label").hide()),e.find(".details").css("bottom","25px"),e.find(".value").show();var n=e.find(".twofactor.label, .twofactor.value");if(void 0!==a.TwoFactor&&n.length>0){var d="Disabled",c="Enable";a.TwoFactor!==!1&&(d="Enabled",c="Disable"),e.find(".twofactor.value .status").text(d),e.find(".twofactor.value .btn").text(c),e.find(".twofactor.label").css("display","inline"),e.find(".twofactor.value").show()}else n.hide();if(e.find(".LiveHelpInput, .password, .account.button-toolbar.save").hide(),e.find(".scroll").fadeIn(),parseInt(a.ID,10)===operator.id||operator.access<2){var o=e.find(".account.button-toolbar.edit"),p=o.height(),q=e.find(".account.button-toolbar.add, .account.button-toolbar.save");q.css("bottom",-p+"px").hide(),o.fadeIn().animate({bottom:"15px"},250,"easeInOutBack")}}function updateDepartment(a,b,c){var d=$("#account-details .departments.dialog"),e=d.find(".departments.list"),f={};void 0!==a&&a!==!1&&(f={Data:$.toJSON(a)}),e.find(".department").length>0&&parseInt(d.css("bottom"),10)<0&&void 0===c&&d.show().animate({bottom:0},250,"easeInOutBack"),apiRequest({url:apiEndpoint.departments,data:f,success:function(a){void 0!==a&&(e.find(".department").remove(),$.each(a,function(a,b){$('<div class="department item" data-id="'+b.id+'" data-status="'+b.hidden+'"><div class="name">'+b.name+'</div><div class="edit button sprite Edit" title="Edit Department"></div><div class="email">'+b.email+"</div></div>").appendTo(e)})),b&&b()}})}function showAccounts(){var a=$("#account-details"),b=a.find(".account.button-toolbar.save, .account.button-toolbar.edit"),c=a.find(".account.button-toolbar.add"),d=a.find(".confirm-delete.dialog"),e=a.find("#account-upload"),f=$(".departments.dialog"),g=b.height();a.removeClass("edit add"),a.find(".header.account").hide(),a.find(".header:not(.account)").text("Add / Edit Accounts").show(),a.find(".scroll").fadeOut(),a.find("#account-image, .upload, #account-dropzone").fadeOut(),a.find(".back, .back-background").fadeOut(),a.find(".details").css("bottom",0),e.hide().find(".image").css({background:"none",opacity:.5,width:"100px",height:"100px",padding:"20px"}),e.css({border:"2px dashed #CCC","border-radius":"100px",background:"#fafafa"}),b.fadeOut().css("bottom",-g+"px"),f.hide().animate({bottom:-f.height()},250,"easeInOutBack");var h=$(".twofactor-dialog");h.length>0&&parseInt(h.css("bottom"),10)>=0&&h.animate({bottom:-h.height()},250,"easeInOutBack"),operator.access>=2?c.fadeOut():c.fadeIn().animate({bottom:"15px"},250,"easeInOutBack"),d.animate({bottom:"-90px"},250,"easeInOutBack"),$(".accounts-grid").fadeIn(),$(".accounts-grid .slick-viewport").scrollTop(accountsScrollTop),$("#account-details .details .btn-group").hide(),a.filter(":visible").length>0&&(storage.set("account",null),initAccountsGrid(!0))}function openAccounts(){var a=$("#account-details"),b=a.find(".account.button-toolbar.add");operator.access>=2&&b.hide(),openAccountsCallback(),a.show(),a.css("z-index",sliderIndex()+100),a.css({width:"calc(100% - 300px)",opacity:1});var a=storage.get("account"),c=storage.get("accounts");return null!==a?($.each(c,function(b,c){a.ID===c.ID&&(a=c)}),void showAccount(a)):void initAccountsGrid(!0)}function closeAccount(){{var a=$("#account-details");a.width()}closeAccountCallback(a),switchPreviousMenu()}function addOperator(a,b,c,d,e,f,g){var h={},i=$(".operators.list .visitor[data-id="+a+"]").length;if(a!==operator.id&!i){var j=!1;$.each(activechats,function(b,c){return a===c.id&&c.type>0?(j=!0,!1):void 0}),f||(void 0===accounts&&(accounts=storage.get("accounts")),$.each(accounts,function(b,c){return parseInt(c.ID,10)===a?(f=c,!1):void 0}));var k=operatorImage(a,f.Email,40);if((1===e||2===e||3===e)&&void 0===g||void 0!==g){if(f!==!1&&void 0!==f.Image&&f.Image.indexOf("https://")>-1)k=f.Image.replace(".png","-100px.png");else{var l=server.length>0?protocol+server+defaultUserImage:window.location.protocol+"//"+window.location.host+path.replace(path.substring(path.indexOf(directoryPath+"/admin/")),defaultUserImage),m=CryptoJS.MD5(f.Email);k="https://secure.gravatar.com/avatar/"+m+"?s=100&r=g&d="+l}var n="offline";switch(e){case 1:n="online";break;case 2:n="brb";break;case 3:n="away"}return h.id=a,h.firstname=f.Firstname,h.statusmode=n,h.image=k,h.name=b,h.department=c,h.access=d,h}}return!1}function sortOperators(){var a={online:1,brb:2,away:3,offline:4};$(".operators.list").find(".visitor").sort(function(b,c){return a[$(b).data("status")]-a[$(c).data("status")]}).each(function(a,b){$(b).parent().append(b)});var b=["online","brb","away","offline"];$.each(b,function(a,b){$('.operators.list .visitor[data-status="'+b+'"]').sort(function(a,b){return $(a).data("name").localeCompare($(b).data("name"))}).each(function(a,b){$(b).parent().append(b)})})}function updateSelectedChat(){var a=$(".chat-list");if(!a.find(".visitor.selected").length){var b=storage.get("selected-chat"),c=storage.get("route"),d=c.indexOf("setting")>-1||"accounts"===c||"responses"===c;if(!d){var e=!1,f=!1;void 0!==b?e=a.find(".visitor[data-id="+b.id+"][data-operator="+b.operator+"]"):(e=a.find(".channel.everyone"),f=!0),e!==!1&&e.length>0&&(e.addClass("selected"),e.click(),f||chattingVisitorClickCallback.call(e,{},void 0,void 0,!0))}}}function updateUser(a,b){function c(a,b,c,d){chatSections.none.enabled||chatSections.none.height||"Staff"===b&&(o=a.data("height"),d=$("."+c+".list").find(".visitor").length*d,k=$(".chat-list-heading."+c),d>0&&d!==o?k.show():k.hide())}{var d="",e=!1,f=!1,g="",h=window.location.pathname,i=null,j=$(".chatting.list"),k=!1,l=0,m=!1,n=$("#chatstotal"),o=0;server.length>0?protocol+server+defaultUserImage:window.location.protocol+"//"+window.location.host+h.replace(h.substring(h.indexOf(directoryPath+"/admin/")),defaultUserImage)}"Online"===a?(i=chatSections.other.element,updateTotal(n,b.length)):"Pending"===a||"Transferred"===a?(i=chatSections.pending.element,m=!0):"Staff"===a&&(i=chatSections.operators.element,f=!0),null!==i&&(b.length>0?(chatSections.none.enabled||"Staff"===a||i.parent().find(".chat-list-heading.pending").show(),$.each(b,function(b,c){if(d="","Online"===a){var j=parseInt(c.Active,10);i=j===operator.id||void 0!==settings.LoginDetails&&!settings.LoginDetails.Enabled&&j!==operator.id?chatSections.chatting.element:chatSections.other.element}if(g=CryptoJS.MD5(c.Email),e=!1,$.each(i.find(".visitor"),function(b,d){var f="number"==typeof c.ID?parseInt(c.ID,10):c.ID;if(f!==$(d).data("id"));else if(e=!0,"Online"===a){var g=parseInt(c.Messages,10),h=$(d).data("messages"),i=g-h,j=$(".chat-stack"),k=j.position().top,l=j.find(".chat[data-id="+f+"]").length,m=0>k||0===l?!1:!0,n=_.find(viewed,function(a){return a.id===f&&0==a.operator});void 0!==n&&(n.message=0,void 0!==n.count&&(i=g>n.count?g-n.count:0),storage.set("viewed",viewed)),i>0&&!m&&void 0!==n&&void 0!==n.count&&n.count<g&&$(d).find(".message-alert").text(i).fadeIn()}}),!e){var k=ucwords(c.Name.toLowerCase());if(f){var n=storage.get("accounts"),p=c.Department,q=void 0!==c.Access?convertAccessLevel(c.Access):"",r=parseInt(c.Status,10),s="number"==typeof c.ID?parseInt(c.ID,10):c.ID,t=!1;void 0!==c.Firstname&&0===c.Firstname.length?$.each(n,function(a,b){return parseInt(b.ID,10)===parseInt(c.ID,10)?(t=b,k=b.Firstname,p=b.Department,void(q=convertAccessLevel(b.Privilege))):void 0}):k=c.Firstname;var u=addOperator(s,k,p,q,r,t);u&&(d=App.templates.operator(u))}else{var v=(parseInt(c.Messages,10),$(".chat-stack")),w=window.devicePixelRatio>1?192:96,x=server.length>0?protocol+server+defaultUserImage:encodeURIComponent(window.location.protocol+"//"+window.location.host+h.replace(h.substring(h.indexOf(directoryPath+"admin/")),directoryPath+"images/UserSmall.png"));

if(c.id="number"==typeof c.ID?parseInt(c.ID,10):c.ID,c.name=k,c.department=c.Department,c.server=c.Server,c.hash=c.Hash,c.image="https://secure.gravatar.com/avatar/"+CryptoJS.MD5(c.Email).toString()+"?s="+w+"&r=g&d="+x,d=App.templates.user(c),v.length&&!v.find(".chat[data-id="+c.id+"][data-operator=false]").length){var y=App.templates.chat({id:c.id,styles:"chat",operator:!1}),z=$(y).prependTo(v);z.find(".scroll").on("scroll",debouncedSaveScroll),"undefined"!=typeof addEmailAPIRequest&&addEmailAPIRequest(z,c.Email,k,c.image)}var A=storage.get("html5-notifications");if(e=!1,$.each(notifications,function(a,b){return b.id===s?(e=!0,!1):void 0}),"Pending"===a||"Transferred"===a){if(!e&&A&&checkHTML5NotificationsPermission()){var B=a+" Chat Request",C=k+" is waiting to chat";c.Department.length>0&&(C+=" ("+c.Department+")");var D=!1;void 0!==window.webkitNotifications?D=window.webkitNotifications.createNotification(notificationIcon,B,C):"Notification"in window&&(D=new Notification(B,{icon:notificationIcon,body:C})),D!==!1&&(notifications.push({id:s,section:a,notification:D}),D.onclick=function(a){var b=0;$.each(notifications,function(a,c){b=c.id,b>0&&acceptChat(b)})},"function"==typeof D.show&&D.show())}}else"Online"===a&&$.each(notifications,function(a,b){return b.id===s?(b.notification.cancel&&b.notification.cancel(),b.notification.close&&b.notification.close(),!1):void 0})}m&&void 0!==pendingSound&&pendingSound.play()}if(d.length>0){i.find(".no-visitor").hide();var E=!1;E=chatsLoaded?$(d).prependTo(i):$(d).appendTo(i);var F=E.find(".dropdown-toggle.options"),G=E.find(".dropdown-menu.options");F.dropdown(),F.on("click",function(){var a=F.offset().top+F.outerHeight(),b=$(".chatting .visitor");G.css("top",a+"px"),G.css("left",F.offset().left+"px"),G.find(".EmailChatOffline").text("Email Chat - "+settings.Email),$.each(b,function(a,b){var c=$(this).data("user").Email,d=$(this).find(".EmailChatVisitor");c.length>0?d.text("Email Chat - "+c).data("email",c).show():d.hide()})}),G.find(".Close").click(function(){closeChat()}),G.find(".Block").click(function(){blockChat()}),G.find(".EmailChatOffline").click(function(){var a=$(this).closest(".visitor").data("user").ID;emailChat(a,"")}),G.find(".EmailChatVisitor").click(function(){var a=$(this).closest(".visitor").data("user").ID;emailChat(a,$(this).data("email"))});var H=E.find(".image");$("<img/>").attr("src",c.image).load(function(){$(this).remove()}).error(function(){$(this).remove(),H.css("background-image","url("+x+")")}),E!==!1&&$(E).data("user",c)}l=i.find(".visitor").length*sectionHeight(i),o=i.data("height"),l>0&&l!==o&&(i.is(".operators")&&(l+=30),i.is(":hidden")&&i.show(),i.data("height",l),i.animate({height:l},250,"easeOutBack"))}),c(i,a,"operators",chatSections.operators.height),c(i,a,"other-chatting",chatSections.other.height),l=j.find(".visitor").length*chatSections.chatting.height,o=j.data("height"),k=$(".chat-list-heading.chatting"),l>0&&l!==o&&(j.data("height",l),j.height()>0?(j.animate({height:l},250,"easeOutBack"),k.show()):k.hide())):("Pending"!=a&&"Transferred"!=a&&(clearUsers(i),"Online"!==a||j.find(".visitor[data-id=-1]").length||clearUsers(j)),("Pending"===a||"Transferred"===a)&&$.each(notifications,function(b,c){c.section===a&&(c.notification.cancel&&c.notification.cancel(),c.notification.close&&c.notification.close())}))),chatsLoaded=!0}function sectionHeight(a){var b=74;return a.is(".chatting")?b=chatSections.chatting.height:a.is(".other-chatting")?b=chatSections.other.height:a.is(".pending")?b=chatSections.pending.height:a.is(".operators")&&(b=chatSections.operators.height),b}function clearUsers(a){var b=sectionHeight(a),c=a.attr("id"),d=$(".chat-list-heading."+c);b>0?(a.find(".visitor").remove(),chatSections.none.enabled?(a.find(".no-visitor").show(),a.height(chatSections.none.height),a.data("height",chatSections.none.height)):(a.is(".chatting")&&!chatSections.none.enabled&&a.parent().find(".chat-list-heading.pending").hide(),a.find(".no-visitor").hide(),a.height(0),a.data("height",0),d.hide())):a.is(":visible")&&a.hide()}function removeUser(a,b){b.remove();var c=sectionHeight(a);c=a.find(".visitor").length*c,c>0&&(a.height()>0&&a.animate({height:c},250,"easeOutBack"),a.data("height",c))}function updateUsers(a,b,c){if(session.length>0){var d={};void 0!==a&&$.extend(d,{Action:a}),void 0!==b&&$.extend(d,{ID:b}),window.clearTimeout(usersTimer),apiRequest({url:apiEndpoint.users,data:d,success:function(d){updateUsersSuccess(d,a,b,c)},error:function(a,b,c){websockets===!1&&(usersTimer=window.setTimeout(updateUsers,1e4))}})}$(document).trigger("LiveHelp.UpdateUsersComplete")}function updateResponsesChats(){var a=$(".responses .response .dropdown-menu.send-response"),b=users.Online.User;b.length>0?(a.find(".none").hide(),$.each(b,function(b,c){a.find("li[data-id="+c.ID+"]").length||$('<li class="menu-item" data-id="'+c.ID+'"><a href="#">'+c.Name+"</a></li>").appendTo(a)})):a.find(".none").show()}function updateUsersInterface(a,b,c,d){if(void 0!==a){$(document).trigger("LiveHelp.UsersCompleted",{newUsers:a,previousUsers:users}),users=a,updateResponsesChats();var e=$(".operators .visitor"),f=$(".chatting .visitor, .other-chatting .visitor"),g=$(".pending .visitor"),h=$(".operators.list"),i=c,j=$(".chat-list .empty");if(showOfflineOperators===!1){var k=0;$.each(e,function(a,b){var c=$(b),d=c.data("id"),e=!1;$.each(users.Staff.User,function(a,b){parseInt(b.ID,10)===d&&1===parseInt(b.Status,10)&&(e=!0,k++)})}),0===k&&clearUsers(h)}$.each(users.Online.User,function(a,d){"Accept"===b&&("number"==typeof d.ID&&i===parseInt(d.ID,10)||"string"==typeof d.ID&&36==d.ID.length&&i===d.ID)&&parseInt(d.Active,10)===operator.id&&openChat(c,d)}),h=$(".chatting.list");var l=h.find(".visitor[data-id=-1]");if(f.length>0){var m=0;$.each(f,function(a,b){var c=$(b),d=c.data("id"),e=!1;$.each(users.Online.User,function(a,b){("number"==typeof b.ID&&parseInt(b.ID,10)===d||"string"==typeof b.ID&&b.ID===d)&&(e=!0),parseInt(b.Active,10)===operator.id&&m++}),!e&&!c.is(".visitor[data-id=-1]")}),0!==m||l.length||clearUsers(h)}else l.length||clearUsers(h);users.Pending.User.length>0?showPendingNotification(users.Pending.User):closeNotification(),h=$(".pending.list"),g.length>0?$.each(g,function(a,b){var c=$(b),d=c.data("id"),e=!1,f=users.Pending.User.length+users.Transferred.User.length;$.each(users.Pending.User,function(a,b){return"number"==typeof b.ID&&parseInt(b.ID,10)===d||"string"==typeof b.ID&&b.ID===d?(e=!0,!1):void 0}),$.each(users.Transferred.User,function(a,b){return"number"==typeof b.ID&&parseInt(b.ID,10)===d||"string"==typeof b.ID&&b.ID===d?(e=!0,!1):void 0}),0===f&&clearUsers(h)}):clearUsers(h);var n={Online:users.Online,Pending:users.Pending,Transferred:users.Transferred};showOfflineOperators===!1&&(n.Staff=users.Staff),$.each(n,function(a,b){null!=b&&void 0!==b.User&&updateUser(a,b.User)})}sortOperators(),updateSelectedChat();var o=users.Staff.User.length;o&&$.each(users.Staff.User,function(a,b){return parseInt(b.ID,10)===operator.id?(o-=1,!1):void 0}),o||users.Online.User.length||users.Pending.User.length||users.Transferred.User.length?j.hide():j.show(),d&&d(),websockets===!1&&(usersTimer=window.setTimeout(updateUsers,1e4))}function convertAccessLevel(a){var b=parseInt(a,10);switch(b){case-1:case 0:a="Full Administrator";break;case 1:a="Department Administrator";break;case 2:a="Limited Administrator";break;case 3:a="Sales / Support Staff";break;case 4:a="Guest"}return a}function updateMessageAlert(a,b,c,d){var e=$('.chat-list .visitor[data-id="'+a+'"][data-operator="'+b+'"] .message-alert'),f=$('.chat[data-id="'+a+'"][data-operator='+b+"]");if(c=void 0!==c?parseInt(c,10):1,scrollAlertEnabled){var g=f.find(".scroll"),h=g.length>0?g[0].scrollTop+g.height():0,i=f.find(".messages .message.left:not(.typing):last"),j=parseInt(e.text(),10),k=isNaN(j)?c:j+c,l=0;if(g.length>0&&(l=i.length>0?g[0].scrollTop+i.position().top:g[0].scrollTop),d>0){if(l>h){var m=k>1?k+" New Messages":k+" New Message";f.find(".scrollalert a").text(m).parent().show()}(!f.is(".focussed")||f.is(".focussed")&&l>h)&&setMessageAlert(a,b,k)}$.each(activechats,function(a,b){var c=_.find(viewed,function(a){return a.id===b.id&&a.operator===(1===b.type?!0:!1)});void 0!==c?(f.is(".focussed")&&h>=l&&(c.viewed=b.message),c.message=b.message):viewed.push({id:b.id,operator:1===b.type?!0:!1,message:b.message,viewed:b.message})}),storage.set("viewed",viewed)}else f.is(".focussed")||(c>0?(c=parseInt(e.text(),10)+c,setMessageAlert(a,b,c,d)):e.hide())}function setMessageAlert(a,b,c,d){var e=/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/;if("string"!=typeof a||e.test(a)||(a=parseInt(a,10)),c>0){var f=storage.get("alerts");f=void 0!==f&&f instanceof Array?storage.get("alerts"):[];var g=_.find(f,function(c){return c.id===a&&c.operator==b});if(void 0!==g){if(void 0!==d){if(g.last!==!1&&"number"==typeof g.last){var h=$(".chat-stack .chat[data-id="+a+"][data-operator="+b+"] .message.left:not(.typing)").filter(function(){return $(this).data("id")>g.last});c=h.length}d=_.min(h,function(a){return $(a).data("id")}),void 0!==g.last&&0!=g.last||_.isEmpty(d)||(g.last=$(d).data("id"))}g.alert=c}else{var i={id:a,operator:b,alert:c,last:!1},g=$(".chat[data-id="+a+"][data-operator="+b+"] .messages");if(!g.length){var j=$(".chat-list .visitor[data-id="+a+"][data-operator="+b+"]");j.length>0&&chattingVisitorClickCallback.call(j,{},!0,void 0,!0)}var k=$(".chat[data-id="+a+"][data-operator="+b+"]").find(".message.left:not(.typing), .message.right:not(.typing)");k=$(k[k.length-c-1]).data("id"),void 0!==k&&"number"==typeof k&&(i.last=k),f.push(i)}if(c>0){var l=$('.chat-list .visitor[data-id="'+a+'"][data-operator="'+b+'"] .message-alert');l.text(c).show(),l.parent().find(".name").css("font-weight",400);var m=_.reduce($(".chat-list .visitor .message-alert"),function(a,b){return a+parseInt($(b).text(),10)},0);$(document).trigger("LiveHelp.MessageAlert",m)}storage.set("alerts",f)}}function showMessageAlerts(){var a=storage.get("alerts");a=void 0!==a&&a instanceof Array?storage.get("alerts"):[],$.each(a,function(a,b){var c=$('.chat-stack .chat[data-id="'+b.id+'"][data-operator="'+b.operator+'"]'),d=c.find(".message-alert");if(!c.length){var e=$(".chat-list .visitor[data-id="+b.id+"][data-operator="+b.operator+"]");e.length>0&&chattingVisitorClickCallback.call(e,{},!0,void 0,!0)}d.text(b.alert).show(),d.parent().find(".name").css("font-weight",400)})}function resetMessageAlert(a,b){if(a.length>0){var c=a.data("id"),d=a.data("operator"),e=a.find(".message-alert"),f=0,g=storage.get("alerts");if(e.fadeOut(function(){e.text(f);var a=_.reduce($(".chat-list .visitor .message-alert"),function(a,b){return a+parseInt($(b).text(),10)},0);$(document).trigger("LiveHelp.MessageAlert",a)}),e.parent().find(".name").css("font-weight",200),g=void 0!==g&&g instanceof Array?storage.get("alerts"):[],d){var h=_.find(g,function(a){return a.id===c&&a.operator===d});void 0!==h&&(h.alert=0);var i=$(".chat-stack .chat[data-id="+c+"][data-operator="+d+"] .message.left:not(.typing)"),j=_.max(i,function(a){var b=$(a).data("id");return"number"==typeof b?b:-1});_.isEmpty(j)||(j=$(j).data("id"),void 0!==j&&j!==!1&&(0==h.last||"number"==typeof j&&h.last<j)&&(h.last=j))}else g=_.reject(g,function(a){return a.id===c&&a.operator===d});if(storage.set("alerts",g),$(".chat-stack .chat[data-id="+c+"][data-operator="+d+"]").is(".focussed")){var k=_.find(viewed,function(a){return a.id===c&&a.operator==d});void 0!==k&&(k.viewed=k.message,storage.set("viewed",viewed))}c>0&&void 0===b&&intercom!==!1&&intercom.emit("message-alert",{id:c,operator:d})}}function saveMessage(a,b,c){var d=chatMessages,e="chat";"string"==typeof a&&(d=channelMessages,e="channel");var f=_.findWhere(d,{id:a}),g=$(".messages.input #message"),h=$(".chat-stack ."+e+".focussed"),i=$(h).data("id"),j=$(h).data("operator")?$(h).data("operator"):!1,k=0;null!==i&&void 0!==i&&(d=_.reject(d,function(a){return a.id==i}),d.push({id:i,operator:j,message:g.val(),cursor:g.getCursorPosition()}),"chat"==e?chatMessages=d:channelMessages=d),d=chatMessages,"string"==typeof b&&(d=channelMessages,e="channel"),f=_.findWhere(d,{id:b}),void 0!==f&&b!==i?(g.val(f.message),void 0!==f.cursor&&(k=f.cursor,g.selectRange(k))):(0==c&&selectedChat!==a||"channel"===e)&&g.val("")}function openChat(a,b,c,d,e,f,g){d=void 0!==d?d:!1,"string"==typeof b&&(b=JSON.parse(b));{var h=$('.chat-list .visitor[data-id="'+a+'"][data-operator='+d+"]");$(".chat-list .dropdown-menu.options")}c=void 0!==c&&c?!0:!1,h.length>0&&0==c&&($(".chat-list").find(".visitor.selected, .visitor.previous").removeClass("selected previous"),h.addClass("selected"),storage.set("selected-chat",{id:a,operator:d})),h.length>0&&void 0===e&&void 0===f&&$(document).trigger("LiveHelp.OpenChat",{id:a,operator:d}),closeHistory();var i=$(".chat-stack .channel.focussed"),j=i.length>0?i.data("id"):!1;c||saveMessage(j,a,c);var k=_.find(viewed,function(b){return b.id===a&&b.operator==d}),l=void 0!==b?parseInt(b.Messages,10):0;void 0!==k&&l>0&&(k.count=l,storage.set("viewed",viewed));var m=$(".chat-stack"),n=(m.find(".chat"),window.devicePixelRatio>1?300:150,App.templates.chat({id:a,styles:0==c?"chat focussed":"chat",operator:d})),o=window.location.pathname,p=server.length>0?protocol+server+defaultUserImage:encodeURIComponent(window.location.protocol+"//"+window.location.host+o.replace(o.substring(o.indexOf(directoryPath+"/admin/")),defaultUserImage));if(m.length&&!m.find(".chat[data-id="+a+"][data-operator="+d+"]").length?($(n).prependTo(m).find(".scroll").on("scroll",debouncedSaveScroll),websockets!==!1?updateMessages(g):g&&g()):g&&g(),0==c){var q=$(".messages.input");d?q.addClass("operator").removeClass("guest"):q.addClass("guest").removeClass("operator"),m.find('.chat.focussed, .channel.focussed, .chat:not(.chat[data-id="'+a+'"][data-operator='+d+"])").removeClass("focussed").hide(),m.find('.chat[data-id="'+a+'"][data-operator='+d+"]").addClass("focussed").show(),selectedChat=a;var r=$(".list");r.find(".visitor, .channel").removeClass("selected previous"),r.find('.visitor[data-id="'+a+'"][data-operator='+d+"]").addClass("selected previous"),m.find(".chat.unfocussed, .channel.unfocussed").removeClass("unfocussed"),scrollToBottom(a,d,!0,!1)}var s=m.find(".chat[data-id="+a+"][data-operator="+d+"]"),t="Guest",u="";!s.find(".scrollalert").is(":visible")&&s.is(".focussed")&&resetMessageAlert(h),void 0!==b&&(t=ucwords(void 0!==b.Firstname?b.Firstname:b.Name),u=CryptoJS.MD5(b.Email));var v=void 0!==b&&b.Email.length>0?t+" - "+b.Email:t,w=gravatar?"https://secure.gravatar.com/avatar/"+u+"?s=50&r=g&d="+p:p;if(s.find(".scroll").chatScrollHandler(),d){var x=!1;$.each(accounts,function(a,c){return parseInt(c.ID,10)===b.ID?(x=c,!1):void 0}),x!==!1&&void 0!==x.Firstname&&void 0!==x.Lastname?v=ucwords(x.Firstname+" "+x.Lastname):void 0!==b.Firstname&&(v=ucwords(b.Firstname))}x!==!1&&void 0!==b&&(w=operatorImage(a,b.Email,30,!0));var y=s.find(".status .email");void 0!==b?y.attr("href","mailto:"+b.Email).text(b.Email).show():y.hide(),s.find(".name").text(t).hide(),s.find(".status .name").text(t).show(),s.find(".inputs").show(),s.find(".title span.title").text(v),s.find(".header .title span.image").css("background-image","url('"+w+"')"),s.data("closed",!1),0==c&&($(".statistics.container, .history.container, .responses.slider, .accounts.slider, .settings.container").hide(),m.is(":visible")?s.is(".focussed")?m.find("#message").focus():s.click():(s.click(),m.show())),m.find(".smilies.button").close(),checkBlocked(a);var h=$(".visitor[data-id="+a+"][data-operator="+d+"]"),z=h.find(".message-alert"),A=parseInt(h.data("messages"),10)+parseInt(z.text(),10);h.data("messages",A)}function closeChats(){var a=$(".chat-stack"),b=a.height();return $(".chat-stack .smilies.button").close(),a.animate({top:-b,bottom:30+b},250),!1}function showPendingNotification(a){var b=$(".notification"),c=locale.pendingchat,d="",e="",f="";a.length>1?(c="Pending Chats",d=a.length+" visitors are pending to chat"):1===a.length&&(e=ucwords(a[0].Name.toLowerCase()),f=a[0].Server,d=f.length>0?void 0!==locale.pendingchatdescription?locale.pendingchatdescription.replace("{name}",e):e+" is pending to chat at "+f:void 0!==locale.pendingchatdescription?locale.pendingchatdescription.replace("{name}",e):e+" is pending to chat"),b.off("click"),b.on("click",function(){if(1===a.length){var b="number"==typeof a[0].ID?parseInt(a[0].ID,10):a[0].ID;b>0&&acceptChat(b)}}),d.length>0&&(-1===b.find(".icon ChatNotification").length&&b.find(".icon").addClass("sprite ChatNotification"),b.find(".notify").text(d),showNotification({title:c,text:d,users:a}))}function showNotification(a){var b=!1;$.each(a.users,function(a,c){var d=parseInt(c.ID,10),e=!1;$.each(notificationUsers,function(a,b){return d===b?(e=!0,!1):void 0}),e?b=!0:notificationUsers.push(d)}),b||(notification&&$(".notification").animate({top:-20},250,"easeInOutBack"),$(document).trigger("LiveHelp.Notification",a))}function closeNotification(){notificationUsers=[];var a=$(".notification"),b=parseInt(a.css("top"),10);b>=-20&&a.animate({top:-80},500,"easeInOutBack")}function sendMessage(a,b){var c=$(".chat-stack"),d=c.find("textarea"),e=c.find(".chat.focussed"),f=c.find(".channel.everyone"),g=void 0!==a?a:d.val();if(d.is(".disconnected"))return!1;if(void 0!==b||e.length>0){var h=0,i={Message:g};if(e.length>0&&!b&&(b=e.data("id"),h=e.data("operator")!==!1?1:0),"number"==typeof b&&b>0||"string"==typeof b&&36===b.length){$(document).trigger("LiveHelp.SendMessage",{from:operator.id,to:b,message:g});var j=!1;$.each(accounts,function(a,b){return parseInt(b.ID,10)===operator.id?(j=b,!1):void 0});var k=1,l=uuid.v4(),a=messageHTML(l,k,g,new moment,operator.id,operator.username,j.Firstname,operator.email,b,!0,0),m=e.find(".message").last().data("id");displayMessages(b,e.data("operator"),e,a.html,k,0,m,!1,!1,a.tweets);var n=function(a,b){return function(c){var d="number"==typeof c.ID?parseInt(c.ID,10):c.ID,e=a.find('.message[data-id="'+b+'"]');e.length>0&&e.data("id",d).attr("data-id",d).removeClass("sending")}};$.extend(i,{ID:b,UUID:l,Staff:h}),apiRequest({url:apiEndpoint.send,data:i,success:n(e,l)})}else"number"==typeof b&&0>b&&$(document).trigger("LiveHelp.SendMessage",{from:operator.id,id:b,message:g})}else f.length>0&&$(document).trigger("LiveHelp.SendMessage",{from:operator.id,channel:"everyone",message:g});return d.val(""),d.keyup(),!1}function sendCommand(a,b,c,d){var e={ID:a};return b=void 0!==b?b:"",c=void 0!==c?c:"",d=void 0!==d?d:"",$.extend(e,{Type:b,Name:c,Content:d,Staff:"0"}),apiRequest({url:apiEndpoint.send,data:e,success:function(a){}}),!1}function filterResponses(){var a=$("#responses #search").val(),b=void 0!==a&&a.length>0?a.split(" "):"",c=[],d=[],e=["Text","Hyperlink","Image","PUSH","JavaScript"];b.length>0&&$.each(responses,function(a,f){$.inArray(a,e)>-1&&$.each(f,function(a,e){var f=parseInt(e.ID,10),g=!1;$.each(b,function(a,b){return e.Name.toLowerCase().indexOf(b)>-1||e.Content.toLowerCase().indexOf(b)>-1?(g=!0,!1):void 0}),g?c.push(f):d.push(f)})}),0===responses.length&&c.push(d);var f=$("#responses .response");0===c.length&&0===d.length?f.show():($.each(c,function(a,b){b.length>0&&f.filter("[data-id="+b+"]").show()}),$.each(d,function(a,b){b.length>0&&f.filter("[data-id="+b+"]").hide()}))}function processEscKeyDown(){var a=$(".slider.right"),b=($("#visitor-details"),$("#account-details")),c=$("#settings"),d=$(".accounts-grid"),e=0,f=null;if(c.height()>0&&c.width()>0)return void closeSettings();if($.each(a,function(a,b){var c=$(b),d=parseInt(c.css("z-index"),10);c.width()>0&&d>e&&(f=c,e=d)}),null!==f){var g=f.attr("id"),h="";switch(g){case"responses":closeResponses(),h=g;break;case"visitor-details":closeVisitor();break;case"account-details":d.is(":visible")===!1&&showAccounts(),b.is(":visible")&&b.width()>0&&closeAccount(),h="accounts";break;case"history-chat":closeHistory(),h="history"}return void $(document).trigger("LiveHelp.CloseSlider",{menu:h,previousMenu:previousMenu})}return 0===parseInt($(".chat-stack").css("top"),10)?void closeChats():void 0}function updateResponses(a){if($("#responses").length){var b=$("#responses .scroll #response-list"),c=["Text","Hyperlink","Image","PUSH","JavaScript","Other"],d={};b.html(""),$(document).trigger("LiveHelp.ResponsesUpdated",a),void 0!==a.Text&&a.Text.length>0||void 0!==a.Hyperlink&&a.Hyperlink.length>0||void 0!==a.Image&&a.Image.length>0||void 0!==a.PUSH&&a.PUSH.length>0?($(".responses .empty").hide(),$.each(a,function(a,e){if($.inArray(a,c)>-1){var f="PUSH"===a||"Hyperlink"===a?'<span style="position: absolute; right: 40px">'+a+"</span>":"";a=a.toLowerCase(),$('<div class="'+a+'" />').appendTo(b),void 0===d[a]&&(d[a]=$("#response-list ."+a));var g=$(".chat-list .options.dropdown-menu ."+a);e.length>0&&0===g.find("ul").length&&(g.addClass("dropdown-submenu"),$('<ul class="dropdown-menu"></ul>').appendTo(g)),g=g.find(".dropdown-menu");var h=!1;e.length>0&&void 0!==e[0].Custom&&(e=e[0].Custom,h=!0),$.each(e,function(b,c){if("Description"==b){var e=$(".chat-list .options.dropdown-menu"),h=e.find(".other.menuitem");h.find("> a").text(c),h.show(),e.find(".other.divider").show()}else{var i=parseInt(c.ID,10),j="",k="display: none",l=c.Content,m=$('<li class="responseitem submenu"><a href="#">'+c.Name+"</a></li>");if(m.data("response",c),c.Category.length>0){var n=g.find("li."+a+".category a"),o=!1;if($.each(n,function(a,b){var d=$(b);return d.text()===c.Category?void(o=d):void 0}),o)m.appendTo(o.parent().find("ul.dropdown-menu"));else{var p=$('<li class="'+a+' category dropdown-submenu"><a href="#">'+c.Category+'</a><ul class="dropdown-menu"></ul></li>');m.appendTo(p.find(".dropdown-menu")),p.appendTo(g)}}else m.appendTo(g);void 0!==c.Tags&&(c.Tags.length>0?($.each(c.Tags,function(a,b){b=b.toLowerCase(),-1===$.inArray(b,tags)&&tags.push(b)}),k="display: inline-block",j=c.Tags.join(", ")):k="display: none"),l=l.replace(/^(https?|ftp|file):\/\/[\-A-Z0-9+&@#\/%?=~_|!:,.;]*[A-Z0-9+&@#\/%=~_|](\.jpg|.jpeg|\.gif|\.png)$/gim,'<img src="$&" style="max-width: 300px"/>');var q='<div class="btn-group send"><div class="dropdown-toggle" data-toggle="dropdown"><span class="title">'+c.Name+f+'</span> <span class="caret sprite sort-desc"></span></div><ul class="dropdown-menu send-response"><li class="dropdown-header">Send Message To</li><li class="none">No Available Chats</li></ul></div>';$('<div class="response" data-id="'+i+'"><div class="label">'+q+'</div><div class="edit sprite Edit" title="Edit Response"></div><div class="content">'+l+'</div><div class="tags"><span class="tag-icon" style="'+k+'"></span><span class="tag">'+j+"</span></div></div>").appendTo(d[a]),$(".dropdown-toggle").dropdown()}})}})):clearResponses()}}function clearResponses(){$("#responses .scroll #response-list .response").remove(),$(document).trigger("LiveHelp.ClearResponses")}function loadResponses(){session.length>0&&apiRequest({url:apiEndpoint.responses,success:function(a){void 0!==a&&void 0!==a.Responses?(responses=a.Responses,updateResponses(responses)):clearResponses()},error:function(){clearResponses()}})}function updateTotal(a,b){var c=a.attr("id"),d=parseInt(a.data("total"),10);b!==d&&(a.animate({height:0},350,"easeInOutBack",function(){a.text(b),a.animate({height:38},350,function(){a.data("total",b)})}),"visitortotal"==c?$(document).trigger("LiveHelp.UpdateVisitorsTotal",b):$(document).trigger("LiveHelp.UpdateChatsTotal",b))}function toggleChatMenu(a,b,c){var d="expander sprite sort-desc",e=a.attr("id");b>0&&(d="expander sprite sort-asc"),storage.set(e+".height",b),b>0&&saveExpanded||c?a.animate({height:b},250,"easeOutBack",function(){var c=!1;b>0?(a.show(),c=!0):a.hide(),$(this).prev().attr("aria-expanded",c),$(this).prev().find(".expander").removeAttr("class").addClass(d)}):(a.prev().attr("aria-expanded",!0),a.prev().find(".expander").removeAttr("class").addClass(d))}function openHistory(){$(document).trigger("LiveHelp.HistoryOpened"),$(".visitors.container, .statistics.container, .responses.slider, .accounts.slider, .settings.container, .chat-stack").hide();var a=$(".history.container").show();historyChartData.length>0&&showHistoryChart(),openHistoryCallback(a),initHistoryGridEvents(),initHistoryGrid()}function openStatistics(){$(".visitors.container, .history.container, .responses.slider, .accounts.slider, .settings.container, .chat-stack").hide(),$(".statistics.container").show(),ratingChartData.length>0&&showRatingChart(),weekdayChartData.length>0&&showWeekdayChart(),closeHistory()}function switchMenu(a){var b=!1;switch(a){case"home":openHome(),previousMenu=a,b=a;break;case"statistics":openStatistics(),previousMenu=a,b=a;break;case"history":openHistory(),previousMenu=a,b=a;break;case"responses":openResponses(),b=a;break;case"accounts":openAccounts(),b=a;break;case"settings":openSettings();var c=$(".settings.dropdown .settingsmenu .selectedLava").attr("id");b=void 0!==c&&c.length>0?"settings/"+c:a;break;case"integrations":b=openIntegrations()}$(document).trigger("LiveHelp.MenuChanged",a),b!==!1&&b.length>0&&(storage.set("route",b),router.setRoute(b),$(document).trigger("LiveHelp.RouteChanged"))}function switchPreviousMenu(){storage.get("route");storage.set("route",""),previousMenu.length>0&&previousMenuEnabled&&(router.setRoute(previousMenu),$(document).trigger("LiveHelp.RouteChanged"))}function loadLocalSettings(){viewed=storage.get("viewed");var a=storage.get("route");if(a.length>0){switch(a){case"responses":openResponses();break;case"accounts":openAccounts();break;case"settings":openSettings()}if(a.indexOf("settings/")>-1){var b=a.replace("settings/","");openSettings(b)}router.setRoute(a),$(document).trigger("LiveHelp.RouteChanged")}}function signInComplete(){$(".login, .loading").fadeOut(250,function(){$(".login").hide()}),$(".content").filter(":not(.loading)").show().animate({opacity:1},250),$(document).trigger("LiveHelp.SignInCompleted"),void 0===messageSound&&(messageSound=new buzz.sound(address+"/sounds/New Message",{formats:["ogg","mp3","wav"],volume:100})),void 0===pendingSound&&(pendingSound=new buzz.sound(address+"/sounds/Pending Chat",{formats:["ogg","mp3","wav"],volume:100}));var a=storage.get("operator"),b=!1,c=window.devicePixelRatio>1?300:150;if(void 0===accounts&&(accounts=storage.get("accounts")),$.each(accounts,function(c,d){return parseInt(d.ID,10)===a.id?(b=d,!1):void 0}),void 0!==a){var d=operatorImage(a.id,b.Email,c);b!==!1&&void 0!==b.Image&&b.Image.indexOf("https://")>-1&&(d=b.Image),$(".operator .photo").css({background:"url("+d+") #fcfcfc","background-size":"50px auto"}),$(".operator .name").text(a.name)}a.access>3&&($(".menu a[data-type=statistics]").parent().hide(),$(".menu a[data-type=history]").parent().hide(),$(".menu a[data-type=accounts]").parent().hide()),$(document).trigger("LiveHelp.SignInComplete",{account:a,server:server}),$(".login").find("input[type!=reset][type!=submit], select").val(""),loadLocalSettings(),apiRequest({url:apiEndpoint.settings,success:function(a){void 0!==a.Settings&&(loadSettings(a.Settings),updateUsers(void 0,void 0,function(){updateMessages()}),$(document).trigger("LiveHelp.SettingsInitialised",a.Settings))}}),updateMessages(),updateVisitorsGrid(),loadStatisticsChartData(),initAccountsGrid(!1),loadResponses();try{initWorldMap()}catch(e){}}function toggleEmptyChats(){var a=$(".chat-list .empty");$(".chat-list .visitor").length?a.hide():a.show()}function closeChat(){closeChatClosingCallback()}function blockChat(){var a=($(".chat-stack .chat"),$(".chat-list .visitor.selected").data("id")),b=$(".chat-stack .chat[data-id="+a+"]");if(null!==b){var c=$(".chat-stack .dialog");c.find(".progressring img").attr("src","images/ProgressRing.gif"),c.find(".title").text("Blocking Chat Session"),c.find(".description").text("One moment while the chat session is blocked."),c.show().animate({bottom:"1px"},250),updateUsers("Block",a,function(){c.find(".progressring img").attr("src","images/Block.png"),c.find(".unblock").fadeIn(),c.find(".title").text("Chat Session Blocked"),c.find(".description").text("The chat session is blocked and inactive.");var b=null,d=!1,e=[];$.each(activechats,function(c,d){d.id===a?b=d:e.push(d)}),activechats=e,$.each(blockedchats,function(b,c){return c.id===a?void(d=!0):void 0}),d||-1===$.inArray(a,blockedchats)&&blockedchats.push(b)})}}function unblockChat(a,b){var c=[];b.find(".progressring img").attr("src","images/ProgressRing.gif"),b.find(".title").text("Unblocking Chat Session"),b.find(".description").text("One moment while the chat session is unblocked."),updateUsers("Unblock",a,function(){b.find(".progressring img").fadeOut(),b.find(".title").text("Chat Session Unblocked"),b.find(".description").text("The chat session is nunblocked and can now request Live Chat."),b.animate({bottom:"1px"},250,function(){b.find(".unblock").hide(),b.hide()}),$.each(blockedchats,function(b,d){return d.id===a?void(exists=!0):void c.push(d)}),blockedchats=c})}function emailChat(a,b){apiRequest({url:apiEndpoint.emailchat,data:{ID:a,Email:b},success:function(a){}})}function signInError(a,b){var c="",d=$(".login, .inputs"),e=$(".login .signin .signin.error .text"),f=$(".login .signin div.twofactor.signin"),g=$(".login .signin div.twofactor.disable");d.find(".logo").removeClass("loading"),g.is(":visible")?(e=g.find(".signin.error .text"),void 0!==b&&(e=b)):f.is(":visible")?(c="Invalid Security Code",e=f.find(".error .text")):503===a.status&&"License Invalid"===a.statusText?(c="License Invalid",cache=!0):c="*"===a.getResponseHeader("X-Disabled")?"Account Disabled":"Incorrect Username / Password",signInErrorCallback("Sign In Error",c,e)}function signIn(){var a=signInCallback();if(a){var b=$(".login"),c=window.location.pathname,d=b.find("#server").length?b.find("#server").val():"";protocol=b.find("#ssl").is(":checked")?"https://":"http://",b.find(".logo").addClass("loading"),storage.get("server").length>0&&(server=storage.get("server"),protocol=storage.get("protocol")),"https:"==document.location.protocol&&(protocol="https://",storage.set("protocol",protocol)),server=void 0!==server&&server.length>0?server:document.location.host,d.length>0&&(server=d);var e=document.location.pathname.indexOf("/modules/livehelp/admin"),f=document.location.pathname.indexOf("/livehelp/admin");e>-1?(c=document.location.pathname.substring(0,e),address=protocol+server+c+"/modules"+directoryPathName):f>-1?(c=document.location.pathname.substring(0,f),address=protocol+server+c+directoryPathName):address=protocol+server+directoryPathName,router.init(),$(document).trigger("LiveHelp.SignIn");var g=b.find("#username").length?b.find("#username").val():"",h=b.find("#password").length?b.find("#password").val():"",i=b.find("#status").length?b.find("#status").val():"",j=b.find("#security"),k=b.find("#backupcode"),l={};if(j.is(":visible")){if(6!=j.val().length)return $(".login .twofactor.form .error").fadeIn(),void $(".login .inputs, .login .logo").effect("shake",{times:3,distance:10},150);l=$.extend(l,{Data:$.toJSON({code:j.val()})}),$(".login .twofactor.form .error").hide()}else if(k.is(":visible")){if(g=b.find(".twofactor.form #username").val(),h=b.find(".twofactor.form #password").val(),24!=k.val().length)return $(".login .twofactor.form .backup.error").fadeIn(),void $(".login .inputs, .login .logo").effect("shake",{times:3,distance:10},150);$.extend(l,{Data:$.toJSON({backupcode:k.val()})}),$(".login .twofactor.form .error").hide()}if(g.length>0&&h.length>0?$.extend(l,{Username:g,Password:h,Action:i,Version:"5.0"}):(server=storage.get("server"),protocol=storage.get("protocol")),0===server.length){var c=document.location.pathname.indexOf(directoryPath)>0?document.location.pathname.substring(0,document.location.pathname.indexOf(directoryPath)):"";server=document.location.host+c}cache&&$.extend(l,{cache:""}),apiRequest({url:apiEndpoint.login,data:l,success:function(a){if($(".login .logo").removeClass("loading"),void 0!==a.Login&&void 0!==a.Login.Session)if(session=a.Login.Session,session!==!1&&session.length>0){operator={id:a.Login.ID,
username:g,name:a.Login.Name,email:a.Login.Email,access:parseInt(a.Login.Access,10),status:a.Login.Status},void 0!==a.Login.Datetime&&(operator.datetime=a.Login.Datetime),void 0!==a.Login.Customer&&(operator.customer={company:a.Login.Customer.Company,plan:a.Login.Customer.Plan,datetime:a.Login.Customer.Datetime}),void 0!==a.Login.Users&&(operator.users=a.Login.Users),void 0!==a.Login.Messages&&(operator.messages=a.Login.Messages),void 0!==a.Login.TeamMessages&&(operator.teammessages=a.Login.TeamMessages),void 0!==a.Login.Chats&&(operator.chats=a.Login.Chats),void 0!==a.Login.Devices&&(operator.devices=a.Login.Devices),void 0!==a.Login.Hash&&(operator.hash=a.Login.Hash),void 0!==a.Login.Account&&(operator.account=a.Login.Account),$(document).trigger("LiveHelp.LoginComplete",session),storage.set("protocol",protocol),storage.set("server",server),storage.set("session",session),storage.set("operator",operator),signInComplete();var b="Offline";switch(a.Login.Status){case 1:b="Online";break;case 2:b="BRB";break;case 3:b="Away"}b="BRB"===b?"Be Right Back":b,$(".operator .dropdown-toggle .status").text(b),"Be Right Back"===b?b="BRB":"Offline"===b&&(b="Offline"),$(".operator .mode").removeClass("online offline hidden brb away").addClass(b.toLowerCase())}else if(a.Login.OTP!==!1)signInTwoFactorCallback(),$(document).trigger("LiveHelp.LoginTwoFactor");else if(a.Login.OTP===!1){var c=$(".login .signin .backup.error .text");signInError(!1,c)}else signInError()},error:function(a,b,c){signInError(a)}})}}function signOut(){session="",storage.set("protocol",""),storage.set("server",""),storage.set("session",""),storage.set("accounts",""),storage.set("operator",""),$(document).trigger("LiveHelp.SignOut"),signOutCallback(),$(".chat-list .visitor, .chat-stack .chat").remove(),$(".loading, .settings.container").hide(),$(".content").filter(":not(.loading)").animate({opacity:0},250),$(".login").show().fadeIn()}function convertHostname(a){var b=a.Hostname,c=ucwords(a.Username);return null!==c&&c.length>0&&(b=c+" - "+b),b}function convertBrowserIcon(a,b){var c="Chrome",d="",e="chrome",f=48;return-1!==a.indexOf("MSIE")||-1!==a.indexOf("Trident/")?(c="InternetExplorer",e="ie"):-1!==a.indexOf("Edge/")?(c="Edge",e="edge"):-1!==a.indexOf("Chrome")?(c="Chrome",e="chrome"):-1!==a.indexOf("Opera")?(c="Opera",e="opera"):-1!==a.indexOf("Safari")?(c="Safari",e="safari"):-1!==a.indexOf("Firefox")&&(c="Firefox",e="firefox"),b?(d="./images/"+c+"Small.png",f=16,e+=" browser small vector "):d="./images/"+c+".png",e+="browser small",{image:d,css:e,size:f}}function convertReferrer(a){var b=/^http[s]{0,1}:\/\/(?:[^.]+[\\.])*google(?:(?:.[a-z]{2,3}){1,2})[\/](?:search|url|imgres|aclk)(?:\?|.*&)q=([^&]*)/i,c=b.exec(a);return null!==c&&(a=c[1].length>0?"Google Search (Keywords: "+c[1]+")":"Google Search"),a}function convertCountryIcon(a){var b={"Ascension Island":"ac",Andorra:"ad","United Arab Emirates":"ae",Afghanistan:"af","Antigua And Barbuda":"ag",Anguilla:"ai",Albania:"al",Armenia:"am","Netherlands Antilles":"an",Angola:"ao",Antarctica:"aq",Argentina:"ar","American Samoa":"as",Austria:"at",Australia:"au",Aruba:"aw","Aland Islands":"ax",Azerbaijan:"az","Bosnia And Herzegovina":"ba",Barbados:"bb",Bangladesh:"bd",Belgium:"be","Burkina Faso":"bf",Bulgaria:"bg",Bahrain:"bh",Burundi:"bi",Benin:"bj",Bermuda:"bm","Brunei Darussalam":"bn",Bolivia:"bo",Brazil:"br",Bahamas:"bs",Bhutan:"bt","Bouvet Island":"bv",Botswana:"bw",Belarus:"by",Belize:"bz",Canada:"ca","Cocos (keeling) Islands":"cc","Congo, The Democratic Republic of The":"cd","Central African Republic":"cf","Congo, Republic of The":"cg",Switzerland:"ch","Cote D'ivoire":"ci","Cook Islands":"ck",Chile:"cl",Cameroon:"cm",China:"cn",Colombia:"co","Costa Rica":"cr",Cuba:"cu","Cape Verde":"cv","Christmas Island":"cx",Cyprus:"cy","Czech Republic":"cz",Germany:"de",Djibouti:"dj",Denmark:"dk",Dominica:"dm","Dominican Republic":"do",Algeria:"dz",Ecuador:"ec",Estonia:"ee",Egypt:"eg","Western Sahara":"eh",Eritrea:"er",Spain:"es",Ethiopia:"et",Europe:"eu",Finland:"fi",Fiji:"fj","Falkland Islands ( Malvinas )":"fk","Micronesia, Federated States of":"fm","Faroe Islands":"fo",France:"fr",Gabon:"ga",Grenada:"gd",Georgia:"ge","French Guiana":"gf",Ghana:"gh",Gibraltar:"gi",Greenland:"gl",Gambia:"gm",Guinea:"gn",Guadeloupe:"gp","Equatorial Guinea":"gq",Greece:"gr","South Georgia And The South Sandwich Islands":"gs",Guatemala:"gt",Guam:"gu","Guinea-bissau":"gw",Guyana:"gy","Hong Kong":"hk","Heard Island And Mcdonald Islands":"hm",Honduras:"hn",Croatia:"hr",Haiti:"ht",Hungary:"hu",Indonesia:"id","Ireland, Republic of":"ie",Ireland:"ie",Israel:"il",India:"in","British Indian Ocean Territory":"io",Iraq:"iq","Iran, Islamic Republic of":"ir",Iceland:"is",Italy:"it",Jamaica:"jm",Jordan:"jo",Japan:"jp",Kenya:"ke",Kyrgyzstan:"kg",Cambodia:"kh",Kiribati:"ki",Comoros:"km","Saint Kitts And Nevis":"kn","Korea, Democratic People's Republic of":"kp","Korea, Republic of":"kr",Kuwait:"kw","Cayman Islands":"ky",Kazakhstan:"kz","Lao People's Democratic Republic":"la",Lebanon:"lb","Saint Lucia":"lc",Liechtenstein:"li","Sri Lanka":"lk",Liberia:"lr",Lesotho:"ls",Lithuania:"lt",Luxembourg:"lu",Latvia:"lv","Libyan Arab Jamahiriya":"ly",Morocco:"ma",Monaco:"mc","Moldova, Republic of":"md","Montenegro, Republic of":"me",Madagascar:"mg","Marshall Islands":"mh",Macedonia:"mk","Macedonia, Republic of":"mk",Mali:"ml",Myanmar:"mm",Mongolia:"mn",Macau:"mo","Northern Mariana Islands":"mp",Martinique:"mq",Mauritania:"mr",Montserrat:"ms",Malta:"mt",Mauritius:"mu",Maldives:"mv",Malawi:"mw",Mexico:"mx",Malaysia:"my",Mozambique:"mz",Namibia:"na","New Caledonia":"nc",Niger:"ne","Norfolk Island":"nf",Nigeria:"ng",Nicaragua:"ni",Netherlands:"nl",Norway:"no",Nepal:"np",Nauru:"nr",Niue:"nu","New Zealand":"nz",Oman:"om",Panama:"pa",Peru:"pe","French Polynesia":"pf","Papua New Guinea":"pg",Philippines:"ph",Pakistan:"pk",Poland:"pl","Saint Pierre And Miquelon":"pm",Pitcairn:"pn","Puerto Rico":"pr","Palestinian Territory, Occupied":"ps","Palestinian Territory":"ps",Portugal:"pt",Palau:"pw",Paraguay:"py",Qatar:"qa",Reunion:"re",Romania:"ro",Serbia:"rs","Serbia, Republic of":"rs","Russian Federation":"ru",Rwanda:"rw","Saudi Arabia":"sa","Solomon Islands":"sb",Seychelles:"sc",Sudan:"sd",Sweden:"se",Singapore:"sg","Saint Helena":"sh",Slovenia:"si","Svalbard And Jan Mayen":"sj",Slovakia:"sk","Sierra Leone":"sl","San Marino":"sm",Senegal:"sn",Somalia:"so",Suriname:"sr","Sao Tome And Principe":"st","El Salvador":"sv","Syrian Arab Republic":"sy",Swaziland:"sz","Turks And Caicos Islands":"tc",Chad:"td","French Southern Territories":"tf",Togo:"tg",Thailand:"th",Tajikistan:"tj",Tokelau:"tk","Timor - Leste ( East Timor )":"tl",Turkmenistan:"tm",Tunisia:"tn",Tonga:"to",Turkey:"tr","Trinidad And Tobago":"tt",Tuvalu:"tv",Taiwan:"tw","Taiwan, Province of China":"tw","Tanzania, United Republic of":"tz",Ukraine:"ua",Uganda:"ug","United Kingdom":"uk","United States Minor Outlying Islands":"um","United States":"us",Uruguay:"uy",Uzbekistan:"uz","Holy See ( Atican City State )":"va","Saint Vincent And The Grenadines":"vc",Venezuela:"ve","Virgin Islands, British":"vg","Virgin Islands, United States":"vi",Vietnam:"vn",Vanuatu:"vu","Wallis And Futuna":"wf",Samoa:"ws",Yemen:"ye",Mayotte:"yt","South Africa":"za",Zambia:"zm",Zimbabwe:"zw"},c=b[a],d=a;return void 0===c||"Unavailable"===c?d="":void 0!==c&&(d="sprite country "+c),d}function convertCountry(a){var b="Unavailable";return null!==a.Country&&a.Country.length>0&&(b=a.Country,null!==a.State&&a.State.length>0?b=a.City.length>0?a.City+", "+a.State+", "+a.Country:a.State+", "+a.Country:null!==a.City&&a.City.length>0&&(b=a.City+", "+a.Country)),b}var session="",operator={},settings={},cache=!1,server="",protocol=protocol,chatstack={bottom:10},notification=!0,zclip=!0,shortcuts=!0,messagesAjax=!0,autoSignIn=!0,notificationIcon="images/Icon64x64.png",visitorsGrid,visitorsDataView,visitorsColumns,visitors,visitorsTimer=!0,visitorsTotal=0,visitorsTimestamp=!1,selectedVisitor=!1,websockets=!1,gravatar=!1,autoScroll=!1,intercom="undefined"!=typeof Intercom?Intercom.getInstance():!1,viewed=[],visitorsColumns=[{id:"browser",width:30},{id:"hostname",width:200},{id:"status",width:80},{id:"location",width:150},{id:"pages",width:30},{id:"page",width:290},{id:"referrer",width:225},{id:"pagetime",width:65},{id:"sitetime",width:65}],visitorsGridOptions={enableCellNavigation:!0,enableColumnReorder:!0,multiColumnSort:!0,multiSelect:!1},chatPath="chat.php",address="",directoryPathName="/livehelp/",directoryPath=document.location.pathname.substring(0,document.location.pathname.indexOf(directoryPathName)+10),defaultUserImage=directoryPath+"images/User.png",apiPath="xml/WebService.php?",apiEndpoint={visitors:"Visitors",chats:"Chats",responses:"Responses",resetpassword:"ResetPassword",operators:"Operators",statistics:"Statistics",settings:"Settings",history:"History",departments:"Departments",users:"Users",send:"Send",emailchat:"EmailChat",login:"Login"},apiAuthVersion=4,opts={location:"index.php",messages:{from:!0,photo:!0},visitorColumns:[{id:"browser",name:"",field:"UserAgent",width:30,resizable:!1,formatter:Slick.Formatters.Browser},{id:"hostname",name:"Hostname / IP Address",field:"Hostname",width:200,sortable:!0,formatter:Slick.Formatters.Hostname},{id:"status",name:"Status",field:"Active",sortable:!0,formatter:Slick.Formatters.Status},{id:"location",name:"Location",field:"Country",width:150,sortable:!0,formatter:Slick.Formatters.Location},{id:"pages",name:"# Pages",field:"PagePath",width:30,sortable:!0,formatter:Slick.Formatters.Pages},{id:"page",name:"Current Page",field:"CurrentPage",width:290,sortable:!0},{id:"referrer",name:"Referrer",field:"Referrer",width:225,sortable:!0,formatter:Slick.Formatters.Referrer},{id:"pagetime",name:"Page Time",field:"TimeOnPage",width:65,sortable:!0,formatter:Slick.Formatters.Seconds},{id:"sitetime",name:"Site Time",field:"TimeOnSite",width:65,sortable:!0,formatter:Slick.Formatters.Seconds}],visitorChartColor:"#54c2ea",visitorChartBalloonFontSize:10,visitorChartBulletBorderColor:"#54c2ea",visitorChartFillColors:"#54c2ea",visitorChartLineColor:"#54c2ea",visitorChartFillAlphas:.5,weekdayChartColor:"#54c2ea",weekdayBalloonColor:"#54c2ea",weekdayBalloonBorderColor:"#54c2ea",weekdayBalloonFillColor:"#54c2ea",weekdayBalloonFontSize:15,weekdayGraphFillColor:"#54c2ea",weekdayGraphColorField:!1,weekdayGraphFillAlphas:.5,weekdayGraphLineColor:"#54c2ea",weekdayGraphLineColorField:!1,chatChartColor:"#54c2ea",chatBalloonFontSize:15,chatGraphFillAlphas:.5,statisticsChartColor:"#54c2ea",ratingChartColors:["#54c2ea","#235A78","#439494","#4DAAAB","#B4DCED","#1A8BB2"],ratingChartBackground:"#54c2ea",ratingBalloonBorderColor:"#54c2ea",ratingBalloonFontSize:15,historyBalloonFontSize:15},locale={unavailable:"Unavailable",pendingchat:"Pending Chat",pendingchatdescription:"{name} is pending to chat"},tour=!1,router=!1,showOfflineOperators=!1,storage=!1,chatSections={},startupDate=!1,saveExpanded=!0,previousMenuEnabled=!0,billing=!0,chatsLoaded=!1,scrollAlertEnabled=!1;$.preloadImages=function(){for(var a=0;a<arguments.length;a++)$("<img>").attr("src",arguments[a])};var visitorsTimeout=!1,projection,locations,debounceMap=function(a,b){var c=-1;return function(){c>-1&&window.clearTimeout(c),c=window.setTimeout(a,b)}},debouncedWorldMap=debounceMap(function(){drawWorldMap(),updateLocations()},125);$(window).resize(debouncedWorldMap);var visitorOpen=-1,chatResponsesOpen=!1,activechats=[],blockedchats=[],settingsMenuClickedCallback=function(a){var b=$(".settings.dropdown .save.button");"htmlcode"===a?b.fadeOut():b.fadeIn()},closeAddResponseCallback=function(a){a.find(".search, #response-list, .button-toolbar.add").fadeIn(250,function(){$("#response-list .response, #responses .button-toolbar.add").show()})},initialiseRoute=function(){var a=window.location.hash.slice(2);a.length>0?storage.set("route",a):storage.set("route","")},debouncedSaveScroll=_.debounce(saveScroll,300);$(document).ready(function(){function a(){$(".responses .empty").hide(),q.find(".back, .back-background, #add-response").fadeIn(),q.find(".header").text("Add Response"),q.find(".search, #response-list, .button-toolbar.add").hide(),q.find(".button-toolbar.save").fadeIn().animate({bottom:"15px"},250,"easeInOutBack")}function b(){q.find("#ResponseID, #ResponseName, #ResponseCategory, #ResponseURL, #ResponseContent, #ResponseTags").val(""),q.find("#ResponseTypeText").attr("checked","checked"),q.find(".add-response.tags").html(""),q.find(".URL, .InputError").hide(),q.find(".Content").show()}function c(a){q.find("#ResponseTypeHyperlink, #ResponseTypePUSH, #ResponseTypeImage").is(":checked")&&(/^(?:\b(https?|file):\/\/[\-A-Z0-9+&@#\/%?=~_|$!:,.;]*[A-Z0-9+&@#\/%=~_|$])$/i.test(a)?q.find("#ResponseURLError").removeClass("CrossSmall").addClass("TickSmall").fadeIn(250):q.find("#ResponseURLError").removeClass("TickSmall").addClass("CrossSmall").fadeIn(250))}function d(){function a(a){void 0!==a&&void 0!==a.Responses&&updateResponses(a.Responses),b(),g(),$("#responses .confirm-delete.dialog").show().animate({bottom:-90},250,"easeInOutBack")}var c=q.find("#ResponseID");if(0===q.find(".CrossSmall").length){var d={ID:c.val()};apiRequest({url:apiEndpoint.responses,data:d,success:function(b){a(b)}})}}function e(){function a(a){void 0!==a&&void 0!==a.Responses&&updateResponses(a.Responses),b(),g()}var d=q.find("#ResponseID"),e=q.find("#ResponseName"),f=q.find("#ResponseCategory"),h=q.find(".checkbox input:checked").data("type"),i=q.find("#ResponseURL"),j=q.find("#ResponseContent"),k=q.find("#ResponseTags");if(validateField(e,"#ResponseNameError"),"Text"===h||"JavaScript"===h?(validateField(j,"#ResponseContentError"),j=j.val()):(c(i.val()),j=i.val()),0===q.find(".CrossSmall").length){switch(h){case"Text":h=1;break;case"Hyperlink":h=2;break;case"Image":h=3;break;case"PUSH":h=4;break;case"JavaScript":h=5}var k=[],l="";$.each(q.find(".add-response .tag"),function(a,b){l=$(b).text(),l.length>0&&-1===$.inArray(b,k)&&k.push(l.toLowerCase())}),k=k.join(";");var m={ID:d.val(),Name:e.val(),Category:f.val(),Content:j,Type:h,Tags:k};apiRequest({url:apiEndpoint.responses,data:m,success:function(b){a(b)}})}}function f(a){void 0!==a&&a.length>0&&$.each(a,function(a,b){q.find(".add-response.tags").append('<span class="tag"><span class="tag-icon"></span>'+b.trim()+'<span class="delete" title="Delete"></span></span>')})}function g(){q=$("#responses"),q.find("#add-response").fadeOut(),q.find(".header").text("Pre-typed Response"),q.find(".back, .back-background").fadeOut();var a=q.find(".button-toolbar.save"),b=a.height();a.hide().css("bottom",-b+"px"),closeAddResponseCallback(q),q.find("#responses .scroll #response-list .response").length||$(".responses .empty").show()}function h(){var a=$(this),b=a.data("message"),c=$(".responses-menu[data-message="+b+"]"),d=300,e=1,f=a.find(".text").text();if(0===c.length&&(c=a.parent()),c.height()>0)d=0,e=0;else{var g=0;c.find(".responses-text, .responses-hyperlink, .responses-image, .responses-push, .responses-javascript").html("").hide(),c.find(".responses.heading").hide(),$.each(responses,function(a,b){"Text"===a?(g=0,$.each(b,function(a,b){$.each(b.Tags,function(a,d){if(d=d.toLowerCase(),d===f.toLowerCase()){var e='<div class="response" data-content="'+b.Content+'">'+b.Name+"</div>";c.find(".tag-text").text(d),$(e).appendTo(c.find(".responses-text")),g++}})}),g>0&&c.find(".responses.text.heading, .responses-text").show()):"Hyperlink"===a?(g=0,$.each(b,function(a,b){$.each(b.Tags,function(a,d){if(d=d.toLowerCase(),d===f.toLowerCase()){var e='<div class="response" data-content="'+b.Content+'">'+b.Name+"</div>";c.find(".tag-text").text(d),$(e).appendTo(c.find(".responses-hyperlink")),g++}})}),g>0&&c.find(".responses.hyperlink.heading, .responses-hyperlink").show()):"Image"===a?(g=0,$.each(b,function(a,b){$.each(b.Tags,function(a,d){if(d=d.toLowerCase(),d===f.toLowerCase()){var e='<div class="response">'+b.Content+"</div>";c.find(".tag-text").text(d),$(e).appendTo(c.find(".responses-image")),g++}})}),g>0&&c.find(".responses.image.heading, .responses-image").show()):"PUSH"===a?(g=0,$.each(b,function(a,b){$.each(b.Tags,function(a,d){if(d=d.toLowerCase(),d===f.toLowerCase()){var e='<div class="response">'+b.Content+"</div>";c.find(".tag-text").text(d),$(e).appendTo(c.find(".responses-push")),g++}})}),g>0&&c.find(".responses.push.heading, .responses-push").show()):"JavaScript"===a&&(g=0,$.each(b,function(a,b){$.each(b.Tags,function(a,d){if(d=d.toLowerCase(),d===f.toLowerCase()){var e='<div class="response">'+b.Content+"</div>";c.find(".tag-text").text(d),$(e).appendTo(c.find(".responses-javascript")),g++}})}),g>0&&c.find(".responses.javascript.heading, .responses-javascript").show())}),d="100%"}c.animate({height:d,opacity:e},100,"easeOutBack",function(){$(this).toggle()})}function i(){$(".login .reset.form, .btn-toolbar.reset, .login .error").hide(),$(".login .signin.form, .btn-toolbar.signin").show(),$(".login .signin.form #username").focus()}chatSections={chatting:{element:$(".chatting.list"),height:74},other:{element:$(".other-chatting.list"),height:74},pending:{element:$(".pending.list"),height:74},operators:{element:$(".operators.list"),height:74},none:{height:0,enabled:!1}};var j={"/home":function(){switchMenu("home")},"/accounts":function(){switchMenu("accounts")},"/settings":function(){openSettings()},"/settings/:menu":function(a){openSettings(a)},"/tour":function(){tour!==!1&&(tour.setCurrentStep(0),tour.start(!0))}};router=Router(j),storage=new Storage,initialiseRoute(),$(document).bind("LiveHelp.WebSocketStateChanged",function(a,b){websockets=b,websockets!==!1&&(window.clearTimeout(usersTimer),window.clearTimeout(visitorsTimer))});var k=$(".chat-list .list");$.each(k,function(a,b){var c=$(b);if(0===c.find(".visitor").length)chatSections.none.enabled?c.data("height",chatSections.none.height):(c.find("no-visitor").hide(),c.data("height",0));else{var d=sectionHeight(c);c.data("height",d)}}),$(".chat-list").on({mouseenter:function(){$(this).find(".image, .close, .dropdown-toggle.options").addClass("hover")},mouseleave:function(){$(this).find(".image, .close, .dropdown-toggle.options").removeClass("hover")}},".visitor"),$(".chat-list").on({mouseenter:function(){$(".chat-list").find(".visitor.selected, .channel.selected").addClass("previous"),$(".chat-list").find(".visitor, .channel").removeClass("selected")},mouseleave:function(){$(".chat-list .previous").removeClass("previous").addClass("selected")}},".visitor, .channel"),$(".history.container .search #search").keyup(function(a){27==a.which&&$(this).val(""),historySearch=$(this).val(),updateHistoryFilter()}),$(".history.container .search.button").click(function(){historySearch=$(".history.container .search #search").val(),updateHistoryFilter()}),$(".VisitorsTotal, #visitortotal").click(function(){switchMenu("home")}),$("#responses .close").click(function(){closeResponses()}),$("#account-details .back").click(function(){$("#account-details.edit").length&&closeAccountDetails(),showAccounts()}),$(".sidebar-icons .menu").click(function(a){var b=$(this).data("type");switchMenu(b),a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation()}),$(".visitors-list.button").click(function(){$(this).addClass("selected"),$(".visitors-map.button").removeClass("selected"),$(".worldmap").hide(),visitors.length>0?$(".visitors-grid").fadeIn():($(".visitors-empty").fadeIn(),updateTotal($("#visitortotal"),0))}),$(".visitors-map.button").click(function(){$(this).addClass("selected"),$(".visitors-list.button").removeClass("selected"),$(".visitors-empty, .visitors-grid").hide();var a=$(".worldmap");$(".worldmap svg").attr("width",a.width()).attr("height",a.height()),$(".worldmap").fadeIn()}),$("#visitor-details .btn.initiate").click(function(){sendInitiateChat()}),$(".notification .close").click(function(){return closeNotification(),!1}),$(".settings.dropdown .close, .settings.dropdown .cancel").click(function(){return closeSettings(),!1});var l=$(".settings.dropdown .checkbox.toggle");l.each(function(a,b){var c=$(b),d=c.attr("class").replace(/checkbox|toggle/g,"").trim(),e=c.is(".disabled")?' disabled="disabled"':"";toggle=$('<label class="switch"><input type="checkbox" class="checkbox '+d+' ios-switch"'+e+"/><div><div></div></div></label>").appendTo(c),checkbox=toggle.find(".checkbox"),checkbox.on("change",function(){var a=c.find(".radios .enable"),b=c.find(".radios .disable");$(this).is(":checked")?a.prop("checked",!0).change():b.prop("checked",!0).change()})}),$(document).on("LiveHelp.SettingsLoaded",function(a,b){l.each(function(a,b){var c=$(b),d=c.find(".switch .checkbox");c.find(".radios .enable").is(":checked")?d.prop("checked",!0).change():d.prop("checked",!1).change()})}),$(".settings.dropdown .save").on("click",function(a){saveSettings(),a.stopPropagation()}),$(".settingsmenu div").click(function(){var a=$(this).attr("id"),b="settings/"+a;storage.set("route",b),router.setRoute(b),$(document).trigger("LiveHelp.RouteChanged")}),$(".dropdown-toggle").dropdown(),$("#calendar").ical(),$("#calendar").on("click","td",function(){var a=$(this).attr("id"),b=$(this);void 0!==a&&a.length>0&&/^\d{4}-\d{2}-\d{2}$/i.test(a)&&(storage.set("history-date",a),b.closest("table").find("td").removeClass("selected-date"),b.addClass("selected-date"),initHistoryGrid(a))});var m=$("#history-chat");m.find(".btn.unblock").click(function(){var a=m.data("id"),b=m.find(".dialog");unblockChat(a,b)});var n=$(".chat-stack");n.find(".dialog .btn.unblock").click(function(){var a,b=n.find(".chat"),c=n.find(".dialog");$.each(b,function(b,c){return 0===$(c).position().left?void(a=$(c)):void 0}),void 0!==a&&a.length>0&&(a=a.data("id"),unblockChat(a,c))}),n.on("click",".chat",function(){var a=$(this),b=(a.data("id"),{top:parseInt(a.css("top"),10),left:parseInt(a.css("left"),10),bottom:parseInt(a.css("bottom"),10)}),c=a.is(".focussed"),d=a.find(".scroll"),e=a.find(".message-alert").data("total");c||($(".chat-stack .chat").each(function(a,b){var c=$(b),d=parseInt(c.position().left,10);0===d&&$(c).data("scroll",c.find(".scroll").scrollTop())}),a.animate({"z-index":80,left:0,bottom:0,top:0,backgroundColor:"#fffff"},150,"easeInOutBack",function(){a.find(".inputs, input").fadeIn(),a.find(".inputs input").focus();var b=a.data("scroll");e>0&&(b=a.find(".scroll .end"));var c=a.data("id");checkBlocked(c),void 0!==b&&a.find(".scroll").scrollTo(b)}),$(".chat-stack .smilies.button").close(),a.find(".name").hide(),resetMessageAlert(a),$(".chat-stack .chat").each(function(a,c){var d=$(c),e=parseInt(d.css("left"),10),f=parseInt(d.css("z-index"),10),g=0,h=2,i="#fafafa";e<b.left&&(e>0&&(g=0,h=4,i="#f6f6f6"),d.animate({"z-index":f-10,top:g,left:e+35,bottom:h,backgroundColor:i},150,"easeInOutBack"),d.find(".inputs, input").fadeOut(),d.find(".name").fadeIn())}),d.scrollTo(d.find(".end")))}),n.on("click",".chat .scrollalert a, .chat .scrollalert .scrollmessage, .chat .scrollalert .arrow",function(){var a=$(".chat-stack .chat.focussed"),b=a.data("id"),c=$('.chat-list .visitor[data-id="'+b+'"]'),d=$(".chat.focussed").data("operator"),e=c.find(".message-alert"),f=e.data("total");if(f>0){var g=a.find(".messages .flex.left:nth-last-child("+f+")"),h=a.find(".messages .flex.typing:visible");h.length>0&&(g=h),a.find(".scroll").scrollTo(g)}else scrollToBottom(b,d,!0);resetMessageAlert(c),$('.chat-stack .chat[data-id="'+b+'"] .scrollalert').hide()}),$("#visitor-details .close").click(function(){closeVisitor()});var o="body, input, textarea";$(o).bind("keydown","esc",function(){shortcuts&&processEscKeyDown()}),$(o).bind("keydown","ctrl+shift+s",function(){shortcuts&&openSettings()}),$(o).bind("keydown","ctrl+shift+a",function(){shortcuts&&openAccounts()}),$(o).bind("keydown","ctrl+shift+r",function(){shortcuts&&openResponses()}),$("#account-details .close").click(function(){$("#account-details.edit").length&&closeAccountDetails(),closeAccount()}),$("#response-list").on({mouseenter:function(){var a=$(this).find(".edit");activechats.length>0&&(a=$(this).find(".edit")),a.animate({opacity:.3},250)},mouseleave:function(){var a=$(this).find(".edit");activechats.length>0&&(a=$(this).find(".edit")),a.animate({opacity:0},250)}},".response"),$("#response-list").on({mouseenter:function(){if(activechats.length>0){var a=$(this);a.animate({opacity:.6},250)}},mouseleave:function(){if(activechats.length>0){var a=$(this);a.animate({opacity:.3},250)}}},".response .edit"),$("#response-list").on("click",".response .edit",function(){var b=$(this).closest(".response"),c=b.data("id"),d=($("#responses #add-response"),["Text","Hyperlink","Image","PUSH","JavaScript"]);b=[],$.each(responses,function(a,e){$.inArray(a,d)>-1&&$.each(e,function(a,d){return parseInt(d.ID,10)===c?(b=d,!1):void 0})}),$("#ResponseID").val(b.ID),$("#ResponseName").val(b.Name),$("#ResponseCategory").val(b.Category);var e="Text";switch(b.Type){case 2:e="Hyperlink";break;case 3:e="Image";break;case 4:e="PUSH";break;case 5:e="JavaScript"}$("#ResponseType"+e).attr("checked","checked"),"Text"===e?($("#ResponseContent").val(b.Content),$("#add-response .URL").hide(),$("#add-response .Content").show()):($("#ResponseURL").val(b.Content),$("#add-response .Content").hide(),$("#add-response .URL").val(b.Content).show()),$(".add-response.tags").html(""),f(b.Tags),a()}),$(".chat-stack .smilies.button").on({mouseenter:function(){$(this).removeClass("Smilies").addClass("SmiliesHover")},mouseleave:function(){$(this).removeClass("SmiliesHover").addClass("Smilies")},click:function(){$(this).bubbletip($("#SmiliesTooltip"),{calculateOnShow:!0}).open()}}),$(".chat-stack").on("focus","#message",function(){$(".chat-stack .smilies.button").close()}),$("#SmiliesTooltip span").click(function(){var a=$(this).attr("class").replace(/sprite | Small/g,""),b="",c=$(".chat-stack textarea"),d=c.val();switch(a){case"Laugh":b=":D";break;case"Smile":b=":)";break;case"Sad":b=":(";break;case"Money":b="$)";break;case"Impish":b=":P";break;case"Sweat":b=":\\";break;case"Cool":b="8)";break;case"Frown":b=">:L";break;case"Wink":b=";)";break;case"Surprise":b=":O";break;case"Woo":b="8-)";break;case"Tired":b="X-(";break;case"Shock":b="8-O";break;case"Hysterical":b="xD";break;case"Kissed":b=":-*";break;case"Dizzy":b=":S";break;case"Celebrate":b="+O)";break;case"Angry":b=">:O";break;case"Adore":b="<3";break;case"Sleep":b="zzZ";break;case"Stop":b=":X"}c.val(d+b).keyup()});var p=$(".chat-stack .confirm-close.dialog");p.find(".cancel-button").on("click",function(){p.show().animate({bottom:-90},250,"easeInOutBack",function(){p.hide()})}),p.find(".accept-button").on("click",function(){var a=$(".chat-list .visitor.selected").data("id"),b=$(".chat-stack .chat[data-id="+a+"]");if(null!==b){if(p.find(".buttons").hide(),p.find(".progressring").css("opacity",1).show(),0>a){var c=$(".chatting.list"),d=c.find(".visitor[data-id=-1]"),e=c.find(".visitor").length;return e>1?removeUser(c,d):clearUsers(c),void closeChatCompletedCallback()}updateUsers("Close",a,function(){var b=$(".chat-stack .chat");closeChatCompletedCallback(a,b),b=[],$.each(activechats,function(c,d){return d.id!==a?void b.push(d):void 0}),activechats=b,$(document).trigger("LiveHelp.CloseChatCompleted")})}}),$(".operator .name, .operator .photo").on("click",function(a){$(".operator .dropdown-toggle").click(),a.stopPropagation()}),loadResponses();var q=$("#responses");q.find("input").on("keydown","#search","return",filterResponses),q.click(filterResponses),q.find(".add-small.button, .button-toolbar .add-button").click(function(){b(),a()}),q.find(".cancel.button").click(function(){b(),g()});var r=q.find(".confirm-delete.dialog");q.find(".delete-button").click(function(){r.find(".progressring img").css({opacity:0}),r.find(".buttons").show(),r.find(".title").text("Confirm Response Delete"),r.find(".description").text("Are you sure that you wish to delete this response?"),r.show().animate({bottom:0},250,"easeInOutBack")}),r.find(".delete").click(function(){r.find(".buttons").fadeOut(),r.find(".progressring img").css({opacity:.5}),d()}),r.find(".cancel").click(function(){r.animate({bottom:"-90px"},250,"easeInOutBack")}),q.find("#ResponseName").on("keydown keyup change blur",function(){var a=$(this).attr("id");validateField($(this),"#"+a+"Error")}),q.find("#ResponseTypeText, #ResponseTypeJavaScript").on("click",function(){$(this).is(":checked")&&(q.find(".URL").hide(),q.find(".Content").show())}),q.find("#ResponseTypeHyperlink, #ResponseTypeImage, #ResponseTypePUSH").on("click",function(){$(this).is(":checked")&&(q.find(".Content").hide(),q.find(".URL").show())}),q.find("#ResponseContent, #ResponseURL").on("keydown keyup change blur",function(){var a=q.find(".checkbox input:checked").data("type"),b=q.find("#ResponseURL"),d=q.find("#ResponseContent");"Text"===a||"JavaScript"===a?validateField(d,"#ResponseContentError"):c(b.val())}),q.find(".save.button").click(function(){e()}),q.find(".add-tag").click(function(){var a=q.find("#ResponseTags"),b=a.val().split(" ");f(b),a.val("")}),$("#responses").on({mouseenter:function(){$(this).find(".delete").css({opacity:.3})},mouseleave:function(){$(this).find(".delete").css({opacity:.1})}},".add-response.tags .tag"),$("#responses").on("click",".tag .delete",function(){$(this).closest(".add-response.tags .tag").remove()}),q.find(".back").click(function(){g()}),$(".chat-stack").on("click",".search.button",function(){chatResponsesOpen=!0,openResponses(function(){$("#responses #search").focus()})}),$(document).bind("LiveHelp.AccountsUpdated",function(a,b){var c=$(".operators.list .visitor");$.each(c,function(a,c){var d=$(c),e=d.data("id");$.each(b,function(a,b){if(parseInt(b.ID,10)==e){d.find(".name").text(b.Firstname),d.find(".department").text(b.Department);var c=convertAccessLevel(b.Privilege);d.find(".accesslevel").text(c)}})})}),$(".chat-stack .send").on({click:function(){sendMessage();var a=$(".responses-menu");return"none"!=a.css("display")&&a.height(0).hide(),!1},mouseenter:function(){$(this).css({opacity:1}).removeClass("sprite SendButton").addClass("sprite SendButtonHover")},mouseleave:function(){$(this).css({opacity:.4}).removeClass("sprite SendButtonHover").addClass("sprite SendButton")}});var s=$(".chat-stack textarea");s.bind("keydown","return",function(){return sendMessage(),!1}).bind("keyup","return",function(){updateTypingStatus(!1)}).bind("focusout",function(){updateTypingStatus(!1)}).bind("keydown","ctrl+return",function(){var a=$(this),b=a.val(),c=a.caret().start,d=a.caret().end;return a.val(b.substr(0,c)+"\n"+b.substr(d)).caret(c+1,c+1),!1}).bind("keydown",function(){updateTypingStatus(!0)}),$(".chat-stack").on("click",".responses-menu .response",function(){$(".chat-stack textarea").val($(this).data("content"))}),$(document).on("click",".messages .tag, .responses-menu > .close",h),$(".chat-list-heading").on("click",function(){var a=$(this).next(),b=a.height(),c=!1;0===b?(b=a.data("height"),c=!0):(a.data("height",b),b=0),$(this).attr("aria-expanded",c),toggleChatMenu(a,b,!0)}),$(".chat-list-heading").on({mouseenter:function(){$(this).find(".expander").css("opacity",1)},mouseleave:function(){$(this).find(".expander").css("opacity",0)}}),$(".reset.password").on("click",function(){$(".login .signin.form, .btn-toolbar.signin, .login .error").hide(),$(".login .reset.form, .btn-toolbar.reset").show(),$(".login .reset.form #username").focus()});var t=$(".twofactor.form");t.find("a.disable.twofactor").on("click",function(){t.find("div.twofactor.signin").hide(),t.find("div.twofactor.disable").show()});var u=$(".btn-toolbar.reset");u.find(".btn.back").on("click",function(){i()}),u.find(".btn.reset").on("click",function(){var a=$(".reset.form"),b=a.find("#username").val(),c=a.find("#email").val(),d={Username:b,Email:c};apiRequest({url:apiEndpoint.resetpassword,data:d,success:function(a){i()},error:function(a,b,c){var d=$(".login, .inputs");$(".login .signin.form .error .text").text("Incorrect Username or Email"),d.find(".error").fadeIn(),d.effect("shake",{times:3,distance:10},150)}})}),$(document).on("LiveHelp.LocalSettingsLoaded",function(a){
!function(){"undefined"==typeof migrateLocalStorage&&void 0!==localStorage&&void 0!==localStorage.jStorage&&localStorage.removeItem("jStorage"),storage.isSet("session")||storage.set("session",""),storage.isSet("server")||storage.set("server",""),storage.isSet("protocol")||storage.set("protocol","http://"),storage.isSet("locale")||storage.set("locale",{}),storage.isSet("html5-notifications")||storage.set("html5-notifications",!1),storage.isSet("accounts")||storage.set("accounts",[]),storage.isSet("account")||storage.set("account",null),storage.isSet("route")||storage.set("route","home"),storage.isSet("history-date")||storage.set("history-date",""),storage.isSet("viewed")||storage.set("viewed",viewed),storage.isSet("startupDate")||storage.set("startupDate",(new Date).getTime()),startupDate=storage.get("startupDate");var a={width:900,height:650};storage.isSet("size")?a=storage.get("size"):storage.set("size",a),storage.isSet("position")||storage.set("position",{top:(window.screen.height-a.height)/2,left:(window.screen.width-a.width)/2}),storage.isSet("visitorsColumns")||storage.set("visitorsColumns",visitorsColumns),storage.isSet("historyColumns")||storage.set("historyColumns",[{id:"history",name:"Chat History",field:"Username",headerCssClass:"username-column-header",width:550,formatter:renderHistoryCell,sortable:!0,resizable:!0},{id:"date",name:"Date",field:"Date",width:150,formatter:Slick.Formatters.Date,sortable:!0,resizable:!0}]);var b=storage.get("locale");$.isEmptyObject(b)||(locale=b,$(document).trigger("LiveHelp.LocaleUpdated"))}(),operator=storage.get("operator"),$(".operators.list").on("click",".visitor .status",function(){var a='<ul class="dropdown-menu statusmode"> 		<li><a href="#" class="Online" data-lang-key="online">Online</a></li> 		<li><a href="#" class="Offline" data-lang-key="offline">Offline</a></li> 		<li><a href="#" class="BRB" data-lang-key="brb">Be Right Back</a></li> 		<li><a href="#" class="Away" data-lang-key="away">Away</a></li>',b=$(this),c=b.closest(".visitor");account=b.is(".parent")?b:c.find(".status.parent"),id=c.data("id"),id===operator.id&&(a+='	<li class="divider"></li> 		<li><a href="#" class="Signout" data-lang-key="signout">Sign Out</a></li>'),a+="</ul>",c.find(".dropdown-menu").length||$(a).insertAfter(account),account.dropdown()}),$(".operators.list").on("click",".dropdown-menu.statusmode li a",function(){var a=$(this),b=a.attr("class"),c=a.closest(".visitor"),d=c.data("id");d===operator.id&&(d=void 0),"Signout"!==b?changeStatus(b,$(this).text(),d):signOut(),c.find(".status.parent").dropdown()}),initAdmin()})});var showLogin=function(){$(".loading").fadeOut(250,function(){$(".loading").hide()}),$(".login").show().fadeIn()},chattingVisitorClickCallback=function(a,b,c,d){var e=this instanceof jQuery?this:$(this),f=e.data("id"),g=e.data("user"),h=void 0!==e.data("operator")?e.data("operator"):!1;(void 0!==g.Status&&h.id!==parseInt(g.ID,10)||void 0===g.Status)&&openChat(f,g,b,h,c,d)},acceptChatStyles={background:"#e2e2e2"},visitorChart,visitorChartData=[],visitorChartCursor,visitorChartEmpty=!1,weekdayChart,weekdayChartData=[],weekdayChartCursor,weekdayChartEmpty=!1,chatChart,chatChartData=[],chatChartCursor,chatChartEmpty=!1,ratingChart,ratingChartData=[],ratingChartCursor,ratingChartEmpty=!1,historyChart,historyChartData=[],historyChartCursor,updateLanguage=function(a){$.ajax({url:address+"locale/"+a+"/admin.json",type:"GET",success:function(a){void 0!==a&&processLanguage(a)},error:function(a,b,c){},dataType:"json"})},saveSettingsCallback=function(){var a=$(".settings.dialog");a.find(".progressring").show(),a.find(".title").text("Saving Settings"),a.find(".description").text("One moment while your settings are saved."),a.show().animate({bottom:0},250,"easeInOutBack")},saveSettingsCompletedCallback=function(){window.setTimeout(function(){var a=$(".settings.dialog");a.find(".progressring").hide(),a.find(".title").text("Settings Saved Successfully"),a.find(".description").text("Your settings were saved successfully."),a.delay(1e3).show().animate({bottom:-90},250,"easeInOutBack")},500)},saveSettingsErrorCallback=function(){var a=$(".settings.dialog");a.find(".progressring").hide(),a.find(".title").text("Error Saving Settings"),a.find(".description").text("An error occurred while saving the settings.  Please contact technical support."),a.delay(3e3).show().animate({bottom:-90},250,"easeInOutBack")},overrideSettingsCallback=function(a){return a},historyGrid=!1,historyColumns,historyDataView,historyOptions={rowHeight:220,enableCellNavigation:!0,enableColumnReorder:!1,multiColumnSort:!0,multiSelect:!1},openResponsesCallback=function(a,b){loadResponses(),a.css("z-index",sliderIndex()+100),a.css({width:"calc(100% - 300px)",opacity:1}),b&&b()},accountsLoaded=!1,accountsGrid,accountsDataView,accounts,accountsColumns=[{id:"account",name:"",field:"Username",formatter:renderAccountCell,sortable:!0}],accountsOptions={rowHeight:80,enableCellNavigation:!0,enableColumnReorder:!1,forceFitColumns:!0,multiColumnSort:!0,multiSelect:!1},accountTemplate=null,accountSavingCallback=function(){var a=$(".account.dialog");a.css("height","90px"),a.find(".progressring").show(),a.find(".title").text("Saving Account"),a.find(".description").text("One moment while your account is saved."),a.show().animate({bottom:0},250,"easeInOutBack")},accountSaveErrorCallback=function(a){var b=$(".account.dialog"),c="Error Saving Account",d="An error occurred while saving your account.  Please contact technical support.";a!==!1&&(c=a.title,d=a.description),b.css("height","120px"),b.find(".progressring").hide(),b.find(".title").text(c),b.find(".description").text(d),b.delay(2e3).animate({bottom:-b.height()},250,"easeInOutBack")},unsavedImages=[],accountFiles,accountAddingCallback=function(){var a=$(".account.dialog");a.css("height","90px"),a.find(".progressring").show(),a.find(".title").text("Adding Account"),a.find(".description").text("One moment while you account is created."),a.show().animate({bottom:0},250,"easeInOutBack")},accountAddErrorCallback=function(){var a=$(".account.dialog");a.css("height","120px"),a.find(".progressring").hide(),a.find(".title").text("Error Adding Account"),a.find(".description").text("An error occurred while adding your account.  Please contact technical support.")},accountDeletedCallback=function(a){accountDeleted(a),$(document).trigger("LiveHelp.AccountDeleted")},accountDeletedErrorCallback=function(a,b,c){var d=$("#account-details .confirm-delete.dialog");d.find(".progressring").hide(),d.find(".title").text("Error Deleting Account"),d.find(".description").text("An error occurred while deleting your account.  Please contact technical support."),d.delay(2e3).hide().animate({bottom:-90},250,"easeInOutBack")},deleteAccountClickedCallback=function(){var a=$("#account-details .confirm-delete.dialog");a.find(".progressring").hide(),a.find(".buttons").show(),a.find(".title").text("Confirm Account Delete"),a.find(".description").text("Are you sure that you wish to delete this account?"),a.show().animate({bottom:0},250,"easeInOutBack")},deleteAccountConfirmClickedCallback=function(){var a=$("#account-details .confirm-delete.dialog");a.find(".buttons").fadeOut(),a.find(".progressring").show(),a.find(".progressring img").css({opacity:.5}),deleteAccount()},accountsScrollTop=0,openAccountsCallback=function(){},closeAccountCallback=function(a){a.animate({width:0,opacity:0},250,function(){a.hide()})};!function(){var a=function(){var b=$(".pending.list .visitor, .transferred.list .visitor");$.each(b,function(a,b){b=$(b);var c=moment(b.attr("data-datetime")),d=moment().diff(c,"seconds")%60,e=moment().diff(c,"minutes"),f=e>0?e+"m":d+"s";isNaN(e)||isNaN(d)||b.find(".time").text(f)}),window.setTimeout(a,1e3)};a()}();var notifications=[],users={},usersTimer,updateUsersSuccess=function(a,b,c,d){updateUsersInterface(a.Users,b,c),$(document).trigger("LiveHelp.UpdateUsersCompleted"),d&&d()},acceptOpenChatCallback=function(a,b){openChat(a,b)};intercom!==!1&&intercom.on("message-alert",function(a){if(a.id>0&&void 0!==a.count)if(0===a.count){var b=$(".chat-list .visitor[data-id="+a.id+"][data-operator="+a.operator+"]");resetMessageAlert(b,!1)}else{var c=_.find(viewed,function(b){return b.id===a.id&&b.operator==a.operator});void 0!==c&&(c.count=a.count,updateMessageAlert(a.id,a.operator,a.count-c.count,a.viewed))}}),$.fn.chatScrollHandler=function(){$(this).on("scroll",_.debounce(function(){var a=$(this).closest(".chat"),b=a.find(".scrollalert"),c=$('.chat-list .visitor[data-id="'+a.data("id")+'"][data-operator='+a.data("operator")+"]");if(b.is(":visible")){var d=a.find(".scroll"),e=d[0].scrollTop+d.height(),f=a.find(".messages .message:not(.typing):last:parent"),g=d[0].scrollTop+f.position().top;e>g&&(a.is(".focussed")&&resetMessageAlert(c),b.hide())}else a.is(".focussed")&&resetMessageAlert(c)},250))},$.fn.getCursorPosition=function(){var a=$(this).get(0),b=0;if("selectionStart"in a)b=a.selectionStart;else if("selection"in document){a.focus();var c=document.selection.createRange(),d=document.selection.createRange().text.length;c.moveStart("character",-a.value.length),b=c.text.length-d}return b},$.fn.selectRange=function(a,b){return b||(b=a),this.each(function(){if(this.setSelectionRange)this.focus(),this.setSelectionRange(a,b);else if(this.createTextRange){var c=this.createTextRange();c.collapse(!0),c.moveEnd("character",b),c.moveStart("character",a),c.select()}})};var selectedChat=!1,chatMessages=[],channelMessages=[],notificationUsers=[],responses={},tags=[],openHistoryCallback=function(a){},openIntegrations=function(){return openSettings("integrations"),"settings/integrations"},previousMenu="home",session="",factor="",error=!1,closeChatClosingCallback=function(){var a=$(".chat-stack .confirm-close.dialog");a.find(".progressring").css("opacity",0).hide(),a.find(".buttons").show(),a.show().animate({bottom:0},250,"easeInOutBack")},closeChatCompletedCallback=function(a,b){var c=$(".chat-stack .confirm-close.dialog");c.animate({bottom:"-90px"},250,function(){$(this).hide()});var d="[data-id="+a+"][data-operator=false]";b.length>1?b.filter(d).remove():(b.remove(),closeChats()),$(".chat-list .visitor"+d).remove(),$(".chat-stack").hide(),toggleEmptyChats()},operatorImage=function(a,b,c,d,e){var f={size:c},g=address+"images/User.png",h=CryptoJS.MD5(b);return void 0!==a&&a!==!1&&(f.id=a),void 0!==d&&d!==!1&&(f.round=!0),void 0!==e&&e!==!1&&(f.override=!0),"https://secure.gravatar.com/avatar/"+h+"?s="+c+"&r=g&d="+g},signInErrorCallback=function(a,b,c){var d=$(".login, .inputs"),e=void 0!==c?c:$(".login .signin .signin.error .text");e.length>0&&e.text(b),e.parent().is(".backup.error")?d.find(".signin.error").hide():d.find(".backup.error").hide(),e.parent().fadeIn(),d.show().find(".inputs, .logo").effect("shake",{times:3,distance:10},150),e=!0},signInCallback=function(){return!0},signInTwoFactorCallback=function(){$(".login #username").val().length>0&&$(".login #password").val().length>0?($(".login .signin.form, .login .error, .loading").hide(),$(".login, .login .twofactor.form").show().find("#security").focus()):$(".login, .login .signin.form").show()},signOutCallback=function(){document.location.href=opts.location},messageSound,pendingSound;this.App=this.App||{},this.App.templates=this.App.templates||{},this.App.templates.message=Handlebars.template({1:function(a,b,c,d){var e,f=b.helperMissing,g="function",h=this.escapeExpression;return'<div class="flex image '+h((e=null!=(e=b.alignment||(null!=a?a.alignment:a))?e:f,typeof e===g?e.call(a,{name:"alignment",hash:{},data:d}):e))+'">\n  <div class="avatar '+h((e=null!=(e=b.css||(null!=a?a.css:a))?e:f,typeof e===g?e.call(a,{name:"css",hash:{},data:d}):e))+'" style="background-image: url(\''+h((e=null!=(e=b.image||(null!=a?a.image:a))?e:f,typeof e===g?e.call(a,{name:"image",hash:{},data:d}):e))+"'); background-size: 32px auto\"></div>\n"},3:function(a,b,c,d){var e;return'<div class="flex '+this.escapeExpression((e=null!=(e=b.alignment||(null!=a?a.alignment:a))?e:b.helperMissing,"function"==typeof e?e.call(a,{name:"alignment",hash:{},data:d}):e))+'">\n'},5:function(a,b,c,d){return" sending"},7:function(a,b,c,d){var e,f=b.helperMissing,g="function",h=this.escapeExpression;return'    <div class="content tweet" data-twitter="'+h((e=null!=(e=b.tweet||(null!=a?a.tweet:a))?e:f,typeof e===g?e.call(a,{name:"tweet",hash:{},data:d}):e))+'">'+h((e=null!=(e=b.content||(null!=a?a.content:a))?e:f,typeof e===g?e.call(a,{name:"content",hash:{},data:d}):e))+"</div>\n"},9:function(a,b,c,d){var e,f;return'    <div class="content">'+(null!=(f=null!=(f=b.content||(null!=a?a.content:a))?f:b.helperMissing,e="function"==typeof f?f.call(a,{name:"content",hash:{},data:d}):f)?e:"")+"</div>\n"},11:function(a,b,c,d){var e;return" "+this.escapeExpression((e=null!=(e=b.time||(null!=a?a.time:a))?e:b.helperMissing,"function"==typeof e?e.call(a,{name:"time",hash:{},data:d}):e))},compiler:[6,">= 2.0.0-beta.1"],main:function(a,b,c,d){var e,f,g=b.helperMissing,h="function",i=this.escapeExpression;return(null!=(e=b["if"].call(a,null!=a?a.image:a,{name:"if",hash:{},fn:this.program(1,d,0),inverse:this.program(3,d,0),data:d}))?e:"")+'  <blockquote class="message '+i((f=null!=(f=b.alignment||(null!=a?a.alignment:a))?f:g,typeof f===h?f.call(a,{name:"alignment",hash:{},data:d}):f))+(null!=(e=b["if"].call(a,null!=a?a.sending:a,{name:"if",hash:{},fn:this.program(5,d,0),inverse:this.noop,data:d}))?e:"")+'" data-id="'+i((f=null!=(f=b.id||(null!=a?a.id:a))?f:g,typeof f===h?f.call(a,{name:"id",hash:{},data:d}):f))+'" data-datetime="'+i((f=null!=(f=b.timestamp||(null!=a?a.timestamp:a))?f:g,typeof f===h?f.call(a,{name:"timestamp",hash:{},data:d}):f))+'">\n'+(null!=(e=b["if"].call(a,null!=a?a.tweet:a,{name:"if",hash:{},fn:this.program(7,d,0),inverse:this.program(9,d,0),data:d}))?e:"")+'    <div class="from">'+i((f=null!=(f=b.username||(null!=a?a.username:a))?f:g,typeof f===h?f.call(a,{name:"username",hash:{},data:d}):f))+(null!=(e=b["if"].call(a,null!=a?a.time:a,{name:"if",hash:{},fn:this.program(11,d,0),inverse:this.noop,data:d}))?e:"")+'</div>\n    <div class="seen">\n      <span class="status">Seen</span> <span class="time"></span>\n    </div>\n  </blockquote>\n</div>\n'+(null!=(f=null!=(f=b.tags||(null!=a?a.tags:a))?f:g,e=typeof f===h?f.call(a,{name:"tags",hash:{},data:d}):f)?e:"")+"\n"},useData:!0}),this.App=this.App||{},this.App.templates=this.App.templates||{},this.App.templates.user=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(a,b,c,d){var e,f=b.helperMissing,g="function",h=this.escapeExpression;return'<div class="visitor" data-id="'+h((e=null!=(e=b.id||(null!=a?a.id:a))?e:f,typeof e===g?e.call(a,{name:"id",hash:{},data:d}):e))+'" data-datetime="'+h((e=null!=(e=b.datetime||(null!=a?a.datetime:a))?e:f,typeof e===g?e.call(a,{name:"datetime",hash:{},data:d}):e))+'" data-hash="'+h((e=null!=(e=b.hash||(null!=a?a.hash:a))?e:f,typeof e===g?e.call(a,{name:"hash",hash:{},data:d}):e))+'" data-messages="0" data-operator="false">\n  <span class="image" style="background-image:url(\''+h((e=null!=(e=b.image||(null!=a?a.image:a))?e:f,typeof e===g?e.call(a,{name:"image",hash:{},data:d}):e))+'\')"></span>\n  <span class="details name">'+h((e=null!=(e=b.name||(null!=a?a.name:a))?e:f,typeof e===g?e.call(a,{name:"name",hash:{},data:d}):e))+'</span>\n  <span class="details department">'+h((e=null!=(e=b.department||(null!=a?a.department:a))?e:f,typeof e===g?e.call(a,{name:"department",hash:{},data:d}):e))+'</span>\n  <span class="details accesslevel">'+h((e=null!=(e=b.server||(null!=a?a.server:a))?e:f,typeof e===g?e.call(a,{name:"server",hash:{},data:d}):e))+'</span>\n  <span class="details time"></span>\n  <span class="close"></span>\n  <div class="dropdown-toggle options" data-toggle="dropdown" title="Options"></div>\n  <ul class="dropdown-menu options">\n    <li><a href="#" class="Close">Close Chat</a></li>\n    <li><a href="#" class="Block">Block Chat</a></li>\n    <li class="divider"></li>\n    <li><a href="#" class="EmailChatOffline">Email Chat</a></li>\n    <li><a href="#" class="EmailChatVisitor">Email Chat - '+h((e=null!=(e=b.email||(null!=a?a.email:a))?e:f,typeof e===g?e.call(a,{name:"email",hash:{},data:d}):e))+'</a></li>\n  </ul>\n  <span class="message-alert">0</span>\n</div>\n'},useData:!0}),this.App=this.App||{},this.App.templates=this.App.templates||{},this.App.templates.operator=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(a,b,c,d){var e,f=b.helperMissing,g="function",h=this.escapeExpression;return'<div class="visitor '+h((e=null!=(e=b.statusmode||(null!=a?a.statusmode:a))?e:f,typeof e===g?e.call(a,{name:"statusmode",hash:{},data:d}):e))+'" data-id="'+h((e=null!=(e=b.id||(null!=a?a.id:a))?e:f,typeof e===g?e.call(a,{name:"id",hash:{},data:d}):e))+'" data-status="'+h((e=null!=(e=b.statusmode||(null!=a?a.statusmode:a))?e:f,typeof e===g?e.call(a,{name:"statusmode",hash:{},data:d}):e))+'" data-name="'+h((e=null!=(e=b.firstname||(null!=a?a.firstname:a))?e:f,typeof e===g?e.call(a,{name:"firstname",hash:{},data:d}):e))+'" data-messages="0" data-operator="true">\n  <span class="status parent dropdown-toggle" data-toggle="dropdown">\n    <span class="status"></span>\n  </span>\n  <span class="image" style="background-image:url(\''+h((e=null!=(e=b.image||(null!=a?a.image:a))?e:f,typeof e===g?e.call(a,{name:"image",hash:{},data:d}):e))+'\'); background-size: 40px 40px"></span>\n  <span class="details name">'+h((e=null!=(e=b.name||(null!=a?a.name:a))?e:f,typeof e===g?e.call(a,{name:"name",hash:{},data:d}):e))+'</span>\n  <span class="details department">'+h((e=null!=(e=b.department||(null!=a?a.department:a))?e:f,typeof e===g?e.call(a,{name:"department",hash:{},data:d}):e))+'</span>\n  <span class="details accesslevel">'+h((e=null!=(e=b.access||(null!=a?a.access:a))?e:f,typeof e===g?e.call(a,{name:"access",hash:{},data:d}):e))+'</span>\n  <span class="message-alert red">0</span>\n</div>\n'},useData:!0}),this.App=this.App||{},this.App.templates=this.App.templates||{},this.App.templates.chat=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(a,b,c,d){var e,f=b.helperMissing,g="function",h=this.escapeExpression;return'<div data-id="'+h((e=null!=(e=b.id||(null!=a?a.id:a))?e:f,typeof e===g?e.call(a,{name:"id",hash:{},data:d}):e))+'" data-operator="'+h((e=null!=(e=b.operator||(null!=a?a.operator:a))?e:f,typeof e===g?e.call(a,{name:"operator",hash:{},data:d}):e))+'" class="'+h((e=null!=(e=b.styles||(null!=a?a.styles:a))?e:f,typeof e===g?e.call(a,{name:"styles",hash:{},data:d}):e))+'">\n  <div class="name"></div>\n  <div class="header">\n    <div class="title">\n      <span class="title"></span>\n    </div>\n  </div>\n  <div class="inputs">\n    <div class="scroll">\n      <div class="messages"></div>\n      <div class="end"></div>\n    </div>\n  </div>\n  <div class="scrollalert">\n    <div class="scrollmessage"></div>\n    <a href="#"></a>\n    <div class="arrow"></div>\n  </div>\n  <div class="status">\n    <span class="indicator"></span> <span class="name"></span> <span class="activity">is available</span> <a href="#" class="email"></a>\n  </div>\n  <div class="sidebar loading"></div>\n</div>\n'},useData:!0});